<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Huangzl&#39;s blog</title>
  
  <subtitle>Learning by sharing</subtitle>
  <link href="https://ikkkp.github.io/atom.xml" rel="self"/>
  
  <link href="https://ikkkp.github.io/"/>
  <updated>2023-11-04T02:42:22.646Z</updated>
  <id>https://ikkkp.github.io/</id>
  
  <author>
    <name>Huangzl</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>JIT (just-in-time) compiler æ˜¯æ€ä¹ˆå·¥ä½œçš„</title>
    <link href="https://ikkkp.github.io/2023/11/04/just-in-time-compilers/"/>
    <id>https://ikkkp.github.io/2023/11/04/just-in-time-compilers/</id>
    <published>2023-11-04T02:05:22.000Z</published>
    <updated>2023-11-04T02:42:22.646Z</updated>
    
    <content type="html"><![CDATA[<h2><span id="å¼•è¨€">å¼•è¨€</span></h2><p>åœ¨è°ˆåˆ°JITå‰ï¼Œè¿˜æ˜¯éœ€è¦å¯¹ç¼–è¯‘è¿‡ç¨‹æœ‰ä¸€äº›ç®€å•çš„äº†è§£ã€‚</p><p>åœ¨ç¼–è¯‘åŸç†ä¸­ï¼ŒæŠŠæºä»£ç ç¿»è¯‘æˆæœºå™¨æŒ‡ä»¤ï¼Œä¸€èˆ¬è¦ç»è¿‡ä»¥ä¸‹å‡ ä¸ªé‡è¦æ­¥éª¤ï¼š</p><p><img src="/img/just-in-time/JIT1.png" alt="JIT (just-in-time) compiler"></p><h2><span id="jitç®€ä»‹">JITç®€ä»‹</span></h2><p>**JITæ˜¯just in timeçš„ç¼©å†™ï¼Œä¹Ÿå°±æ˜¯å³æ—¶ç¼–è¯‘ã€‚**é€šè¿‡JITæŠ€æœ¯ï¼Œèƒ½å¤Ÿåšåˆ°Javaç¨‹åºæ‰§è¡Œé€Ÿåº¦çš„åŠ é€Ÿã€‚é‚£ä¹ˆï¼Œæ˜¯æ€ä¹ˆåšåˆ°çš„å‘¢ï¼Ÿ</p><p>æˆ‘ä»¬éƒ½çŸ¥é“ï¼ŒJavaæ˜¯ä¸€é—¨è§£é‡Šå‹è¯­è¨€ï¼ˆæˆ–è€…è¯´æ˜¯åŠç¼–è¯‘ï¼ŒåŠè§£é‡Šå‹è¯­è¨€ï¼‰ã€‚Javaé€šè¿‡ç¼–è¯‘å™¨javacå…ˆå°†æºç¨‹åºç¼–è¯‘æˆä¸å¹³å°æ— å…³çš„Javaå­—èŠ‚ç æ–‡ä»¶ï¼ˆ.classï¼‰ï¼Œå†ç”±JVMè§£é‡Šæ‰§è¡Œå­—èŠ‚ç æ–‡ä»¶ï¼Œä»è€Œåšåˆ°å¹³å°æ— å…³ã€‚ ä½†æ˜¯ï¼Œæœ‰åˆ©å¿…æœ‰å¼Šã€‚å¯¹å­—èŠ‚ç çš„è§£é‡Šæ‰§è¡Œè¿‡ç¨‹å®è´¨ä¸ºï¼šJVMå…ˆå°†å­—èŠ‚ç ç¿»è¯‘ä¸ºå¯¹åº”çš„æœºå™¨æŒ‡ä»¤ï¼Œç„¶åæ‰§è¡Œæœºå™¨æŒ‡ä»¤ã€‚å¾ˆæ˜¾ç„¶ï¼Œè¿™æ ·ç»è¿‡è§£é‡Šæ‰§è¡Œï¼Œå…¶æ‰§è¡Œé€Ÿåº¦å¿…ç„¶ä¸å¦‚ç›´æ¥æ‰§è¡ŒäºŒè¿›åˆ¶å­—èŠ‚ç æ–‡ä»¶ã€‚</p><p>è€Œä¸ºäº†æé«˜æ‰§è¡Œé€Ÿåº¦ï¼Œä¾¿å¼•å…¥äº† JIT æŠ€æœ¯ã€‚å½“JVMå‘ç°æŸä¸ªæ–¹æ³•æˆ–ä»£ç å—è¿è¡Œç‰¹åˆ«é¢‘ç¹çš„æ—¶å€™ï¼Œå°±ä¼šè®¤ä¸ºè¿™æ˜¯<code>â€œçƒ­ç‚¹ä»£ç â€ï¼ˆHot Spot Codeï¼‰</code>ã€‚ç„¶åJITä¼šæŠŠéƒ¨åˆ†â€œçƒ­ç‚¹ä»£ç â€ç¼–è¯‘æˆæœ¬åœ°æœºå™¨ç›¸å…³çš„æœºå™¨ç ï¼Œå¹¶è¿›è¡Œä¼˜åŒ–ï¼Œç„¶åå†æŠŠç¼–è¯‘åçš„æœºå™¨ç ç¼“å­˜èµ·æ¥ï¼Œä»¥å¤‡ä¸‹æ¬¡ä½¿ç”¨ã€‚</p><p><img src="/img/just-in-time/JIT2.webp" alt="JIT (just-in-time) compiler"></p><h3><span id="hot-spotç¼–è¯‘">Hot Spotç¼–è¯‘</span></h3><p>å½“ JVM æ‰§è¡Œä»£ç æ—¶ï¼Œå®ƒå¹¶ä¸æ˜¯ç«‹å³å¼€å§‹ç¼–è¯‘ä»£ç çš„ã€‚è¿™ä¸»è¦æœ‰ä¸¤ä¸ªåŸå› ï¼š</p><p>é¦–å…ˆï¼Œå¦‚æœè¿™æ®µä»£ç æœ¬èº«åœ¨å°†æ¥åªä¼šè¢«æ‰§è¡Œä¸€æ¬¡ï¼Œé‚£ä¹ˆä»æœ¬è´¨ä¸Šçœ‹ï¼Œç¼–è¯‘å°±æ˜¯åœ¨æµªè´¹ç²¾åŠ›ã€‚å› ä¸ºå°†ä»£ç ç¿»è¯‘æˆ java å­—èŠ‚ç ç›¸å¯¹äºç¼–è¯‘è¿™æ®µä»£ç å¹¶æ‰§è¡Œä»£ç æ¥è¯´ï¼Œè¦å¿«å¾ˆå¤šã€‚</p><p>å½“ç„¶ï¼Œå¦‚æœä¸€æ®µä»£ç é¢‘ç¹çš„è°ƒç”¨æ–¹æ³•ï¼Œæˆ–æ˜¯ä¸€ä¸ªå¾ªç¯ï¼Œä¹Ÿå°±æ˜¯è¿™æ®µä»£ç è¢«å¤šæ¬¡æ‰§è¡Œï¼Œé‚£ä¹ˆç¼–è¯‘å°±éå¸¸å€¼å¾—äº†ã€‚å› æ­¤ï¼Œç¼–è¯‘å™¨å…·æœ‰çš„è¿™ç§æƒè¡¡èƒ½åŠ›ä¼šé¦–å…ˆæ‰§è¡Œè§£é‡Šåçš„ä»£ç ï¼Œç„¶åå†å»åˆ†è¾¨å“ªäº›æ–¹æ³•ä¼šè¢«é¢‘ç¹è°ƒç”¨æ¥ä¿è¯å…¶æœ¬èº«çš„ç¼–è¯‘ã€‚<strong>Hot Spot VM é‡‡ç”¨äº† JIT compile æŠ€æœ¯ï¼Œå°†è¿è¡Œé¢‘ç‡å¾ˆé«˜çš„å­—èŠ‚ç ç›´æ¥ç¼–è¯‘ä¸ºæœºå™¨æŒ‡ä»¤æ‰§è¡Œä»¥æé«˜æ€§èƒ½</strong>ï¼Œæ‰€ä»¥å½“å­—èŠ‚ç è¢« JIT ç¼–è¯‘ä¸ºæœºå™¨ç çš„æ—¶å€™ï¼Œè¦è¯´å®ƒæ˜¯ç¼–è¯‘æ‰§è¡Œçš„ä¹Ÿå¯ä»¥ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿è¡Œæ—¶ï¼Œéƒ¨åˆ†ä»£ç å¯èƒ½ç”± JIT ç¿»è¯‘ä¸ºç›®æ ‡æœºå™¨æŒ‡ä»¤ï¼ˆä»¥ method ä¸ºç¿»è¯‘å•ä½ï¼Œè¿˜ä¼šä¿å­˜èµ·æ¥ï¼Œç¬¬äºŒæ¬¡æ‰§è¡Œå°±ä¸ç”¨ç¿»è¯‘äº†ï¼‰ç›´æ¥æ‰§è¡Œã€‚</p><p>ç¬¬äºŒä¸ªåŸå› æ˜¯æœ€ä¼˜åŒ–ï¼Œå½“ JVM æ‰§è¡ŒæŸä¸€æ–¹æ³•æˆ–éå†å¾ªç¯çš„æ¬¡æ•°è¶Šå¤šï¼Œå°±ä¼šæ›´åŠ äº†è§£ä»£ç ç»“æ„ï¼Œé‚£ä¹ˆ JVM åœ¨ç¼–è¯‘ä»£ç çš„æ—¶å€™å°±åšå‡ºç›¸åº”çš„ä¼˜åŒ–ã€‚</p><h2><span id="javascript-ç¼–è¯‘-jit-just-in-time-compiler-æ˜¯æ€ä¹ˆå·¥ä½œçš„">JavaScript ç¼–è¯‘ - JIT (just-in-time) compiler æ˜¯æ€ä¹ˆå·¥ä½œçš„</span></h2><p>å¤§ä½“æ¥è¯´ï¼Œæœ‰ä¸¤ç§æ–¹å¼å¯ä»¥å°†ç¨‹åºç¿»è¯‘æˆæœºå™¨å¯æ‰§è¡Œçš„æŒ‡ä»¤ï¼Œä½¿ç”¨ç¼–è¯‘å™¨ (Compiler) æˆ–è€…æ˜¯ è§£é‡Šå™¨ (Interpreter)ã€‚</p><h3><span id="è§£é‡Šå™¨">è§£é‡Šå™¨</span></h3><p>è§£é‡Šå™¨æ˜¯è¾¹ç¿»è¯‘ï¼Œè¾¹æ‰§è¡Œã€‚</p><p>ä¼˜ç¼ºç‚¹</p><ul><li>ä¼˜ç‚¹ï¼šå¿«é€Ÿæ‰§è¡Œï¼Œä¸éœ€è¦ç­‰å¾…ç¼–è¯‘</li><li>ç¼ºç‚¹ï¼šç›¸åŒçš„ä»£ç å¯èƒ½è¢«ç¿»è¯‘å¤šæ¬¡ï¼Œæ¯”å¦‚å¾ªç¯å†…éƒ¨çš„ä»£ç </li></ul><p><img src="/img/just-in-time/JIT3.png" alt="JIT (just-in-time) compiler"></p><h3><span id="ç¼–è¯‘å™¨">ç¼–è¯‘å™¨</span></h3><p>è€Œç¼–è¯‘å™¨åˆ™æ˜¯æå‰å°†ç»“æœç¿»è¯‘å‡ºæ¥ï¼Œå¹¶ç”Ÿæˆä¸€ä¸ªå¯æ‰§è¡Œç¨‹åºã€‚</p><p>ä¼˜ç¼ºç‚¹</p><ul><li>ä¼˜ç‚¹ï¼šä¸éœ€è¦é‡å¤ç¼–è¯‘ï¼Œå¹¶ä¸”å¯ä»¥åœ¨ç¼–è¯‘æ—¶å¯¹ä»£ç åšä¼˜åŒ–</li><li>ç¼ºç‚¹ï¼šéœ€è¦æå‰ç¼–è¯‘</li></ul><p><img src="/img/just-in-time/JIT4.png" alt="JIT (just-in-time) compiler"></p><h3><span id="jit">JIT</span></h3><p>JavaScript åˆšå‡ºç°çš„æ—¶å€™ï¼Œæ˜¯ä¸€ä¸ªå…¸å‹çš„è§£é‡Šå‹è¯­è¨€ï¼Œå› æ­¤è¿è¡Œé€Ÿåº¦ææ…¢ï¼Œåæ¥æµè§ˆå™¨å¼•å…¥äº† JIT compilerï¼Œå¤§å¹…æé«˜äº† JavaScript çš„è¿è¡Œé€Ÿåº¦ã€‚</p><blockquote><p>åŸç†ï¼šThey added a new part to the JavaScript engine, called a monitor (aka a profiler). That monitor watches the code as it runs, and makes a note of how many times it is run and what types are used.</p></blockquote><p>ç®€å•æ¥è¯´ï¼Œæµè§ˆå™¨åœ¨ JavaScript engine ä¸­åŠ å…¥äº†ä¸€ä¸ª monitorï¼Œç”¨æ¥è§‚å¯Ÿè¿è¡Œçš„ä»£ç ã€‚å¹¶è®°å½•ä¸‹æ¯æ®µä»£ç è¿è¡Œçš„æ¬¡æ•°å’Œä»£ç ä¸­çš„å˜é‡çš„ç±»å‹ã€‚</p><p>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œä¸ºä»€ä¹ˆè¿™æ ·åšèƒ½æé«˜è¿è¡Œé€Ÿåº¦ï¼Ÿ</p><p>åé¢çš„æ‰€æœ‰å†…å®¹éƒ½ä»¥ä¸‹é¢è¿™ä¸ªå‡½æ•°çš„è¿è¡Œä¸ºä¾‹ï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">arraySum</span><span class="token punctuation">(</span><span class="token parameter">arr</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">var</span> sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> arr<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    sum <span class="token operator">+=</span> arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>1st step - Interpreter</strong></p><p>ä¸€å¼€å§‹åªæ˜¯ç®€å•çš„ä½¿ç”¨è§£é‡Šå™¨æ‰§è¡Œï¼Œå½“æŸä¸€è¡Œä»£ç è¢«æ‰§è¡Œäº†å‡ æ¬¡ï¼Œè¿™è¡Œä»£ç ä¼šè¢«æ‰“ä¸Š Warm çš„æ ‡ç­¾ï¼›å½“æŸä¸€è¡Œä»£ç è¢«æ‰§è¡Œäº†å¾ˆå¤šæ¬¡ï¼Œè¿™è¡Œä»£ç ä¼šè¢«æ‰“ä¸Š Hot çš„æ ‡ç­¾</p><p><strong>2nd step - Baseline compiler</strong></p><p>è¢«æ‰“ä¸Š Warm æ ‡ç­¾çš„ä»£ç ä¼šè¢«ä¼ ç»™<code>Baseline Compiler</code>ç¼–è¯‘ä¸”å‚¨å­˜ï¼ŒåŒæ—¶æŒ‰ç…§<code>è¡Œæ•° (Line number)</code> å’Œ<code>å˜é‡ç±»å‹ (Variable type) </code>è¢«ç´¢å¼•ï¼ˆä¸ºä»€ä¹ˆä¼šå¼•å…¥å˜é‡ç±»å‹åšç´¢å¼•å¾ˆé‡è¦ï¼Œåé¢ä¼šè®²ï¼‰</p><p>å½“å‘ç°æ‰§è¡Œçš„ä»£ç å‘½ä¸­ç´¢å¼•ï¼Œä¼šç›´æ¥å–å‡ºç¼–è¯‘åçš„ä»£ç æ‰§è¡Œï¼Œä»è€Œä¸éœ€è¦é‡å¤ç¼–è¯‘å·²ç»ç¼–è¯‘è¿‡çš„ä»£ç </p><p><strong>3rd step - Optimizing compiler</strong></p><p>è¢«æ‰“ä¸Š Hot æ ‡ç­¾çš„ä»£ç ä¼šè¢«ä¼ ç»™<code> Optimizing compiler</code>ï¼Œè¿™é‡Œä¼šå¯¹è¿™éƒ¨åˆ†å¸¦ç åšæ›´ä¼˜åŒ–çš„ç¼–è¯‘ã€‚æ€ä¹ˆæ ·åšæ›´ä¼˜åŒ–çš„ç¼–è¯‘å‘¢ï¼Ÿå…³é”®ç‚¹å°±åœ¨è¿™é‡Œï¼Œæ²¡æœ‰åˆ«çš„åŠæ³•ï¼Œåªèƒ½ç”¨æ¦‚ç‡æ¨¡å‹åšä¸€äº›åˆç†çš„ <code>å‡è®¾ (Assumptions)</code>ã€‚<br>æ¯”å¦‚æˆ‘ä»¬ä¸Šé¢çš„å¾ªç¯ä¸­çš„ä»£ç  sum += arr[i]ï¼Œå°½ç®¡è¿™é‡Œåªæ˜¯ç®€å•çš„ + è¿ç®—å’Œèµ‹å€¼ï¼Œä½†æ˜¯å› ä¸º JavaScript çš„åŠ¨æ€ç±»å‹ (Dynamic typing)ï¼Œå¯¹åº”çš„ç¼–è¯‘ç»“æœæœ‰å¾ˆå¤šç§å¯èƒ½ï¼ˆè¿™ä¸ªè§’åº¦èƒ½å¾ˆæ˜æ˜¾çš„æš´éœ²åŠ¨æ€ç±»å‹çš„ç¼ºç‚¹ï¼‰</p><p>æ¯”å¦‚:</p><p>sum æ˜¯ Intï¼Œarr æ˜¯ Arrayï¼Œi æ˜¯ Intï¼Œè¿™é‡Œçš„ + å°±æ˜¯åŠ æ³•è¿ç®—ï¼Œå¯¹åº”å…¶ä¸­ä¸€ç§ç¼–è¯‘ç»“æœ</p><p>sum æ˜¯ stringï¼Œarr æ˜¯ Arrayï¼Œi æ˜¯ Intï¼Œè¿™é‡Œçš„ + å°±æ˜¯å­—ç¬¦ä¸²æ‹¼æ¥ï¼Œå¹¶ä¸”éœ€è¦æŠŠ i è½¬æ¢ä¸º string ç±»å‹<br>â€¦</p><p>ä¸‹é¢çš„å›¾å¯ä»¥çœ‹å‡ºï¼Œè¿™ä¹ˆç®€å•çš„ä¸€è¡Œä»£ç å¯¹åº”æœ‰ 2^4 = 16 ç§å¯èƒ½çš„ç¼–è¯‘ç»“æœ</p><p><img src="/img/just-in-time/JIT5.png" alt="JIT (just-in-time) compiler"></p><p>å‰é¢ç¬¬äºŒæ­¥çš„ Baseline compiler åšçš„å°±æ˜¯è¿™ä»¶äº‹ï¼Œæ‰€ä»¥ä¸Šé¢è¯´ç¼–è¯‘åçš„ä»£ç éœ€è¦ä½¿ç”¨<code>line number</code>å’Œ<code>variable type</code>ä¸€èµ·åšç´¢å¼•ï¼Œå› ä¸ºä¸åŒçš„ variable type å¯¹åº”ä¸åŒçš„ç¼–è¯‘ç»“æœã€‚</p><p>å¦‚æœä»£ç æ˜¯ â€œWarmâ€ çš„ï¼ŒJIT çš„ä»»åŠ¡ä¹Ÿå°±åˆ°æ­¤ä¸ºæ­¢ï¼Œåé¢æ¯æ¬¡æ‰§è¡Œçš„æ—¶å€™ï¼Œéœ€è¦å…ˆåˆ¤æ–­ç±»å‹ï¼Œå†ä½¿ç”¨å¯¹åº”ç±»å‹çš„ç¼–è¯‘ç»“æœå°±å¥½ã€‚</p><p>ä½†æ˜¯ä¸Šé¢æˆ‘ä»¬è¯´ï¼Œå½“ä»£ç å˜æˆ â€œhotâ€ çš„æ—¶å€™ï¼Œä¼šåšæ›´å¤šçš„ä¼˜åŒ–ã€‚è¿™é‡Œçš„ä¼˜åŒ–å…¶å®æŒ‡çš„å°±æ˜¯ JIT ç›´æ¥å‡è®¾ä¸€ä¸ªå‰æï¼Œæ¯”å¦‚è¿™é‡Œæˆ‘ä»¬ç›´æ¥å‡è®¾ sum æ˜¯ Intï¼Œi ä¹Ÿæ˜¯ Intï¼Œarr æ˜¯ Arrayï¼Œäºæ˜¯å°±åªç”¨ä¸€ç§ç¼–è¯‘ç»“æœå°±å¥½äº†ã€‚</p><p>å®é™…ä¸Šï¼Œåœ¨æ‰§è¡Œå‰ä¼šåšç±»å‹æ£€æŸ¥ï¼Œçœ‹æ˜¯å‡è®¾æ˜¯å¦æˆç«‹ï¼Œå¦‚æœä¸æˆç«‹æ‰§è¡Œå°±ä¼šè¢«æ‰“å›<code>interpreter</code>æˆ–è€…<code>baseline compiler</code>çš„ç‰ˆæœ¬ï¼Œè¿™ä¸ªæ“ä½œå«åš<code> &quot;åä¼˜åŒ– (deoptimization)&quot;</code>ã€‚</p><p>å¯ä»¥çœ‹å‡ºï¼Œåªè¦å‡è®¾çš„æˆåŠŸç‡è¶³å¤Ÿé«˜ï¼Œé‚£ä¹ˆä»£ç çš„æ‰§è¡Œé€Ÿåº¦å°±ä¼šå¿«ã€‚ä½†æ˜¯å¦‚æœå‡è®¾çš„æˆåŠŸç‡å¾ˆä½ï¼Œé‚£ä¹ˆä¼šå¯¼è‡´æ¯”æ²¡æœ‰ä»»ä½•ä¼˜åŒ–çš„æ—¶å€™è¿˜è¦æ…¢ï¼ˆå› ä¸ºè¦ç»å†<code>optimize =&gt; deoptimize</code>çš„è¿‡ç¨‹ï¼‰</p><h2><span id="ç»“è®º">ç»“è®º</span></h2><p>ç®€è€Œè¨€ä¹‹ï¼Œè¿™å°±æ˜¯ JITè¿è¡Œæ—¶æ‰€åšçš„äº‹æƒ…ã€‚å®ƒé€šè¿‡ç›‘æ§æ­£åœ¨è¿è¡Œçš„ä»£ç å¹¶å‘é€è¦ä¼˜åŒ–çš„çƒ­ä»£ç è·¯å¾„ï¼Œä½¿ JavaScript è¿è¡Œå¾—æ›´å¿«ã€‚è¿™ä½¿å¾—å¤§å¤šæ•° JavaScript åº”ç”¨ç¨‹åºçš„æ€§èƒ½æé«˜äº†è®¸å¤šå€ã€‚</p><p>ç„¶è€Œï¼Œå³ä½¿æœ‰äº†è¿™äº›æ”¹è¿›ï¼ŒJavaScript çš„æ€§èƒ½ä»ç„¶æ— æ³•é¢„æµ‹ã€‚ä¸ºäº†ä½¿é€Ÿåº¦æ›´å¿«ï¼ŒJIT åœ¨è¿è¡Œæ—¶å¢åŠ äº†ä¸€äº›å¼€é”€ï¼ŒåŒ…æ‹¬ï¼š</p><p><strong>ä¼˜åŒ–å’Œåä¼˜åŒ–</strong></p><ul><li><p>ç”¨äºç›‘è§†å™¨å’Œå‘ç”Ÿä¿¡æ¯ä¸¢å¤±æ—¶æ¢å¤ä¿¡æ¯çš„å†…å­˜</p></li><li><p>ç”¨äºå­˜å‚¨å‡½æ•°çš„åŸºçº¿å’Œä¼˜åŒ–ç‰ˆæœ¬çš„å†…å­˜</p></li><li><p>è¿™é‡Œè¿˜æœ‰æ”¹è¿›çš„ç©ºé—´ï¼šå¯ä»¥æ¶ˆé™¤å¼€é”€ï¼Œä½¿æ€§èƒ½æ›´åŠ å¯é¢„æµ‹ã€‚</p></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h2&gt;&lt;span id=&quot;å¼•è¨€&quot;&gt;å¼•è¨€&lt;/span&gt;&lt;/h2&gt;
&lt;p&gt;åœ¨è°ˆåˆ°JITå‰ï¼Œè¿˜æ˜¯éœ€è¦å¯¹ç¼–è¯‘è¿‡ç¨‹æœ‰ä¸€äº›ç®€å•çš„äº†è§£ã€‚&lt;/p&gt;
&lt;p&gt;åœ¨ç¼–è¯‘åŸç†ä¸­ï¼ŒæŠŠæºä»£ç ç¿»è¯‘æˆæœºå™¨æŒ‡ä»¤ï¼Œä¸€èˆ¬è¦ç»è¿‡ä»¥ä¸‹å‡ ä¸ªé‡è¦æ­¥éª¤ï¼š&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/img/just-in-time/J</summary>
      
    
    
    
    <category term="JITcompiler" scheme="https://ikkkp.github.io/categories/JITcompiler/"/>
    
    
    <category term="JITcompiler,JavaScript,Wasm" scheme="https://ikkkp.github.io/tags/JITcompiler-JavaScript-Wasm/"/>
    
  </entry>
  
  <entry>
    <title>How Does JIT (Just-In-Time) Compiler Work</title>
    <link href="https://ikkkp.github.io/2023/11/04/en/just-in-time-compilers/"/>
    <id>https://ikkkp.github.io/2023/11/04/en/just-in-time-compilers/</id>
    <published>2023-11-04T02:05:22.000Z</published>
    <updated>2023-11-04T02:45:51.733Z</updated>
    
    <content type="html"><![CDATA[<h2><span id="introduction">Introduction</span></h2><p>Before delving into JIT, itâ€™s essential to have a basic understanding of the compilation process.</p><p>In compiler theory, translating source code into machine instructions generally involves several crucial steps:</p><p><img src="/img/just-in-time/JIT1.png" alt="JIT (Just-In-Time) Compiler"></p><h2><span id="jit-overview">JIT Overview</span></h2><p><strong>JIT stands for Just-In-Time compiler.</strong> Through JIT technology, itâ€™s possible to accelerate the execution speed of Java programs. But how is this achieved?</p><p>Java is an interpreted language (or semi-compiled, semi-interpreted language). Java compiles the source code into platform-independent Java bytecode files (.class) using the javac compiler. These bytecode files are then interpreted and executed by the Java Virtual Machine (JVM), ensuring platform independence. However, interpreting bytecode involves translating it into corresponding machine instructions, which inevitably slows down the execution speed compared to directly executing binary bytecode files.</p><p>To enhance execution speed, JIT technology is introduced. When the JVM identifies a method or code block that is executed frequently, it recognizes it as a <strong>â€œHot Spot Code.â€</strong> JIT compiles these â€œHot Spot Codesâ€ into native machine-specific machine code, optimizes it, and caches the compiled machine code for future use.</p><p><img src="/img/just-in-time/JIT2.webp" alt="JIT (Just-In-Time) Compiler"></p><h3><span id="hot-spot-compilation">Hot Spot Compilation</span></h3><p>When the JVM executes code, it doesnâ€™t immediately start compiling it. There are two main reasons for this:</p><p>Firstly, if a piece of code is expected to be executed only once in the future, compiling it immediately is essentially a waste of resources. Compiling code into Java bytecode is much faster than both compiling and executing the code.</p><p>However, if a piece of code, such as a method call or a loop, is executed multiple times, compiling it becomes worthwhile. The compiler has the ability to discern which methods are frequently called to ensure efficient compilation. <strong>Hot Spot VM employs JIT compilation technology to directly compile high-frequency bytecode into machine instructions</strong> (with the method as the compilation unit). These compiled machine instructions are executed directly when bytecode is JIT-compiled, providing a performance boost.</p><p>The second reason involves optimization. As a method or loop is executed more frequently, the JVM gains a better understanding of the code structure. Therefore, the JVM can make corresponding optimizations during the compilation process.</p><h2><span id="how-javascript-is-compiled-how-jit-just-in-time-compiler-works">How JavaScript is Compiled - How JIT (Just-In-Time) Compiler Works</span></h2><p>In general, there are two ways to translate programs into machine-executable instructions: using a Compiler or an Interpreter.</p><h3><span id="interpreter">Interpreter</span></h3><p>An interpreter translates and executes code line by line as it encounters it.</p><p>Pros:</p><ul><li>Fast execution, no compilation delay.<br>Cons:</li><li>Same code might be translated multiple times, especially within loops.</li></ul><p><img src="/img/just-in-time/JIT3.png" alt="JIT (Just-In-Time) Compiler"></p><h3><span id="compiler">Compiler</span></h3><p>A compiler translates the code in advance and generates an executable program.</p><p>Pros:</p><ul><li>No need for repeated compilation; can optimize code during compilation.<br>Cons:</li><li>Requires upfront compilation.</li></ul><p><img src="/img/just-in-time/JIT4.png" alt="JIT (Just-In-Time) Compiler"></p><h3><span id="jit">JIT</span></h3><p>When JavaScript first emerged, it was a typical interpreted language, resulting in slow execution speeds. Later, browsers introduced JIT compilers, significantly improving JavaScriptâ€™s execution speed.</p><blockquote><p>Principle: They added a new component to the JavaScript engine, known as a monitor (or profiler). This monitor observes the running code, noting how many times it runs and the types used.</p></blockquote><p>In essence, browsers added a monitor to the JavaScript engine to observe the running code, recording how many times each code segment is executed and the variable types used.</p><p>Now, why does this approach speed up the execution?</p><p>Letâ€™s consider a function for illustration:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">arraySum</span><span class="token punctuation">(</span><span class="token parameter">arr</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">var</span> sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> arr<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    sum <span class="token operator">+=</span> arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>1st Step - Interpreter</strong></p><p>Initially, the code is executed using an interpreter. When a line of code is executed several times, it is marked as <strong>â€œWarm,â€</strong> and if executed frequently, it is labeled as <strong>â€œHot.â€</strong></p><p><strong>2nd Step - Baseline Compiler</strong></p><p>Warm-labeled code is passed to the <strong>Baseline Compiler</strong>, which compiles and stores it. The compiled code is indexed based on <strong>line numbers</strong> and <strong>variable types</strong> (why variable types are important will be explained shortly).</p><p>When the index matches, the corresponding compiled code is directly executed without recompilation, eliminating the need to recompile already compiled code.</p><p><strong>3rd Step - Optimizing Compiler</strong></p><p>Hot-labeled code is sent to the <strong>Optimizing Compiler</strong>, where further optimizations are applied. How are these optimizations performed? This is the key: due to JavaScriptâ€™s <strong>dynamic typing</strong>, a single line of code can have multiple possible compilations, exposing the drawback of dynamic typing.</p><p>For instance:</p><ul><li><code>sum</code> is Int, <code>arr</code> is Array, <code>i</code> is Int; the <code>+</code> operation is simple addition, corresponding to one compilation result.</li><li><code>sum</code> is string, <code>arr</code> is Array, <code>i</code> is Int; the <code>+</code> operation is string concatenation, requiring the conversion of <code>i</code> to a string type.<br>â€¦</li></ul><p>As illustrated in the diagram below, such a simple line of code has 16 possible compilation results.</p><p><img src="/img/just-in-time/JIT5.png" alt="JIT (Just-In-Time) Compiler"></p><p>The Baseline Compiler handles this complexity, and thus, the compiled code needs to be indexed using both <strong>line numbers</strong> and <strong>variable types</strong>. Different variable types lead to different compilation results.</p><p>If the code is â€œWarm,â€ the JITâ€™s job ends here. Each subsequent execution involves type checks and uses the corresponding compiled result.</p><p>However, when the code becomes â€œHot,â€ more optimizations are performed. Here, optimization means JIT makes a specific assumption. For example, assuming <code>sum</code> and <code>i</code> are both Integers and <code>arr</code> is an Array, only one compilation result is needed.</p><p>In practice, type checks are performed before execution. If the assumptions are incorrect, the execution is <strong>â€œdeoptimized,â€</strong> reverting to the interpreter or baseline compiler versions. This process is called <strong>â€œdeoptimization.â€</strong></p><p>As evident, the speed of execution relies on the accuracy of these assumptions. If the assumption success rate is high, the code executes faster. Conversely, low success rates lead to slower execution than without any optimization (due to the <code>optimize =&gt; deoptimize</code> process).</p><h2><span id="conclusion">Conclusion</span></h2><p>In summary, this is what JIT does at runtime. It monitors running code, identifies hot code paths for optimization, making JavaScript run faster. This significantly improves the performance of most JavaScript applications.</p><p>However, JavaScript performance remains unpredictable. To make it faster, JIT adds some overhead at runtime, including:</p><p><strong>Optimization and Deoptimization</strong></p><ul><li>Memory for monitoring and recovering lost information</li><li>Memory for storing baseline and optimized versions of functions</li></ul><p>Thereâ€™s room for improvement, notably in eliminating overhead to make performance more predictable.</p><hr>]]></content>
    
    
      
      
    <summary type="html">&lt;h2&gt;&lt;span id=&quot;introduction&quot;&gt;Introduction&lt;/span&gt;&lt;/h2&gt;
&lt;p&gt;Before delving into JIT, itâ€™s essential to have a basic understanding of the compila</summary>
      
    
    
    
    <category term="JIT compiler" scheme="https://ikkkp.github.io/categories/JIT-compiler/"/>
    
    
    <category term="JIT compiler,JavaScript,WebAssembly" scheme="https://ikkkp.github.io/tags/JIT-compiler-JavaScript-WebAssembly/"/>
    
  </entry>
  
  <entry>
    <title>æµ…è°ˆWebAssembly</title>
    <link href="https://ikkkp.github.io/2023/11/03/wasm-1/"/>
    <id>https://ikkkp.github.io/2023/11/03/wasm-1/</id>
    <published>2023-11-03T11:33:25.000Z</published>
    <updated>2023-11-03T13:53:43.619Z</updated>
    
    <content type="html"><![CDATA[<h2><span id="å¼•è¨€">å¼•è¨€</span></h2><p>çœ‹äº†ä¸å°‘Wasmçš„æ–‡ç« ï¼Œä¹Ÿåšäº†ä¸€äº›æ€§èƒ½æµ‹è¯•ï¼Œç°åœ¨æ¥ç®€å•çš„è°ˆä¸‹è¿™é—¨æŠ€æœ¯ã€‚</p><h2><span id="wasm-æ±‡ç¼–çº§æ€§èƒ½">WASM == æ±‡ç¼–çº§æ€§èƒ½ï¼Ÿ</span></h2><p>è¿™æ˜¾ç„¶ä¸å¯¹ï¼Œ<strong>WASM é‡Œçš„ Assembly å¹¶ä¸æ„å‘³ç€çœŸæ­£çš„æ±‡ç¼–ç ï¼Œè€Œåªæ˜¯ç§æ–°çº¦å®šçš„å­—èŠ‚ç ï¼Œä¹Ÿæ˜¯éœ€è¦è§£é‡Šå™¨è¿è¡Œçš„ã€‚</strong> è¿™ç§è§£é‡Šå™¨è‚¯å®šæ¯” JS è§£é‡Šå™¨å¿«å¾—å¤šï¼Œä½†è‡ªç„¶ä¹Ÿè¾¾ä¸åˆ°çœŸæ­£çš„åŸç”Ÿæœºå™¨ç æ°´å¹³ã€‚</p><p>ä¸€ä¸ªå¯ä¾›å‚è€ƒçš„æ•°æ®æŒ‡æ ‡ï¼Œæ˜¯ JS ä¸Šäº† JIT åæ•´ä½“æ€§èƒ½å¤§è‡´æ˜¯æœºå™¨ç  1/20 çš„æ°´å¹³ï¼Œè€Œ WASM åˆ™å¯ä»¥è·‘åˆ°æœºå™¨ç  1/3 çš„é‡çº§ï¼ˆè§†åœºæ™¯ä¸åŒå¾ˆä¸å¥½è¯´ï¼Œä»…ä¾›å‚è€ƒï¼‰ã€‚ç›¸å½“äºå³ä¾¿ä½ å†™çš„æ˜¯ C++ å’Œ Rust çº§çš„è¯­è¨€ï¼Œå¾—åˆ°çš„å…¶å®ä¹Ÿåªæ˜¯ Java å’Œ C# çº§çš„æ€§èƒ½ã€‚è¿™ä¹Ÿå¯ä»¥è§£é‡Šä¸ºä»€ä¹ˆ WASM å¹¶ä¸èƒ½åœ¨æ‰€æœ‰åº”ç”¨åœºæ™¯éƒ½æ˜¾ç¤ºå‡ºå‹å€’æ€§çš„æ€§èƒ½ä¼˜åŠ¿ï¼šåªè¦ä½ æ‡‚å¾—å¦‚ä½•è®© JS å¼•æ“èµ°åœ¨ Happy Path ä¸Šï¼Œé‚£ä¹ˆåœ¨æµè§ˆå™¨é‡Œï¼ŒJS å°±æ•¢å’Œ Rust æ€§èƒ½ä¼˜åŒ–å·®ä¸å¤šã€‚</p><p>ä¸€ä¸ªåœ¨ WASM å’Œ JS ä¹‹é—´åšæ€§èƒ½å¯¹æ¯”çš„ç»å…¸æ¡ˆä¾‹ï¼Œå°±æ˜¯ Mozilla å¼€å‘è€…å’Œ V8 å¼€å‘è€…çš„ç™½å­¦ç°åœºã€‚æ•´ä¸ªè¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼š</p><p>Mozilla Hacks å‘è¡¨äº†ä¸€ç¯‡åä¸º <a href="https://hacks.mozilla.org/2018/01/oxidizing-source-maps-with-rust-and-webassembly/">ç”¨ Rust å’Œ WASM ä¼˜åŒ– Source Map æ€§èƒ½ çš„åšæ–‡</a>ï¼Œå°† source-map è¿™ä¸ª JS åŒ…çš„æ€§èƒ½ä¼˜åŒ–äº†äº”å€ã€‚</p><p>V8 æ ¸å¿ƒå¼€å‘ Vyacheslav Egorov å›åº”åä¸º<a href="https://hacks.mozilla.org/2018/01/oxidizing-source-maps-with-rust-and-webassembly/">ä½ ä¹Ÿè®¸ä¸éœ€è¦ç”¨ Rust å’Œ WASM æ¥ä¼˜åŒ– JS çš„åšæ–‡</a>ï¼Œç”¨çº¯ JS å®ç°äº†é€Ÿåº¦æ¯” Rust æ›´å¿«çš„æƒŠäººä¼˜åŒ–ã€‚</p><p>åŸæ–‡ä½œè€…ä»¥ æ— éœ€é­”æ³•çš„é€Ÿåº¦ ä¸ºåå±•å¼€äº†è¿›ä¸€æ­¥è®¨è®ºï¼Œå¹¶ç”¨ Rust åšå‡ºäº†æ–°çš„æ€§èƒ½ä¼˜åŒ–ã€‚</p><p>å·§çš„æ˜¯ï¼Œè¿™åœºè®ºæˆ˜æ­£å‘ç”Ÿåœ¨ä¸¤å¹´å‰ç™½è‰²ç›¸ç°¿çš„å­£èŠ‚ã€‚åŒæ–¹å°±åƒé›ªèœå’Œå†¬é©¬é‚£æ ·å±•å¼€äº†é«˜æ°´å¹³çš„å¯¹å†³ï¼Œååœºé¢ååˆ†ç²¾å½©ã€‚æœ€ç»ˆ Vyacheslav ç»™å‡ºäº†ä¸€å¼ ä¸‰è½®è¿‡æ‹›åçš„æ€§èƒ½å¯¹æ¯”å›¾ã€‚å¯ä»¥çœ‹åˆ°è™½ç„¶æœ€ç»ˆè¿˜æ˜¯ Rust æ›´å¿«ï¼Œä½† JS è¢«é€¼åˆ°æé™åéä½†ä¸æ˜¯è´¥çŠ¬ï¼Œè¿˜èƒœå‡ºäº†ä¸€å›åˆï¼š</p><p><img src="/img/wasm/Rust&amp;Js.png" alt="Rust&amp;Js"></p><p>å¦å¤–ï¼Œå¤§ä½¬Milo Yip åšè¿‡çš„ä¸åŒè¯­è¨€å…‰çº¿è¿½è¸ªæ€§èƒ½æµ‹è¯•ï¼ˆä¿®ç½—åœºï¼‰ï¼Œä¹Ÿèƒ½ä¾§é¢å°è¯å¸¦ VM è¯­è¨€ä¸æœºå™¨ç ä¹‹é—´çš„æ€§èƒ½å¯¹æ¯”ç»“è®ºã€‚C++ã€Java å’Œ JS åœ¨æœªç»ç‰¹åˆ«ä¼˜åŒ–çš„å‰æä¸‹ï¼Œå¯ä»¥åˆ†åˆ«ä»£è¡¨ä¸‰ä¸ªå…¸å‹çš„æ€§èƒ½æ¡£æ¬¡ï¼š</p><p><a href="https://www.cnblogs.com/miloyip/archive/2010/07/07/languages_brawl_GI.html">C++/C#/F#/Java/JS/Lua/Python/Ruby æ¸²æŸ“æ¯”è¯•</a></p><h2><span id="wasm-æ¯”-js-å¿«æ‰€ä»¥è®¡ç®—å¯†é›†å‹åº”ç”¨å°±è¯¥ç”¨å®ƒ">WASM æ¯” JS å¿«ï¼Œæ‰€ä»¥è®¡ç®—å¯†é›†å‹åº”ç”¨å°±è¯¥ç”¨å®ƒï¼Ÿ</span></h2><p>è¿™æœ‰ç‚¹åé¢‡ï¼Œ<code>WASM </code>åŒæ ·æ˜¯ CPU ä¸Šçš„è®¡ç®—ã€‚å¯¹äºå¯ä»¥é«˜åº¦å¹¶è¡ŒåŒ–çš„ä»»åŠ¡ï¼Œä½¿ç”¨ <code>WebGL</code> æ¥åš GPU åŠ é€Ÿå¾€å¾€æ›´å¿«ã€‚è­¬å¦‚æˆ‘åœ¨ å®ç”¨ WebGL å›¾åƒå¤„ç†å…¥é—¨ è¿™ç¯‡æ–‡ç« é‡Œä»‹ç»çš„å›¾åƒå¤„ç†ç®—æ³•ï¼Œæ¯”èµ· JS é‡Œ for å¾ªç¯éå† Canvas åƒç´ å°±å¯ä»¥å¾ˆè½»æ¾åœ°å¿«ä¸ªå‡ åå€ã€‚</p><p>è€Œè¿™ç§å¥—ä¸¤å±‚ for å¾ªç¯çš„è‹¦åŠ›æ´»ï¼Œç”¨ç°åœ¨çš„ WASM é‡å†™èƒ½å¿«å‡ å€å°±éå¸¸ä¸é”™äº†ã€‚è‡³äºæµè§ˆå™¨å†… AI è®¡ç®—çš„æ€§èƒ½æ–¹é¢ï¼Œç¤¾åŒºçš„è¯„æµ‹ç»“è®ºä¹Ÿæ˜¯ WebGL å’Œ WebMetal å…·å¤‡æœ€é«˜çš„æ€§èƒ½æ°´å¹³ï¼Œç„¶åæ‰æ˜¯ WASMã€‚å‚è§è¿™é‡Œï¼š<a href="https://blog.logrocket.com/ai-in-browsers-comparing-tensorflow-onnx-and-webdnn-for-image-classification/">æµè§ˆå™¨å†…çš„ AI è¯„æµ‹</a></p><p>ä¸è¿‡ï¼ŒWebGL çš„åŠ é€Ÿå­˜åœ¨ç²¾åº¦é—®é¢˜ã€‚ä¾‹å¦‚å‰ç«¯å›¾åƒç¼©æ”¾åº“ Picaï¼Œå®ƒçš„æ ¸å¿ƒç”¨çš„æ˜¯ Lanczos é‡‡æ ·ç®—æ³•ã€‚æˆ‘ç”¨ WebGL ç€è‰²å™¨å®ç°è¿‡è¿™ä¸ªç®—æ³•ï¼Œå®ƒå¹¶ä¸å¤æ‚ï¼Œæ—©æœŸçš„ Pica ä¹Ÿæ›¾ç»åŠ å…¥è¿‡å¯é€‰çš„ WebGL ä¼˜åŒ–ï¼Œä½†ç°åœ¨å´åŠˆè…¿äº† WASMã€‚è¿™ä¸€å†³ç­–çš„ç†ç”±åœ¨äºï¼ŒWASM èƒ½ä¿è¯ç›¸åŒå‚æ•°ä¸‹çš„è®¡ç®—ç»“æœå’Œ JS ä¸€è‡´ï¼Œä½† WebGL åˆ™ä¸è¡Œã€‚ç›¸å…³è®¨è®ºå‚è§è¿™é‡Œï¼š<a href="https://github.com/nodeca/pica/issues/114">Issue #114 Â· nodeca/pica</a></p><p>è€Œä¸”ï¼Œå¯¹äºå‰ç«¯æ¥è¯´ï¼Œè®¡ç®—å¯†é›†å‹çš„åº”ç”¨åœºæ™¯å¹¶ä¸ç®—å¤ªå¤šï¼Œæ¯”èµ· WebGPU è¿™ç§å›¾å½¢æ¸²æŸ“çš„æŠ€æœ¯çš„å‘å±•å‰æ™¯å¯ä»¥è¯´ç®—æ˜¯æ¯”è¾ƒå¼±åŠ¿ï¼Œä½†æ¯•ç«ŸäºŒè€…ä¸åœ¨åŒä¸€ç§åº”ç”¨åœºæ™¯ä¸‹ã€‚</p><p>æ‰€ä»¥å¯¹è®¡ç®—å¯†é›†å‹ä»»åŠ¡ï¼ŒWASM å¹¶ä¸æ˜¯å‰ç«¯å”¯ä¸€çš„æ•‘æ˜Ÿï¼Œè€Œæ˜¯ç»™å¤§å®¶å¤šäº†ä¸€ç§åœ¨æ€§èƒ½ã€å¼€å‘æˆæœ¬å’Œæ•ˆæœä¹‹é—´æƒè¡¡çš„é€‰æ‹©ã€‚åœ¨æˆ‘ä¸ªäººå°è±¡é‡Œï¼Œå‰ç«¯åœ¨å›¾å½¢æ¸²æŸ“å¤–éœ€è¦ç®—åŠ›çš„åœºæ™¯è¯´å®è¯å¹¶ä¸å¤ªå¤šï¼ŒåƒåŠ å¯†ã€å‹ç¼©ã€æŒ–çŸ¿è¿™ç§ï¼Œéƒ½éš¾è¯´æ˜¯é«˜é¢‘åˆšéœ€ã€‚è‡³äºæœªæ¥å¯èƒ½ç›¸å½“é‡è¦çš„ AI åº”ç”¨ï¼Œ<strong>é•¿æœŸè€Œè¨€æˆ‘è¿˜æ˜¯çœ‹å¥½ WebGPU è¿™ç§æ›´èƒ½å‘æŒ¥å‡º GPU æ½œåŠ›çš„ä¸‹ä¸€ä»£æ ‡å‡†ï¼Œå½“ç„¶ WASM ä¹Ÿå·²ç»æ˜¯ä¸ªä¸é”™çš„å¯é€‰é¡¹äº†ã€‚</strong></p><h2><span id="åªè¦åµŒå…¥-wasm-å‡½æ•°åˆ°-js-å°±èƒ½æé«˜æ€§èƒ½">åªè¦åµŒå…¥ WASM å‡½æ•°åˆ° JS å°±èƒ½æé«˜æ€§èƒ½ï¼Ÿ</span></h2><p>æ—¢ç„¶ WASM å¾ˆå¿«ï¼Œé‚£ä¹ˆæ˜¯ä¸æ˜¯æˆ‘åªè¦æŠŠ JS é‡Œ const add (a, b) =&gt; a + b è¿™æ ·çš„ä»£ç æ¢æˆç”¨ C ç¼–è¯‘å‡ºæ¥çš„ WASMï¼Œå°±å¯ä»¥æœ‰æ•ˆåœ°æé«˜æ€§èƒ½äº†å‘¢ï¼Ÿ</p><p><strong>è¿™è¿˜çœŸä¸ä¸€å®šã€‚</strong></p><p>å› ä¸ºç°ä»£æµè§ˆå™¨å†…çš„ JS å¼•æ“éƒ½æœ‰è¿›è¡Œæ€§èƒ½ä¼˜åŒ–çš„åˆ©å™¨ï¼Œéƒ½æ ‡é…äº†ä¸€ç§ä¸œè¥¿ï¼Œé‚£å°±æ˜¯ <code>JIT</code>ã€‚ç®€å•æ¥è¯´ï¼Œä¸Šé¢è¿™ä¸ª add å‡½æ•°å¦‚æœå§‹ç»ˆéƒ½åœ¨ç®—æ•´æ•°åŠ æ³•ï¼Œé‚£ä¹ˆ JS å¼•æ“å°±ä¼šè‡ªåŠ¨ç¼–è¯‘å‡ºä¸€ä»½è®¡ç®— int a + int b çš„æœºå™¨ç æ¥æ›¿ä»£æ‰åŸå§‹çš„ JS å‡½æ•°ï¼Œè¿™æ ·é«˜é¢‘è°ƒç”¨è¿™ä¸ªå‡½æ•°çš„æ€§èƒ½å°±ä¼šå¾—åˆ°æå¤§çš„æå‡ï¼Œè¿™ä¹Ÿå°±æ˜¯ JIT æ‰€è°“ Just-in-time ç¼–è¯‘çš„å¥¥å¦™æ‰€åœ¨äº†ã€‚</p><p>æ‰€ä»¥ï¼Œä¸è¦ä¸€è§‰å¾— JS æ…¢å°±æƒ³ç€æ‰‹åŠ¨é  WASM æ¥åµŒå…¥ Cï¼Œå…¶å®ç°ä»£ JS å¼•æ“å¯éƒ½æ˜¯åœ¨ä¸åœåœ°å¸®ä½ <code>ã€Œè‡ªåŠ¨æŠŠ JS è½¬æ¢æˆ Cã€</code>çš„ï¼å¦‚æœä½ å¯ä»¥æŠŠä¸€ä¸ª JS å‡½æ•°æ”¹å†™æˆç­‰ä»·çš„ Cï¼Œé‚£ä¹ˆæˆ‘çŒœå¦‚æœæŠŠè¿™ä¸ªå‡½æ•°å•ç‹¬æŠ½ç¦»å‡ºæ¥ï¼Œé  JS å¼•æ“çš„ JIT éƒ½å¾ˆå¯èƒ½è¾¾åˆ°ç›¸è¿‘çš„æ€§èƒ½ã€‚è¿™åº”è¯¥å°±æ˜¯ V8 å¼€å‘è€…æ•¢ç”¨ JS å’Œ Rust å¯¹çº¿çš„åº•æ°”æ‰€åœ¨å§ã€‚</p><p><a href="https://hacks.mozilla.org/2018/10/calls-between-javascript-and-webassembly-are-finally-fast-%F0%9F%8E%89/">åƒåœ¨ JS å’Œ WASM ä¹‹é—´çš„è°ƒç”¨ç»ˆäºå˜å¿«äº†</a> è¿™ç¯‡æ–‡ç« ä¸­ï¼ŒLin Clark éå¸¸ç²¾å½©åœ°è®ºè¿°äº†æ•´ä¸ªä¼˜åŒ–è¿‡ç¨‹ï¼Œ<strong>æœ€ç»ˆä½¿å¾— JS å’Œ WASM é—´çš„å‡½æ•°è°ƒç”¨ï¼Œæ¯”éå†…è”çš„ JS å‡½æ•°é—´è°ƒç”¨è¦å¿«</strong>ã€‚ä¸è¿‡ï¼Œè‡³äºå’Œè¢« JIT å†…è”æ‰çš„ JS å‡½æ•°è°ƒç”¨ç›¸æ¯”èµ·æ¥å¦‚ä½•ï¼Œè¿™ç¯‡æ–‡ç« å°±æ²¡æœ‰æåŠäº†ã€‚</p><p>è¿™é‡Œåä¸ªé¢˜ï¼ŒMozilla ç»å¸¸å®£ä¼ è‡ªå·±å®ç°çš„è¶…å¤§å¹…ä¼˜åŒ–ï¼Œæœ‰ä¸å°‘éƒ½å¯èƒ½æ¥æºäºä¹‹å‰æ˜æ˜¾çš„è®¾è®¡é—®é¢˜ï¼ˆå¹³å¿ƒè€Œè®ºï¼Œæˆ‘ä»¬è‡ªå·±ä½•å°ä¸æ˜¯è¿™æ ·å‘¢ï¼‰ã€‚åƒå»å¹´ Firefox 70 åœ¨ Mac ä¸Šå®ç°çš„ å¤§å¹…çœç”µä¼˜åŒ–ï¼Œå…¶æ ¹æºæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿç²—ç•¥çš„ç†è§£æ˜¯ï¼Œä»¥å‰çš„ Firefox åœ¨ Mac ä¸Šç«Ÿç„¶æ¯å¸§éƒ½ä¼šå…¨é‡æ›´æ–°çª—å£åƒç´ ï¼å½“ç„¶ï¼Œè¿™äº›æ–‡ç« çš„å¹²è´§éƒ½ç›¸å½“å¤šï¼Œååˆ†æ¨èå¤§å®¶æ‰“å¥½åŸºç¡€åçœ‹çœ‹åŸæ–‡ï¼Œè‡³å°‘æ˜¯ä¸ªæ›´å¤§çš„ä¸–ç•Œï¼Œä¹Ÿå¸¸å¸¸èƒ½å¯¹è½¯ä»¶æ¶æ„è®¾è®¡æœ‰æ‰€å¯å‘ã€‚</p><p>å¦‚æœåç»­ WASM æ”¯æŒäº† GCï¼Œé‚£ä¹ˆåµŒå…¥äº’è°ƒçš„æƒ…å†µå¾ˆå¯èƒ½æ›´å¤æ‚ã€‚ä¾‹å¦‚æˆ‘æœ€è¿‘å°±å°è¯•åœ¨ Flutter çš„ Dart å’Œå®‰å“çš„ Java ä¹‹é—´æ‰‹åŠ¨åŒæ­¥å¤§å¯¹è±¡ï¼Œå¸Œæœ›èƒ½ã€ŒåµŒå…¥ä¸€äº›å®‰å“å¹³å°èƒ½åŠ›åˆ° Flutter ä½“ç³»é‡Œã€ï¼Œç„¶è€Œè¿™å¸¦æ¥äº†è®¸å¤šå†—é•¿è€Œä½æ€§èƒ½çš„èƒ¶æ°´ä»£ç ï¼Œéœ€è¦é€šè¿‡å¼‚æ­¥çš„æ¶ˆæ¯æ¥åšæ·±æ‹·è´ï¼Œå¯æ§æ€§å¾ˆä½ã€‚è™½ç„¶ WASM ç°åœ¨è¿˜æ²¡æœ‰ GCï¼Œä½†ä¸€æ—¦åŠ ä¸Šï¼Œæˆ‘æœ‰ç†ç”±æ€€ç–‘å®ƒå’Œ JS ä¹‹é—´çš„å¯¹è±¡ç”Ÿå‘½å‘¨æœŸç®¡ç†ä¹Ÿä¼šé‡åˆ°ç±»ä¼¼çš„é—®é¢˜ã€‚åªæ˜¯è¿™ä¸ªé—®é¢˜ä¸»è¦æ˜¯è®© Mozilla å’Œ Google çš„äººæ¥æ“å¿ƒï¼Œç”¨ä¸ç€æˆ‘ä»¬ç®¡è€Œå·²ã€‚</p><h2><span id="åœ¨-js-é‡Œè°ƒ-wasmå°±åƒ-python-é‡Œè°ƒ-c-é‚£æ ·ç®€å•">åœ¨ JS é‡Œè°ƒ WASMï¼Œå°±åƒ Python é‡Œè°ƒ C é‚£æ ·ç®€å•ï¼Ÿ</span></h2><p>è¿™ä¸ªé—®é¢˜åªæœ‰å®é™…åšè¿‡æ‰æœ‰å‘è¨€æƒã€‚è­¬å¦‚æˆ‘æœ€è¿‘å°è¯•è¿‡çš„è¿™äº›ä¸œè¥¿ï¼š</p><ul><li>åœ¨å®‰å“çš„ Java class é‡Œè°ƒç”¨ C++</li><li>åœ¨ Flutter çš„ Dart é‡Œè°ƒç”¨ C</li><li>åœ¨ QuickJS è¿™ç§åµŒå…¥å¼ JS å¼•æ“é‡Œè°ƒç”¨ C</li></ul><p>å®ƒä»¬éƒ½èƒ½åšåˆ°ä¸€ä»¶äº‹ï¼Œé‚£å°±æ˜¯åœ¨å¼•æ“é‡Œæ–°å»ºåŸç”Ÿå¯¹è±¡ï¼Œå¹¶å°†å®ƒä»¥ä¼ å¼•ç”¨çš„æ–¹å¼ç›´æ¥äº¤ç»™<code>C / C++</code>å‡½æ•°è°ƒç”¨ï¼Œå¹¶ç”¨å¼•æ“çš„ GC æ¥ç®¡ç†å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸã€‚è¿™ç§æ–¹å¼ä¸€èˆ¬ç§°ä¸º<code> FFIï¼ˆForeign Function Interface å¤–éƒ¨å‡½æ•°æ¥å£ï¼‰</code>ï¼Œå¯ä»¥æŠŠåŸç”Ÿä»£ç åµŒå…¥åˆ°è¯­è¨€ Runtime ä¸­ã€‚ä½†å¦‚æœæ˜¯ä¸¤ä¸ªä¸åŒçš„ Runtimeï¼Œäº‹æƒ…å°±æ²¡æœ‰è¿™ä¹ˆç®€å•äº†ã€‚<strong>ä¾‹å¦‚ QuickJS åˆ° Java çš„ binding é¡¹ç›® Quackï¼Œå°±éœ€è¦åœ¨ JS çš„å¯¹è±¡å’Œ Java å¯¹è±¡ä¸­åš Marshallingï¼ˆç±»ä¼¼äº JSON é‚£æ ·çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼‰çš„è¿‡ç¨‹ï¼Œä¸èƒ½éšä¾¿ä¼ å¼•ç”¨ã€‚</strong></p><p>**å¯¹ WASM æ¥è¯´æ˜¯æ€æ ·çš„å‘¢ï¼Ÿ**åŸºæœ¬ä¸Šï¼ŒWASM çš„çº¿æ€§å†…å­˜ç©ºé—´å¯ä»¥éšä¾¿ç”¨ JS è¯»å†™ï¼Œå¹¶æ²¡æœ‰æ·±æ‹·è´çš„å›°æ‰°ã€‚ä¸è¿‡ï¼ŒWASMå€’æœ‰ä¸€äº›æ•°æ®æµçš„é—®é¢˜ï¼Œåªæœ‰ int å’Œ float ä¹‹æµçš„æ•°æ®ç±»å‹ï¼Œè¿ string éƒ½æ²¡æœ‰ï¼Œå› æ­¤å¯¹äºç¨å¤æ‚ä¸€ç‚¹çš„å¯¹è±¡ï¼Œéƒ½å¾ˆéš¾æ‰‹å†™å‡º JS å’Œ WASM ä¸¤è¾¹å„è‡ªçš„ç»“æ„ã€‚è¿™ç‚¹å¯¼è‡´ä½ æƒ³ç›´æ¥ä½¿ç”¨Wasmåšå¤æ‚çš„å¯¹è±¡è½¬æ¢éƒ½è¾ƒä¸ºå›°éš¾ï¼Œç°åœ¨è¿™ä»¶è„æ´»æ˜¯äº¤ç”± <code>wasm-bindgen </code>ç­‰è½®å­æ¥åšçš„,**wasm-pack ä½¿ç”¨å¦ä¸€ä¸ªå·¥å…· wasm-bindgen æ¥æä¾› JavaScript å’Œ Rust ç­‰å…¶ä»–ç±»å‹ä¹‹é—´çš„æ¡¥æ¢ã€‚**ä½†æ¯•ç«Ÿè¿™ä¸ªè¿‡ç¨‹å¹¶ä¸æ˜¯ç›´æ¥åœ¨ JS çš„ Runtime é‡ŒåµŒå…¥ C / C++ å‡½æ•°ï¼Œå’Œä¼ ç»Ÿç¼–è¯‘åˆ°æœºå™¨ç çš„ FFI è¿˜æ˜¯æŒºä¸ä¸€æ ·çš„ã€‚</p><p>ä¾‹å¦‚ç°åœ¨å¦‚æœéœ€è¦é¢‘ç¹åœ°ç”¨ WASM æ“ä½œ JS å¯¹è±¡ï¼Œé‚£ä¹ˆå‡ ä¹å¿…ç„¶æ˜¯å½±å“æ€§èƒ½çš„ã€‚è¿™æ–¹é¢å…¸å‹çš„å‘æ˜¯åŸºäº WASM ç§»æ¤çš„ OpenGL åº”ç”¨ã€‚åƒ C++ ä¸­çš„ä¸€ä¸ª glTexImage2D å‡½æ•°ï¼Œç›®å‰ç¼–è¯‘åˆ° WASM åå°±éœ€è¦å…ˆä» WASM èµ°åˆ° JS èƒ¶æ°´å±‚ï¼Œå†åœ¨ JS é‡Œè°ƒ gl.texImage2D è¿™æ ·çš„ WebGL APIï¼Œæœ€åæ‰èƒ½ç»ç”± C++ binding è°ƒç”¨åˆ°åŸç”Ÿçš„å›¾å½¢ APIã€‚è¿™æ ·ä»ä¸€å±‚èƒ¶æ°´å˜æˆäº†ä¸¤å±‚ï¼Œæ€§èƒ½ä¸è¦è¯´æ¯”èµ·åŸç”Ÿ C++ï¼Œèƒ½æ¯”å¾—ä¸Šç›´æ¥å†™ JS å—ï¼Ÿ</p><p>å½“ç„¶ï¼ŒMozilla ä¹Ÿæ„è¯†åˆ°äº†è¿™ä¸ªé—®é¢˜ï¼Œå› æ­¤ä»–ä»¬åœ¨å°è¯•å¦‚ä½•æ›´å¥½åœ°å°† <code>Web IDLï¼ˆä¹Ÿå°±æ˜¯æµè§ˆå™¨åŸç”Ÿ API çš„ bindingï¼‰</code>å¼€æ”¾ç»™ WASMï¼Œå¹¶åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­æå‡ºäº† WASM Interface Types æ¦‚å¿µï¼šæ—¢ç„¶ WASM å·²ç»æ˜¯ä¸ªå­—èŠ‚ç çš„ä¸­é—´å±‚äº†ï¼Œé‚£ä¹ˆå¹²è„†ç»™å®ƒçº¦å®šä¸ªèƒ½ä¸€ç»Ÿæ‰€æœ‰ç¼–ç¨‹è¯­è¨€è¿è¡Œæ—¶ç±»å‹çš„ IR è§„èŒƒå§ï¼ä¸è¿‡ï¼Œè¿™ä¸€è§„èŒƒè¿˜æ˜¯å¸Œæœ›ä¸»è¦é åè®®åŒ–ã€ç»“æ„åŒ–çš„æ·±æ‹·è´æ¥è§£å†³é—®é¢˜ï¼Œåªæœ‰æœªæ¥çš„ anyref ç±»å‹æ˜¯å¯ä»¥ä¼ å¼•ç”¨çš„ã€‚anyref æœ‰äº›åƒ Unix é‡Œçš„æ–‡ä»¶æè¿°ç¬¦ï¼Œè¿™é‡Œå°±ä¸å±•å¼€äº†ã€‚</p><p><img src="/img/wasm/Rust&amp;Js3.webp" alt="Js2WASM"></p><h2><span id="wasm-å±äºå‰ç«¯ç”Ÿæ€">WASM å±äºå‰ç«¯ç”Ÿæ€ï¼Ÿ</span></h2><p>è¿™ä¸ªæˆ‘ä¸å¤ªè®¤å¯, è¦çŸ¥é“Wasmè¿™ä¸ªç©æ„å…¶ç¼–è¯‘å·¥å…·é“¾å’Œä¾èµ–åº“ç”Ÿæ€ï¼ŒåŸºæœ¬å®Œå…¨ä¸æ¶‰åŠ JSã€‚</p><p>ä¸€å¥—æ”¯æŒäº¤å‰ç¼–è¯‘çš„å·¥å…·é“¾ï¼Œä¼šé™„å¸¦ä¸Šç”¨äºæ”¯æŒç›®æ ‡å¹³å°çš„ä¸€äº›åº“ï¼Œä¾‹å¦‚ include äº† <code>&lt;GLES2/gl2.h&gt;</code> ä¹‹åï¼Œä½ è°ƒç”¨åˆ°çš„<code> glTexImage2D API</code> å°±æ˜¯åŠ¨æ€åº“é‡Œæä¾›çš„ã€‚æœ‰äº†åŠ¨æ€åº“ï¼Œè¿™ä¸ª API æ‰èƒ½åœ¨ x86 / ARM / MIPS / WASM ç­‰å¹³å°ä¸Šä¸€è‡´åœ°è·‘èµ·æ¥ï¼ˆå°±åƒå®‰å“ä¸Šçš„ .so æ ¼å¼ï¼‰ã€‚åƒ Emscripten å°±æä¾›äº†é¢å‘ WASM å¹³å°ï¼Œç¼–è¯‘æˆ JS æ ¼å¼çš„ä¸€å¥—åŠ¨æ€åº“ã€‚ä½†å®ƒåªèƒ½ä¿è¯è¿™äº› API èƒ½ç”¨ï¼Œæ€§èƒ½å¦‚ä½•å°±å¦è¯´äº†ã€‚å®ƒè‡ªå·±ä¹Ÿå¯¹ç§»æ¤ WebGL æ—¶çš„æ€§ç“¶é¢ˆæå‡ºäº†å¾ˆå¤šçš„ä¼˜åŒ–å»ºè®®ã€‚</p><p>æ‰€ä»¥è¿™é‡Œå†é‡å¤ä¸€éï¼Œç¼–è¯‘ WASM åº”ç”¨æ‰€éœ€çš„ä¾èµ–åº“å’Œæ•´å¥—å·¥å…·é“¾ï¼Œå‡ ä¹éƒ½è·Ÿ JS æ²¡ä»€ä¹ˆå…³ç³»ã€‚JS å°±åƒæœºå™¨ç é‚£æ ·ï¼Œåªæ˜¯äººå®¶å·¥å…·é“¾ç¼–è¯‘å‡ºæ¥çš„è¾“å‡ºæ ¼å¼è€Œå·²ã€‚åœ¨ JS å¼€å‘è€…çœ‹æ¥ï¼Œè¿™æ•´å¥—ä¸œè¥¿å¯èƒ½æ˜¾å¾—ç›¸å½“çªå…€ã€‚ä½†ä»åŸç”Ÿåº”ç”¨å¼€å‘è€…çš„è§†è§’çœ‹æ¥ï¼Œè¿™ä¸€åˆ‡éƒ½å†æ­£å¸¸ä¸è¿‡äº†ã€‚</p><h2><span id="åè®°">åè®°</span></h2><p>WASM å½“ç„¶æ˜¯ä¸ªé©å‘½æ€§çš„æŠ€æœ¯ï¼Œä»£è¡¨äº†ä¸€ç§è·¨å¹³å°çš„å…¨æ–°æ–¹å‘ï¼Œå°¤å…¶å¯¹åŸç”Ÿåº”ç”¨å¼€å‘è€…æ¥è¯´å…·å¤‡å·¨å¤§çš„å•†ä¸šä»·å€¼ã€‚ä½†å®ƒå¯¹å‰ç«¯æ¥è¯´å…¶å®å°±æ˜¯ä¸ªæµè§ˆå™¨å†…ç½®çš„å­—èŠ‚ç è™šæ‹Ÿæœºã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2&gt;&lt;span id=&quot;å¼•è¨€&quot;&gt;å¼•è¨€&lt;/span&gt;&lt;/h2&gt;
&lt;p&gt;çœ‹äº†ä¸å°‘Wasmçš„æ–‡ç« ï¼Œä¹Ÿåšäº†ä¸€äº›æ€§èƒ½æµ‹è¯•ï¼Œç°åœ¨æ¥ç®€å•çš„è°ˆä¸‹è¿™é—¨æŠ€æœ¯ã€‚&lt;/p&gt;
&lt;h2&gt;&lt;span id=&quot;wasm-æ±‡ç¼–çº§æ€§èƒ½&quot;&gt;WASM == æ±‡ç¼–çº§æ€§èƒ½ï¼Ÿ&lt;/span&gt;&lt;/h2&gt;
&lt;p&gt;è¿™æ˜¾ç„¶ä¸å¯¹ï¼Œ&lt;s</summary>
      
    
    
    
    <category term="Wasm" scheme="https://ikkkp.github.io/categories/Wasm/"/>
    
    
    <category term="Wasm" scheme="https://ikkkp.github.io/tags/Wasm/"/>
    
  </entry>
  
  <entry>
    <title>A Brief Discussion on WebAssembly</title>
    <link href="https://ikkkp.github.io/2023/11/03/en/wasm-1/"/>
    <id>https://ikkkp.github.io/2023/11/03/en/wasm-1/</id>
    <published>2023-11-03T11:33:25.000Z</published>
    <updated>2023-11-03T14:08:55.145Z</updated>
    
    <content type="html"><![CDATA[<h2><span id="introduction">Introduction</span></h2><p>After reading numerous articles on WebAssembly and conducting some performance tests, Iâ€™d like to share my insights on this technology.</p><h2><span id="is-wasm-equivalent-to-assembly-level-performance">Is WASM Equivalent to Assembly-Level Performance?</span></h2><p>Certainly not. <strong>The assembly in WASM does not mean actual assembly code; it is a new bytecode with its own conventions that need an interpreter to run.</strong> This interpreter is much faster than a JavaScript interpreter but still falls short of native machine code performance.</p><p>As a reference point, when JavaScript is optimized with Just-In-Time (JIT) compilation, its overall performance is roughly 1/20th of machine code. In comparison, WASM can achieve about 1/3rd of machine code performance (these figures vary depending on the context and are for reference purposes only). Even if you write code in languages like C++ and Rust, the performance you get is comparable to Java and C#, not native machine code. This explains why WASM does not demonstrate overwhelming performance advantages in all application scenarios: if you know how to optimize JS to run efficiently, it can compete with Rust in the browser environment.</p><p>A classic case of performance comparison between WASM and JS occurred in a debate between Mozilla developers and V8 developers. Mozilla Hacks published an article titled <a href="https://hacks.mozilla.org/2018/01/oxidizing-source-maps-with-rust-and-webassembly/">â€œOptimizing Source Maps Performance with Rust and WebAssemblyâ€</a>, optimizing the performance of the source-map JavaScript package by five times. V8 core developer Vyacheslav Egorov responded with an article titled <a href="https://hacks.mozilla.org/2018/01/oxidizing-source-maps-with-rust-and-webassembly/">â€œYou Might Not Need Rust and WebAssembly to Speed Up Your JSâ€</a>, achieving astonishing optimizations in pure JS that outperformed Rust. The debate was intense, and the performance comparison chart after three rounds clearly showed Rustâ€™s superiority, although JS managed to outperform in one round:</p><p><img src="/img/wasm/Rust&amp;Js.png" alt="Rust&amp;Js"></p><p>Additionally, Milo Yip conducted performance tests on different languages for ray tracing (a highly intensive computation task), supporting the conclusion about performance comparisons between languages and machine code. C++, Java, and JS, without specific optimizations, can represent three typical performance levels:</p><p><a href="https://www.cnblogs.com/miloyip/archive/2010/07/07/languages_brawl_GI.html">Language Rendering Comparison (C++/C#/F#/Java/JS/Lua/Python/Ruby)</a></p><h2><span id="is-wasm-faster-than-js-so-it-should-be-used-for-compute-intensive-applications">Is WASM Faster Than JS, So It Should Be Used for Compute-Intensive Applications?</span></h2><p>This assumption is a bit biased. <code>WASM</code> is still processed on the CPU. For tasks that can be highly parallelized, using <code>WebGL</code> for GPU acceleration is often much faster. For instance, algorithms for image processing, as I discussed in my article [â€œPractical WebGL Image Processing Introductionâ€](link to the article), can easily be several tens of times faster by using WebGL than by looping through canvas pixels in JS.</p><p>Rewriting such a nested loop in WASM to achieve a few times improvement over JS is already considered quite good. Regarding AI computations in the browser, community evaluations show that WebGL and WebMetal offer the highest performance levels, followed by WASM. Refer to this article: <a href="https://blog.logrocket.com/ai-in-browsers-comparing-tensorflow-onnx-and-webdnn-for-image-classification/">â€œBrowser-Based AI Evaluationsâ€</a></p><p>However, WebGL acceleration has precision issues. For example, the core of the frontend image resizing library Pica uses the Lanczos sampling algorithm. I implemented this algorithm with WebGL shaders; it is not complicated. The early version of Pica once included optional WebGL optimizations, but now it has shifted to WASM. The reason is that WASM can ensure consistent computation results with JS for the same parameters, whereas WebGL cannot. For related discussions, see <a href="https://github.com/nodeca/pica/issues/114">Issue #114 Â· nodeca/pica</a></p><p>Moreover, there are not many compute-intensive scenarios in frontend development. Tasks like encryption, compression, and mining are not high-frequency requirements. As for potentially essential AI applications in the future, <strong>I personally have confidence in WebGPU, the next-generation standard that can fully unleash GPU potential. However, WASM is already a good alternative.</strong></p><h2><span id="does-embedding-a-wasm-function-in-js-automatically-improve-performance">Does Embedding a WASM Function in JS Automatically Improve Performance?</span></h2><p>Not necessarily. Modern JS engines have powerful tools for performance optimization, namely <code>JIT</code> (Just-In-Time compilation). Simply put, if a function like the <code>add</code> function in the code <code>const add = (a, b) =&gt; a + b</code> consistently performs integer addition, the JS engine will automatically compile machine code to compute <code>int a + int b</code>, replacing the original JS function. This optimization significantly enhances the performance of frequent calls to this function. This is the magic of JIT (Just-In-Time) compilation.</p><p>So, donâ€™t assume that JS is slow and think of manually replacing such JS functions with C compiled to WASM to improve performance. Modern JS engines automatically â€œtranslate JS to Câ€ like this for you! If you can rewrite a JS function into equivalent C code, itâ€™s highly likely that this function, when inlined, will achieve similar performance through JIT compilation. This is probably why V8 developers confidently challenged Rust with JS in the debate I mentioned earlier.</p><p>In the article <a href="https://hacks.mozilla.org/2018/10/calls-between-javascript-and-webassembly-are-finally-fast-%F0%9F%8E%89/">â€œCalls between JavaScript and WebAssembly are Finally Fast ğŸ‰â€</a>, Lin Clark eloquently discusses the optimization process. <strong>In the end, function calls between JS and WASM are faster than non-inlined JS function calls.</strong> However, the comparison between these calls and JS functions that are inlined by JIT is not mentioned in the article.</p><p>Itâ€™s worth mentioning that Mozilla often promotes their massively optimized work, much of which might have stemmed from apparent design issues (letâ€™s be honest; we all have our moments). For instance, the significant power-saving optimization in Firefox 70 for Mac was rooted in what exactly? A rough understanding is that the previous version of Firefox on Mac updated the window pixels for every frame! Of course, these articles contain substantial information, and I highly recommend reading the original texts after building a good foundation. It opens up a broader world and often inspires insights into software architecture design.</p><p>If WASM supports garbage collection (GC) in the future, managing object lifecycles between JS and WASM may become more complicated. For example, I recently attempted to synchronize large objects between Dart in Flutter and Java in Android, hoping to â€œembed some Android platform capabilities into the Flutter ecosystem.â€ However, this approach led to a lot of verbose and low-performance glue code. Objects had to be deep-copied asynchronously through messages, with very low controllability. Although WASM currently does not have GC, once itâ€™s added, I have reasons to suspect that managing object lifecycles between WASM and JS will face similar challenges. However, this problem mainly concerns Mozilla and Google developers; itâ€™s not something we need to worry about.</p><h2><span id="is-wasm-just-like-calling-c-from-python-in-terms-of-simplicity">Is WASM Just Like Calling C from Python in Terms of Simplicity?</span></h2><p>This question can only be answered by practical experience. For example, I have recently attempted the following:</p><ul><li>Calling C++ from Java classes in Android</li><li>Calling C from Dart in Flutter</li><li>Calling C/C++ from QuickJS, an embedded JS engine</li></ul><p>All of these cases involve creating native objects in the engine and passing them to C/C++ functions by reference. This method is generally referred to as <code>FFI (Foreign Function Interface)</code>, allowing native code to be embedded in language runtimes. However, if you are dealing with two different runtimes, things are not that simple. <strong>For instance, in the Quack project, which aims to bind QuickJS with Java, marshaling (similar to serialization and deserialization like JSON) has to be done between JS and Java objects; you cannot simply pass references.</strong></p><p><strong>So, how does it work with WASM?</strong> Essentially, WASMâ€™s linear memory can be freely read and written by JS, without the hassle of deep copying. However, WASM does present some challenges in terms of data flow. It only supports basic data types such as integers and floats; there is no support for complex data structures like strings. Thus, for slightly more complex objects, itâ€™s challenging to manually define corresponding structures on both the JS and WASM sides. This difficulty makes it complicated to directly perform complex object transformations using WASM. Currently, this dirty work is left to tools like <code>wasm-bindgen</code>, which handles complex object transformations between languages. <code>wasm-pack</code> uses another tool called <code>wasm-bindgen</code> to bridge JavaScript and Rust, among other types. However, this process is not the same as directly embedding C/C++ functions in JS runtime, as with traditional FFI compiled to machine code.</p><p>For example, if you frequently manipulate JS objects with WASM, it can almost certainly impact performance. A typical pitfall in this regard is porting OpenGL applications to WASM. For example, a function like <code>glTexImage2D</code> in C++ now needs to go through two layers: first, it goes from WASM to JS in the glue layer, and then from JS to WebGL API like <code>gl.texImage2D</code> through C++ binding. This adds an extra layer of complexity compared to directly writing the equivalent JS code. Can this approach match the performance of writing JS directly instead of two layers of glue code?</p><p>Of course, Mozilla is aware of this issue. Hence, they are exploring how to better expose <code>Web IDL (the bindings of browser-native APIs)</code> to WASM. In this process, they introduced the concept of <code>WASM Interface Types</code>: since WASM is already an intermediate bytecode, why not establish a universal Intermediate Representation (IR) specification that can unify all types across programming language runtimes? However, this specification hopes to solve problems mainly through protocolization and structured deep copying, with only the <code>anyref</code> type allowing passing by reference. <code>anyref</code> behaves somewhat like file descriptors in Unix; I wonâ€™t delve into this here.</p><p><img src="/img/wasm/Rust&amp;Js3.webp" alt="Js2WASM"></p><h2><span id="is-wasm-part-of-the-frontend-ecosystem">Is WASM Part of the Frontend Ecosystem?</span></h2><p>I do not agree with this statement. Itâ€™s essential to note that the toolchains for compiling WASM applications and the libraries they depend on have little to do with JS.</p><p>A toolchain that supports cross-compilation typically comes with libraries supporting the target platform. For example, after including <code>&lt;GLES2/gl2.h&gt;</code>, the <code>glTexImage2D</code> API you call is provided by the dynamic library. This API can run consistently on x86, ARM, MIPS, WASM, etc., platforms (similar to <code>.so</code> files in Android). Emscripten provides a set of dynamic libraries specifically for the WASM platform, compiling them into JS format. However, it only guarantees that these APIs are available; performance is a different story. Emscripten also provides many optimization suggestions for porting WebGL applications.</p><p>So, Iâ€™d like to reiterate that the dependencies and toolchains required to compile WASM applications are almost entirely unrelated to JS. JS is just a format produced by these toolchains, similar to machine code. From the perspective of JS developers, these toolchains may seem quite unfamiliar. Still, from the perspective of native application developers, everything is quite standard.</p><h2><span id="conclusion">Conclusion</span></h2><p>WebAssembly is undoubtedly a revolutionary technology, representing a new cross-platform direction, especially valuable for native application developers. However, for frontend developers, itâ€™s just a bytecode virtual machine embedded in the browser.</p><p>I hope this article clarifies some misconceptions and provides a better understanding of WebAssemblyâ€™s capabilities and limitations. While itâ€™s a powerful tool, itâ€™s essential to use it judiciously and consider its advantages and trade-offs within the context of your specific use case. Remember, WebAssembly is not a magic solution that automatically improves performance in all scenarios. Itâ€™s another option in the toolkit, providing a balance between performance, development cost, and effectiveness. As the technology evolves, it will be interesting to see how it integrates further into the broader web ecosystem.</p><hr><p><em>Note: This article is a translated version of the original post. For the most accurate and up-to-date information, please refer to the original source.</em></p><pre><code></code></pre>]]></content>
    
    
      
      
    <summary type="html">&lt;h2&gt;&lt;span id=&quot;introduction&quot;&gt;Introduction&lt;/span&gt;&lt;/h2&gt;
&lt;p&gt;After reading numerous articles on WebAssembly and conducting some performance tests</summary>
      
    
    
    
    <category term="Wasm" scheme="https://ikkkp.github.io/categories/Wasm/"/>
    
    
    <category term="Wasm" scheme="https://ikkkp.github.io/tags/Wasm/"/>
    
  </entry>
  
  <entry>
    <title>Vue-æµ…å“åº”ä¸æ·±å“åº”</title>
    <link href="https://ikkkp.github.io/2023/11/01/vue-reactive-shallowReactive/"/>
    <id>https://ikkkp.github.io/2023/11/01/vue-reactive-shallowReactive/</id>
    <published>2023-11-01T11:29:41.000Z</published>
    <updated>2023-11-01T12:23:46.946Z</updated>
    
    <content type="html"><![CDATA[<h2><span id="å‰è¨€">å‰è¨€</span></h2><p>ä»‹ç» reactive ä¸ shallowReactive çš„åŒºåˆ«ï¼Œå³æ·±å“åº”å’Œæµ…å“åº”çš„åŒºåˆ«ã€‚</p><h2><span id="æµ…å“åº”å¼ä¸æ·±ç›¸åº”å¼">æµ…å“åº”å¼ä¸æ·±ç›¸åº”å¼</span></h2><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">bar</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span><span class="token punctuation">&#123;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>foo<span class="token punctuation">.</span>bar<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token comment">// ä¿®æ”¹ obj.foo.bar çš„å€¼ï¼Œå¹¶ä¸èƒ½è§¦å‘å“åº”</span>obj<span class="token punctuation">.</span>foo<span class="token punctuation">.</span>bar <span class="token operator">=</span> <span class="token number">2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é¦–å…ˆï¼Œåˆ›å»º obj ä»£ç†å¯¹è±¡ï¼Œè¯¥å¯¹è±¡çš„ foo å±æ€§å€¼ä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå³ { bar: 1} ã€‚æ¥ç€ï¼Œåœ¨å‰¯ä½œç”¨å‡½æ•°å†…è®¿é—® obj.foo.bar çš„å€¼ã€‚ä½†æ˜¯æˆ‘ä»¬å‘ç°ï¼Œåç»­å¯¹ obj.foo.bar çš„ä¿®æ”¹ä¸èƒ½è§¦å‘å‰¯ä½œç”¨å‡½æ•°é‡æ–°æ‰§è¡Œï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿæ¥çœ‹ä¸€ä¸‹ç°åœ¨çš„å®ç°ï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>obj <span class="token punctuation">,</span><span class="token punctuation">&#123;</span>    <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> <span class="token string">'raw'</span><span class="token punctuation">)</span>         <span class="token keyword">return</span> target<span class="token punctuation">;</span>    <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// å½“è¯»å–å±æ€§å€¼æ—¶ï¼Œç›´æ¥è¿”å›ç»“æœ</span>    <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">// çœç•¥å…¶ä»–æ‹¦æˆªå‡½æ•°</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç”±ä¸Šé¢è¿™æ®µä»£ç å¯çŸ¥ï¼Œå½“æˆ‘ä»¬è¯»å– obj.foo.bar æ—¶ï¼Œé¦–å…ˆè¦è¯»å– obj.foo çš„å€¼ã€‚è¿™é‡Œæˆ‘ä»¬ç›´æ¥ä½¿ç”¨ Reflect.get å‡½æ•°è¿”å›obj.foo çš„ç»“æœã€‚ç”±äºé€šè¿‡ Reflect.get å¾—åˆ° obj.foo çš„ç»“æœæ˜¯ä¸€ä¸ªæ™®é€šå¯¹è±¡ï¼Œå³ { bar: 1} ï¼Œå®ƒå¹¶ä¸æ˜¯ä¸€ä¸ªå“åº”å¼å¯¹è±¡ï¼Œæ‰€ä»¥åœ¨å‰¯ä½œç”¨å‡½æ•°ä¸­è®¿é—® obj.foo.bar æ—¶ï¼Œæ˜¯ä¸èƒ½å»ºç«‹å“åº”è”ç³»çš„ã€‚è¦è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦å¯¹ Reflect.get è¿”å›çš„ç»“æœåšä¸€å±‚åŒ…è£…:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>    <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">const</span> result <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// If the result is an object, make it reactive</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> result <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token function">reactive</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>      <span class="token keyword">return</span> result<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token comment">// Other traps...</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™æ®µä»£ç å®šä¹‰äº†ä¸€ä¸ªåä¸ºreactiveçš„å‡½æ•°ï¼Œè¯¥å‡½æ•°æ¥æ”¶ä¸€ä¸ªå¯¹è±¡ä½œä¸ºå‚æ•°ï¼Œå¹¶è¿”å›è¯¥å¯¹è±¡çš„ä»£ç†ã€‚è¿™ä¸ªä»£ç†ä½¿ç”¨äº†geté™·é˜±å‡½æ•°ï¼Œå½“æˆ‘ä»¬å°è¯•è·å–å¯¹è±¡çš„æŸä¸ªå±æ€§æ—¶ï¼Œè¿™ä¸ªå‡½æ•°å°±ä¼šè¢«è§¦å‘ã€‚</p><p>åœ¨geté™·é˜±å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆä½¿ç”¨Reflect.getæ–¹æ³•è·å–ç›®æ ‡å¯¹è±¡çš„å±æ€§å€¼ã€‚Reflect.getæ–¹æ³•æ¥æ”¶ä¸‰ä¸ªå‚æ•°ï¼šç›®æ ‡å¯¹è±¡ã€å±æ€§åå’Œæ¥æ”¶å™¨å¯¹è±¡ã€‚åœ¨è¿™é‡Œï¼Œæ¥æ”¶å™¨å¯¹è±¡å°±æ˜¯ä»£ç†å¯¹è±¡æœ¬èº«ã€‚</p><p>ç„¶åï¼Œæˆ‘ä»¬æ£€æŸ¥è·å–çš„ç»“æœæ˜¯å¦ä¸ºå¯¹è±¡ã€‚å¦‚æœæ˜¯å¯¹è±¡ï¼Œæˆ‘ä»¬å°±å¯¹å…¶è¿›è¡Œå“åº”å¼å¤„ç†ï¼Œå³å†æ¬¡è°ƒç”¨reactiveå‡½æ•°ã€‚è¿™æ ·åšçš„ç›®çš„æ˜¯ç¡®ä¿åµŒå¥—çš„å¯¹è±¡ä¹Ÿå…·æœ‰å“åº”å¼ç‰¹æ€§ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå½“æˆ‘ä»¬ä¿®æ”¹è¿™äº›åµŒå¥—å¯¹è±¡çš„å±æ€§æ—¶ï¼Œä¹Ÿèƒ½è§¦å‘å“åº”å¼ç³»ç»Ÿã€‚</p><p>æœ€åï¼Œå¦‚æœè·å–çš„ç»“æœä¸æ˜¯å¯¹è±¡ï¼Œæˆ‘ä»¬å°±ç›´æ¥è¿”å›ç»“æœã€‚</p><h2><span id="æµ…å“åº”å¼">æµ…å“åº”å¼</span></h2><p>ç„¶è€Œï¼Œå¹¶éæ‰€æœ‰æƒ…å†µä¸‹æˆ‘ä»¬éƒ½å¸Œæœ›æ·±å“åº”ï¼Œè¿™å°±å‚¬ç”Ÿäº†shallowReactiveï¼Œå³æµ…å“åº”ã€‚æ‰€è°“æµ…å“åº”ï¼ŒæŒ‡çš„æ˜¯åªæœ‰å¯¹è±¡çš„ç¬¬ä¸€å±‚å±æ€§æ˜¯å“åº”çš„ï¼Œä¾‹å¦‚ï¼š</p><p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªå¯¹è±¡ï¼Œå®ƒçš„å±æ€§å€¼ä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token literal-property property">innerObj</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>    <span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token string">'value'</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¦‚æœæˆ‘ä»¬å¯¹objè¿›è¡Œæ·±å“åº”å¤„ç†ï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">let</span> reactiveObj <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>é‚£ä¹ˆï¼Œæ— è®ºæˆ‘ä»¬ä¿®æ”¹objçš„å±æ€§ï¼Œè¿˜æ˜¯ä¿®æ”¹innerObjçš„å±æ€§ï¼Œéƒ½ä¼šè§¦å‘å“åº”å¼ç³»ç»Ÿï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">reactiveObj<span class="token punctuation">.</span>innerObj<span class="token punctuation">.</span>key <span class="token operator">=</span> <span class="token string">'new value'</span><span class="token punctuation">;</span> <span class="token comment">// è§¦å‘å“åº”å¼ç³»ç»Ÿ</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ä½†æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬åªæƒ³è¦objçš„ç¬¬ä¸€å±‚å±æ€§æ˜¯å“åº”çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåªæœ‰å½“æˆ‘ä»¬ä¿®æ”¹objçš„å±æ€§æ—¶æ‰è§¦å‘å“åº”å¼ç³»ç»Ÿï¼Œè€Œä¿®æ”¹innerObjçš„å±æ€§åˆ™ä¸è§¦å‘ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦ä½¿ç”¨shallowReactiveå‡½æ•°ï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">let</span> shallowReactiveObj <span class="token operator">=</span> <span class="token function">shallowReactive</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>è¿™æ ·ï¼Œåªæœ‰å½“æˆ‘ä»¬ä¿®æ”¹objçš„å±æ€§æ—¶ï¼Œæ‰ä¼šè§¦å‘å“åº”å¼ç³»ç»Ÿï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">shallowReactiveObj<span class="token punctuation">.</span>innerObj <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span class="token comment">// è§¦å‘å“åº”å¼ç³»ç»Ÿ</span>shallowReactiveObj<span class="token punctuation">.</span>innerObj<span class="token punctuation">.</span>key <span class="token operator">=</span> <span class="token string">'new value'</span><span class="token punctuation">;</span> <span class="token comment">// ä¸è§¦å‘å“åº”å¼ç³»ç»Ÿ</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2><span id="vuejsé‡Œreactiveå’Œshallowreactive">Vuejsé‡Œreactiveå’ŒshallowReactive</span></h2><p>åœ¨Vue.jsä¸­ï¼Œreactiveå’ŒshallowReactiveå‡½æ•°éƒ½ç”¨äºåˆ›å»ºå“åº”å¼å¯¹è±¡ï¼Œè¿™ä¸€å°èŠ‚æ¥è®¨è®ºä¸‹ä»–ä»¬çš„ä¸åŒã€‚</p><p>reactiveå‡½æ•°åˆ›å»ºçš„æ˜¯æ·±åº¦å“åº”å¼å¯¹è±¡ã€‚è¿™æ„å‘³ç€ä¸ä»…å¯¹è±¡æœ¬èº«ï¼Œè€Œä¸”å®ƒå†…éƒ¨çš„æ‰€æœ‰åµŒå¥—å¯¹è±¡éƒ½ä¼šå˜æˆå“åº”å¼çš„ã€‚æ— è®ºæ˜¯ä¿®æ”¹å¯¹è±¡çš„å±æ€§ï¼Œè¿˜æ˜¯ä¿®æ”¹å…¶åµŒå¥—å¯¹è±¡çš„å±æ€§ï¼Œéƒ½ä¼šè§¦å‘å“åº”å¼ç³»ç»Ÿã€‚</p><p>è€ŒshallowReactiveå‡½æ•°åˆ›å»ºçš„æ˜¯æµ…å±‚å“åº”å¼å¯¹è±¡ã€‚è¿™æ„å‘³ç€åªæœ‰å¯¹è±¡çš„é¡¶å±‚å±æ€§æ˜¯å“åº”å¼çš„ã€‚å¦‚æœå¯¹è±¡åŒ…å«åµŒå¥—å¯¹è±¡ï¼Œé‚£ä¹ˆä¿®æ”¹è¿™äº›åµŒå¥—å¯¹è±¡çš„å±æ€§ä¸ä¼šè§¦å‘å“åº”å¼ç³»ç»Ÿã€‚</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token literal-property property">innerObj</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>    <span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token string">'value'</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">let</span> reactiveObj <span class="token operator">=</span> Vue<span class="token punctuation">.</span><span class="token function">reactive</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>reactiveObj<span class="token punctuation">.</span>innerObj<span class="token punctuation">.</span>key <span class="token operator">=</span> <span class="token string">'new value'</span><span class="token punctuation">;</span> <span class="token comment">// è¿™å°†è§¦å‘å“åº”å¼ç³»ç»Ÿ</span><span class="token keyword">let</span> shallowReactiveObj <span class="token operator">=</span> Vue<span class="token punctuation">.</span><span class="token function">shallowReactive</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>shallowReactiveObj<span class="token punctuation">.</span>innerObj<span class="token punctuation">.</span>key <span class="token operator">=</span> <span class="token string">'new value'</span><span class="token punctuation">;</span> <span class="token comment">// è¿™å°†ä¸ä¼šè§¦å‘å“åº”å¼ç³»ç»Ÿ</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2><span id="åªè¯»å’Œæµ…åªè¯»">åªè¯»å’Œæµ…åªè¯»</span></h2><p>è®¨è®ºå®Œå“åº”å¼å’Œæµ…å“åº”å¼ï¼Œæˆ‘ä»¬åœ¨æ¥è¯´ä¸‹åªè¯»å’Œæµ…åªè¯»ï¼š</p><p>Vue.jsè¿˜æä¾›äº†<code>readonly</code>å’Œ<code>shallowReadonly</code>å‡½æ•°ï¼Œå®ƒä»¬ç”¨äºåˆ›å»ºåªè¯»çš„å“åº”å¼å¯¹è±¡ã€‚</p><p><code>readonly</code>å‡½æ•°åˆ›å»ºçš„æ˜¯æ·±åº¦åªè¯»çš„å“åº”å¼å¯¹è±¡ã€‚è¿™æ„å‘³ç€ä¸ä»…å¯¹è±¡æœ¬èº«æ˜¯åªè¯»çš„ï¼Œè€Œä¸”å®ƒå†…éƒ¨çš„æ‰€æœ‰åµŒå¥—å¯¹è±¡ä¹Ÿéƒ½æ˜¯åªè¯»çš„ã€‚ä»»ä½•å°è¯•ä¿®æ”¹å¯¹è±¡æˆ–å…¶åµŒå¥—å¯¹è±¡çš„å±æ€§çš„æ“ä½œéƒ½ä¼šå¤±è´¥ã€‚</p><p><code>shallowReadonly</code>å‡½æ•°åˆ›å»ºçš„æ˜¯æµ…å±‚åªè¯»çš„å“åº”å¼å¯¹è±¡ã€‚è¿™æ„å‘³ç€åªæœ‰å¯¹è±¡çš„é¡¶å±‚å±æ€§æ˜¯åªè¯»çš„ã€‚å¦‚æœå¯¹è±¡åŒ…å«åµŒå¥—å¯¹è±¡ï¼Œé‚£ä¹ˆè¿™äº›åµŒå¥—å¯¹è±¡çš„å±æ€§æ˜¯å¯ä»¥ä¿®æ”¹çš„ã€‚</p><pre><code class="language-javascript">let obj = &#123;  innerObj: &#123;    key: 'value'  &#125;&#125;let readonlyObj = Vue.readonly(obj);readonlyObj.innerObj.key = 'new value'; // è¿™å°†å¤±è´¥ï¼Œå› ä¸ºå¯¹è±¡æ˜¯åªè¯»çš„let shallowReadonlyObj = Vue.shallowReadonly(obj);shallowReadonlyObj.innerObj.key = 'new value'; // è¿™å°†æˆåŠŸï¼Œå› ä¸ºåªæœ‰é¡¶å±‚å±æ€§æ˜¯åªè¯»çš„</code></pre>]]></content>
    
    
      
      
    <summary type="html">&lt;h2&gt;&lt;span id=&quot;å‰è¨€&quot;&gt;å‰è¨€&lt;/span&gt;&lt;/h2&gt;
&lt;p&gt;ä»‹ç» reactive ä¸ shallowReactive çš„åŒºåˆ«ï¼Œå³æ·±å“åº”å’Œæµ…å“åº”çš„åŒºåˆ«ã€‚&lt;/p&gt;
&lt;h2&gt;&lt;span id=&quot;æµ…å“åº”å¼ä¸æ·±ç›¸åº”å¼&quot;&gt;æµ…å“åº”å¼ä¸æ·±ç›¸åº”å¼&lt;/span&gt;&lt;/h2&gt;
&lt;pre c</summary>
      
    
    
    
    <category term="Vue" scheme="https://ikkkp.github.io/categories/Vue/"/>
    
    
    <category term="Vue" scheme="https://ikkkp.github.io/tags/Vue/"/>
    
  </entry>
  
  <entry>
    <title>Vue Shallow Reactivity vs Deep Reactivity</title>
    <link href="https://ikkkp.github.io/2023/11/01/en/vue-reactive-shallowReactive/"/>
    <id>https://ikkkp.github.io/2023/11/01/en/vue-reactive-shallowReactive/</id>
    <published>2023-11-01T11:29:41.000Z</published>
    <updated>2023-11-03T14:08:53.112Z</updated>
    
    <content type="html"><![CDATA[<h2><span id="introduction">Introduction</span></h2><p>Explore the differences between <code>reactive</code> and <code>shallowReactive</code>, delving into the concepts of deep reactivity and shallow reactivity in Vue.js.</p><h2><span id="shallow-reactivity-vs-deep-reactivity">Shallow Reactivity vs Deep Reactivity</span></h2><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">bar</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span><span class="token punctuation">&#123;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>foo<span class="token punctuation">.</span>bar<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token comment">// Modifying obj.foo.bar value does not trigger reactivity</span>obj<span class="token punctuation">.</span>foo<span class="token punctuation">.</span>bar <span class="token operator">=</span> <span class="token number">2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Initially, an object <code>obj</code> is created with a property <code>foo</code> containing another object <code>&#123; bar: 1 &#125;</code>. When accessing <code>obj.foo.bar</code> inside an effect function, it is noticed that modifying <code>obj.foo.bar</code> does not trigger the effect function again. Why does this happen? Letâ€™s take a look at the current implementation:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>obj <span class="token punctuation">,</span><span class="token punctuation">&#123;</span>    <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> <span class="token string">'raw'</span><span class="token punctuation">)</span>         <span class="token keyword">return</span> target<span class="token punctuation">;</span>    <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// When reading the property value, return it directly</span>    <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">// Other trapping functions are omitted</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>In the given code, when accessing <code>obj.foo.bar</code>, it first reads the value of <code>obj.foo</code>. Here, <code>Reflect.get</code> is used to directly return the result of <code>obj.foo</code>. Since the result obtained through <code>Reflect.get</code> is a plain object, namely <code>&#123; bar: 1 &#125;</code>, it is not a reactive object. Therefore, when accessing <code>obj.foo.bar</code> inside the effect function, no reactivity is established. To address this, the result returned by <code>Reflect.get</code> needs to be wrapped:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>    <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">const</span> result <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// If the result is an object, make it reactive</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> result <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token function">reactive</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>      <span class="token keyword">return</span> result<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token comment">// Other traps...</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>In this code snippet, the <code>reactive</code> function is defined. It takes an object as a parameter and returns a proxy of that object. The proxy uses a <code>get</code> trap function that triggers when accessing a property of the object. In the <code>get</code> trap, <code>Reflect.get</code> is used to retrieve the property value. If the result is an object, it is made reactive by calling the <code>reactive</code> function recursively. This ensures that nested objects also possess reactive properties, allowing modifications to trigger the reactivity system.</p><h2><span id="shallow-reactivity">Shallow Reactivity</span></h2><p>However, there are scenarios where deep reactivity is not desired, leading to the concept of <code>shallowReactive</code> or shallow reactivity. Shallow reactivity means that only the top-level properties of an object are reactive. For example:</p><p>Suppose we have an object with a nested object as its property:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token literal-property property">innerObj</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>    <span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token string">'value'</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>If we apply deep reactivity to <code>obj</code>:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">let</span> reactiveObj <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>Any modifications to <code>obj</code> or <code>innerObj</code> properties will trigger the reactivity system:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">reactiveObj<span class="token punctuation">.</span>innerObj<span class="token punctuation">.</span>key <span class="token operator">=</span> <span class="token string">'new value'</span><span class="token punctuation">;</span> <span class="token comment">// Triggers reactivity</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>However, if we want only the top-level properties of <code>obj</code> to be reactive, meaning modifications to <code>obj</code> trigger reactivity but modifications to <code>innerObj</code> do not, we use the <code>shallowReactive</code> function:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">let</span> shallowReactiveObj <span class="token operator">=</span> <span class="token function">shallowReactive</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>With <code>shallowReactive</code>, only modifications to <code>obj</code> will trigger reactivity:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">shallowReactiveObj<span class="token punctuation">.</span>innerObj <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span class="token comment">// Triggers reactivity</span>shallowReactiveObj<span class="token punctuation">.</span>innerObj<span class="token punctuation">.</span>key <span class="token operator">=</span> <span class="token string">'new value'</span><span class="token punctuation">;</span> <span class="token comment">// Does not trigger reactivity</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2><span id="vuejs-and-reactive-vs-shallowreactive">Vue.js and <code>reactive</code> vs <code>shallowReactive</code></span></h2><p>In Vue.js, both <code>reactive</code> and <code>shallowReactive</code> functions are used to create reactive objects. Letâ€™s explore their differences.</p><p>The <code>reactive</code> function creates deeply reactive objects. This means that both the object itself and all its nested objects become reactive. Any modifications to the object or its nested objectsâ€™ properties will trigger the reactivity system.</p><p>On the other hand, the <code>shallowReactive</code> function creates shallowly reactive objects. This means that only the top-level properties of the object are reactive. If the object contains nested objects, modifications to those nested objectsâ€™ properties will not trigger the reactivity system.</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token literal-property property">innerObj</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>    <span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token string">'value'</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>let reactiveObj = Vue.reactive(obj);<br>reactiveObj.innerObj.key = â€˜new valueâ€™; // Triggers reactivity</p><p>let shallowReactiveObj = Vue.shallowReactive(obj);<br>shallowReactiveObj.innerObj.key = â€˜new valueâ€™; // Does not trigger reactivity</p><h2><span id="readonly-and-shallow-readonly">Readonly and Shallow Readonly</span></h2><p>After discussing reactivity and shallow reactivity, letâ€™s talk about readonly and shallow readonly:</p><p>Vue.js provides <code>readonly</code> and <code>shallowReadonly</code> functions to create readonly reactive objects.</p><p>The <code>readonly</code> function creates deeply readonly reactive objects. This means that both the object itself and all its nested objects are readonly. Any attempts to modify the object or its nested objectsâ€™ properties will fail.</p><p>The <code>shallowReadonly</code> function creates shallow readonly reactive objects. This means that only the top-level properties of the object are readonly. If the object contains nested objects, properties of these nested objects can be modified.</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token literal-property property">innerObj</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>    <span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token string">'value'</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">let</span> readonlyObj <span class="token operator">=</span> Vue<span class="token punctuation">.</span><span class="token function">readonly</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>readonlyObj<span class="token punctuation">.</span>innerObj<span class="token punctuation">.</span>key <span class="token operator">=</span> <span class="token string">'new value'</span><span class="token punctuation">;</span> <span class="token comment">// This will fail because the object is readonly</span><span class="token keyword">let</span> shallowReadonlyObj <span class="token operator">=</span> Vue<span class="token punctuation">.</span><span class="token function">shallowReadonly</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>shallowReadonlyObj<span class="token punctuation">.</span>innerObj<span class="token punctuation">.</span>key <span class="token operator">=</span> <span class="token string">'new value'</span><span class="token punctuation">;</span> <span class="token comment">// This will succeed because only top-level properties are readonly</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><p><em>Note: This article is a translated version of the original post. For the most accurate and up-to-date information, please refer to the original source.</em></p><pre><code></code></pre>]]></content>
    
    
      
      
    <summary type="html">&lt;h2&gt;&lt;span id=&quot;introduction&quot;&gt;Introduction&lt;/span&gt;&lt;/h2&gt;
&lt;p&gt;Explore the differences between &lt;code&gt;reactive&lt;/code&gt; and &lt;code&gt;shallowReactive&lt;/cod</summary>
      
    
    
    
    <category term="Vue" scheme="https://ikkkp.github.io/categories/Vue/"/>
    
    
    <category term="Vue" scheme="https://ikkkp.github.io/tags/Vue/"/>
    
  </entry>
  
  <entry>
    <title>vue-Proxyå’ŒReflect</title>
    <link href="https://ikkkp.github.io/2023/11/01/vue-Proxy-and-Reflect/"/>
    <id>https://ikkkp.github.io/2023/11/01/vue-Proxy-and-Reflect/</id>
    <published>2023-11-01T02:52:27.000Z</published>
    <updated>2023-11-04T02:31:43.533Z</updated>
    
    <content type="html"><![CDATA[<h2><span id="å¼•è¨€">å¼•è¨€</span></h2><p>æ—¢ç„¶ Vue.js 3 çš„å“åº”å¼æ•°æ®æ˜¯åŸºäº Proxy å®ç°çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±æœ‰å¿…è¦äº†è§£ Proxy ä»¥åŠä¸ä¹‹ç›¸å…³è”çš„ Reflectã€‚ä»€ä¹ˆæ˜¯ Proxy å‘¢ï¼Ÿç®€å•åœ°è¯´ï¼Œä½¿ç”¨ Proxy å¯ä»¥åˆ›å»ºä¸€ä¸ªä»£ç†å¯¹è±¡ã€‚å®ƒèƒ½å¤Ÿå®ç°å¯¹å…¶ä»–å¯¹è±¡çš„ä»£ç†ï¼Œè¿™é‡Œçš„å…³é”®è¯æ˜¯å…¶ä»–å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼ŒProxy åªèƒ½ä»£ç†å¯¹è±¡ï¼Œæ— æ³•ä»£ç†éå¯¹è±¡å€¼ï¼Œä¾‹å¦‚å­—ç¬¦ä¸²ã€å¸ƒå°”å€¼ç­‰ã€‚é‚£ä¹ˆï¼Œä»£ç†æŒ‡çš„æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿæ‰€è°“ä»£ç†ï¼ŒæŒ‡çš„æ˜¯å¯¹ä¸€ä¸ªå¯¹è±¡åŸºæœ¬è¯­ä¹‰çš„ä»£ç†ã€‚å®ƒå…è®¸æˆ‘ä»¬æ‹¦æˆªå¹¶é‡æ–°å®šä¹‰å¯¹ä¸€ä¸ªå¯¹è±¡çš„åŸºæœ¬æ“ä½œã€‚</p><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy">åˆ›å»ºå¯¹è±¡ä»£ç† Proxy</a></p><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Reflect">å†…ç½®çš„å¯¹è±¡ Reflect</a></p><p>å½“æˆ‘ä»¬è®¨è®ºç¼–ç¨‹è¯­è¨€ä¸­çš„&quot;åŸºæœ¬è¯­ä¹‰&quot;æ—¶ï¼Œæˆ‘ä»¬æŒ‡çš„æ˜¯å¯¹æ•°æ®è¿›è¡Œè¯»å–å’Œä¿®æ”¹çš„æœ€åŸºæœ¬æ“ä½œã€‚åœ¨JavaScriptä¸­ï¼Œè¿™äº›æ“ä½œé€šå¸¸åŒ…æ‹¬è¯»å–å±æ€§å€¼å’Œè®¾ç½®å±æ€§å€¼ã€‚ä¾‹å¦‚ï¼Œåœ¨ç»™å®šä¸€ä¸ªå¯¹è±¡<code>obj</code>çš„æƒ…å†µä¸‹ï¼Œä»¥ä¸‹æ“ä½œè¢«è®¤ä¸ºæ˜¯åŸºæœ¬è¯­ä¹‰çš„æ“ä½œï¼š</p><ol><li>è¯»å–å±æ€§å€¼ï¼š<code>obj.foo</code> ï¼ˆè¯»å–å±æ€§<code>foo</code>çš„å€¼ï¼‰</li><li>è®¾ç½®å±æ€§å€¼ï¼š<code>obj.foo = newValue</code> ï¼ˆè®¾ç½®å±æ€§<code>foo</code>çš„å€¼ï¼‰</li></ol><p>åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œ<code>Proxy</code>å¯¹è±¡å…è®¸æˆ‘ä»¬æ‹¦æˆªï¼ˆæˆ–è€…è¯´é‡å®šä¹‰ï¼‰è¿™äº›åŸºæœ¬è¯­ä¹‰çš„æ“ä½œã€‚<code>Proxy</code>çš„æ„é€ å‡½æ•°æ¥å—ä¸¤ä¸ªå‚æ•°ï¼šè¢«ä»£ç†çš„å¯¹è±¡å’Œä¸€ä¸ªåŒ…å«æ‹¦æˆªå™¨ï¼ˆä¹Ÿç§°ä¸ºå¤¹å­æˆ–é™·é˜±ï¼‰çš„å¯¹è±¡ã€‚åœ¨æ‹¦æˆªå™¨å¯¹è±¡ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰<code>get</code>æ–¹æ³•æ¥æ‹¦æˆªè¯»å–å±æ€§æ“ä½œï¼Œå®šä¹‰<code>set</code>æ–¹æ³•æ¥æ‹¦æˆªè®¾ç½®å±æ€§æ“ä½œã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨è¿™äº›æ“ä½œå‘ç”Ÿæ—¶æ‰§è¡Œè‡ªå®šä¹‰çš„é€»è¾‘ã€‚</p><p>å…³äº<code>Reflect</code>å¯¹è±¡ï¼Œå®ƒæ˜¯JavaScriptçš„ä¸€ä¸ªå…¨å±€å¯¹è±¡ï¼Œæä¾›äº†ä¸<code>Proxy</code>æ‹¦æˆªå™¨æ–¹æ³•ä¸€ä¸€å¯¹åº”çš„æ–¹æ³•ã€‚è¿™äº›<code>Reflect</code>æ–¹æ³•æä¾›äº†é»˜è®¤çš„æ“ä½œè¡Œä¸ºã€‚ä¾‹å¦‚ï¼Œ<code>Reflect.get(target, key)</code>æ–¹æ³•æä¾›äº†è®¿é—®å¯¹è±¡å±æ€§çš„é»˜è®¤è¡Œä¸ºï¼Œä¸ç›´æ¥ä½¿ç”¨<code>target[key]</code>æ˜¯ç­‰ä»·çš„ã€‚åŒæ—¶ï¼Œ<code>Reflect</code>æ–¹æ³•è¿˜å¯ä»¥æ¥å—ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œç”¨æ¥æŒ‡å®šå‡½æ•°è°ƒç”¨æ—¶çš„<code>this</code>å€¼ã€‚</p><p>ç†è§£è¿™äº›åŸºæœ¬è¯­ä¹‰æ“ä½œä»¥åŠå¦‚ä½•ä½¿ç”¨<code>Proxy</code>å’Œ<code>Reflect</code>æ¥æ‹¦æˆªå’Œå¤„ç†è¿™äº›æ“ä½œï¼Œæ˜¯ç†è§£JavaScriptä¸­å“åº”å¼æ•°æ®ï¼ˆReactive Dataï¼‰å®ç°çš„å…³é”®ã€‚åœ¨å“åº”å¼æ•°æ®ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨<code>Proxy</code>å’Œ<code>Reflect</code>æ¥è¿½è¸ªå¯¹è±¡å±æ€§çš„è¯»å–å’Œä¿®æ”¹ï¼Œä»è€Œå®ç°æ•°æ®çš„å“åº”å¼æ›´æ–°ã€‚</p><h2><span id="proxy-çš„åŸºæœ¬ç”¨æ³•">Proxy çš„åŸºæœ¬ç”¨æ³•</span></h2><p>å½“æˆ‘ä»¬è°ˆè®ºåŸºæœ¬è¯­ä¹‰æ—¶ï¼Œæˆ‘ä»¬æŒ‡çš„æ˜¯ JavaScript ä¸­çš„ä¸€äº›åŸºæœ¬æ“ä½œï¼Œæ¯”å¦‚è¯»å–å¯¹è±¡å±æ€§å€¼å’Œè®¾ç½®å¯¹è±¡å±æ€§å€¼ã€‚è€ƒè™‘ä¸‹é¢çš„å¯¹è±¡ <code>obj</code>ï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>åœ¨è¿™é‡Œï¼Œ<code>obj.foo</code> æ˜¯ä¸€ä¸ªè¯»å–å±æ€§çš„åŸºæœ¬è¯­ä¹‰æ“ä½œï¼Œ<code>obj.foo = newValue</code> æ˜¯ä¸€ä¸ªè®¾ç½®å±æ€§çš„åŸºæœ¬è¯­ä¹‰æ“ä½œã€‚</p><p>ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>Proxy</code> æ¥æ‹¦æˆªè¿™äº›åŸºæœ¬è¯­ä¹‰çš„æ“ä½œã€‚</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> handler <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">è¯»å–å±æ€§ </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>key<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">è®¾ç½®å±æ€§ </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>key<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> ä¸º </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>value<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>    target<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">const</span> proxyObj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>proxyObj<span class="token punctuation">.</span>foo<span class="token punctuation">;</span> <span class="token comment">// è¾“å‡ºï¼šè¯»å–å±æ€§ foo</span>proxyObj<span class="token punctuation">.</span>foo <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// è¾“å‡ºï¼šè®¾ç½®å±æ€§ foo ä¸º 2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ª <code>handler</code> å¯¹è±¡ï¼Œå…¶ä¸­å®šä¹‰äº† <code>get</code> å’Œ <code>set</code> æ–¹æ³•ï¼Œç”¨æ¥æ‹¦æˆªå±æ€§çš„è¯»å–å’Œè®¾ç½®ã€‚ç„¶åï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>Proxy</code> æ„é€ å‡½æ•°åˆ›å»ºäº†ä¸€ä¸ªä»£ç†å¯¹è±¡ <code>proxyObj</code>ï¼Œå®ƒä¼šæ‹¦æˆª <code>obj</code> å¯¹è±¡ä¸Šçš„è¯»å–å’Œè®¾ç½®æ“ä½œã€‚å½“æˆ‘ä»¬è®¿é—® <code>proxyObj.foo</code> æ—¶ï¼Œä¼šè§¦å‘ <code>get</code> æ–¹æ³•ï¼Œè¾“å‡ºç›¸åº”çš„ä¿¡æ¯ã€‚å½“æˆ‘ä»¬è®¾ç½® <code>proxyObj.foo</code> çš„å€¼æ—¶ï¼Œä¼šè§¦å‘ <code>set</code> æ–¹æ³•ï¼ŒåŒæ ·è¾“å‡ºç›¸åº”çš„ä¿¡æ¯ã€‚</p><p>è¿™æ ·ï¼Œ<code>Proxy</code> å…è®¸æˆ‘ä»¬åœ¨åŸºæœ¬è¯­ä¹‰æ“ä½œå‘ç”Ÿæ—¶æ‰§è¡Œè‡ªå®šä¹‰çš„é€»è¾‘ï¼Œè€Œä¸éœ€è¦ç›´æ¥æ“ä½œåŸå§‹å¯¹è±¡ã€‚åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™ç§èƒ½åŠ›å¯ä»¥ç”¨æ¥å®ç°å“åº”å¼æ•°æ®ã€æ•°æ®éªŒè¯ã€æ—¥å¿—è®°å½•ç­‰åŠŸèƒ½ã€‚</p><p>å½“æˆ‘ä»¬ä½¿ç”¨ <code>Proxy</code> æ‹¦æˆªå¯¹è±¡å±æ€§çš„è¯»å–æ“ä½œæ—¶ï¼Œæˆ‘ä»¬éœ€è¦ç‰¹åˆ«æ³¨æ„è®¿é—®å™¨å±æ€§ï¼ˆaccessor propertiesï¼‰çš„æƒ…å†µï¼Œå› ä¸ºè®¿é—®å™¨å±æ€§ä½¿ç”¨ getter å‡½æ•°æ¥å®šä¹‰ï¼Œè€Œè¿™ä¸ªå‡½æ•°å†…éƒ¨çš„ <code>this</code> å…³é”®å­—ä¼šæ ¹æ®è°ƒç”¨æ–¹å¼è€Œå˜åŒ–ã€‚</p><h2><span id="reflect-åœ¨å“åº”å¼ä¸­çš„ç”¨æ³•">Reflect åœ¨å“åº”å¼ä¸­çš„ç”¨æ³•</span></h2><p>åœ¨æ‹¦æˆªå™¨å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å¸Œæœ›å»ºç«‹å‰¯ä½œç”¨å‡½æ•°ä¸å“åº”å¼æ•°æ®ä¹‹é—´çš„å…³è”ï¼Œç¡®ä¿å½“å±æ€§è¢«è®¿é—®æ—¶ï¼Œèƒ½å¤Ÿæ­£ç¡®åœ°è¿›è¡Œä¾èµ–æ”¶é›†ï¼Œä»¥ä¾¿åœ¨å±æ€§å‘ç”Ÿå˜åŒ–æ—¶è§¦å‘å‰¯ä½œç”¨å‡½æ•°çš„é‡æ–°æ‰§è¡Œã€‚ç„¶è€Œï¼Œå¦‚æœæˆ‘ä»¬ç›´æ¥ä½¿ç”¨ <code>target[key]</code> æ¥è·å–å±æ€§å€¼ï¼Œé‚£ä¹ˆè®¿é—®å™¨å±æ€§å†…éƒ¨çš„ <code>this</code> å…³é”®å­—å°†æŒ‡å‘åŸå§‹å¯¹è±¡ï¼Œè€Œä¸æ˜¯ä»£ç†å¯¹è±¡ï¼Œè¿™ä¼šå¯¼è‡´æ— æ³•æ­£ç¡®å»ºç«‹å“åº”å…³ç³»ã€‚</p><p>è§£å†³è¿™ä¸ªé—®é¢˜çš„æ–¹æ³•æ˜¯ä½¿ç”¨ <code>Reflect.get(target, key, receiver)</code> æ¥ä»£æ›¿ <code>target[key]</code>ã€‚è¿™æ ·ï¼Œ<code>Reflect.get</code> çš„ç¬¬ä¸‰ä¸ªå‚æ•° <code>receiver</code> å°±èƒ½æ­£ç¡®åœ°æŒ‡å‘ä»£ç†å¯¹è±¡ï¼Œè€Œä¸æ˜¯åŸå§‹å¯¹è±¡ã€‚è¿™æ ·ä¸€æ¥ï¼Œåœ¨è®¿é—®å™¨å±æ€§çš„ getter å‡½æ•°å†…éƒ¨ï¼Œ<code>this</code> å…³é”®å­—å°±ä¼šæŒ‡å‘ä»£ç†å¯¹è±¡ï¼Œä»è€Œå»ºç«‹äº†æ­£ç¡®çš„å“åº”å…³ç³»ã€‚</p><p>ä»¥ä¸‹æ˜¯ä½¿ç”¨ <code>Reflect.get</code> çš„ä¿®æ­£ä»£ç ï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> handler <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å“åº”å¼æ•°æ®ä¾èµ–æ”¶é›†</span>    <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ä½¿ç”¨ Reflect.get è·å–å±æ€§å€¼</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token comment">// å…¶ä»–æ‹¦æˆªå™¨æ–¹æ³•...</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">const</span> proxyObj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>proxyObj<span class="token punctuation">.</span>bar<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// åœ¨å‰¯ä½œç”¨å‡½æ•°å†…éƒ¨è®¿é—® bar å±æ€§</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>proxyObj<span class="token punctuation">.</span>foo<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token comment">// è§¦å‘å‰¯ä½œç”¨å‡½æ•°çš„é‡æ–°æ‰§è¡Œ</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æˆ‘ä»¬å¯ä»¥å†çœ‹ä¸€ä¸ªç®€å•ä¸€ç‚¹çš„ç¤ºä¾‹ï¼š</p><p>å½“ä½¿ç”¨ä»£ç†å¯¹è±¡æ—¶ï¼Œ<code>receiver</code>å‚æ•°ä¸»è¦ç”¨äºç¡®ä¿åœ¨ä»£ç†çš„æ‹¦æˆªå‡½æ•°å†…éƒ¨ï¼Œ<code>this</code>æŒ‡å‘ä»£ç†å¯¹è±¡ï¼Œä»è€Œå»ºç«‹å“åº”å¼è”ç³»ã€‚ä¸‹é¢æˆ‘å°†å¯¹æ¯”ä½¿ç”¨<code>receiver</code>å‚æ•°å’Œä¸ä½¿ç”¨çš„æƒ…å†µï¼Œä»¥ä¾¿æ›´æ¸…æ¥šåœ°ç†è§£å®ƒçš„ä½œç”¨ã€‚</p><h3><span id="1-ä½¿ç”¨receiverå‚æ•°çš„æƒ…å†µ">1. ä½¿ç”¨<code>receiver</code>å‚æ•°çš„æƒ…å†µï¼š</span></h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">const</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>  <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// ä½¿ç”¨ Reflect.get ä¿è¯ this æŒ‡å‘ä»£ç†å¯¹è±¡</span>    <span class="token keyword">const</span> result <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// åœ¨å®é™…åº”ç”¨ä¸­ï¼Œä½ å¯èƒ½è¿˜éœ€è¦è¿›è¡Œå…¶ä»–å¤„ç†ï¼Œä¾‹å¦‚è§¦å‘æ›´æ–°æ“ä½œç­‰</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Accessed </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>key<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> property with value </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>result<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> result<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>proxy<span class="token punctuation">.</span>foo<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// è¾“å‡º: Accessed foo property with value 1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†<code>receiver</code>å‚æ•°ä¼ é€’ç»™<code>Reflect.get</code>ï¼Œç¡®ä¿åœ¨<code>get</code>æ‹¦æˆªå‡½æ•°å†…éƒ¨ï¼Œ<code>this</code>æŒ‡å‘ä»£ç†å¯¹è±¡<code>proxy</code>ã€‚å½“ä½ è®¿é—®<code>proxy.foo</code>æ—¶ï¼Œ<code>get</code>æ‹¦æˆªå‡½æ•°è¢«è§¦å‘ï¼Œå¹¶ä¸”<code>this</code>æŒ‡å‘<code>proxy</code>å¯¹è±¡ã€‚</p><h3><span id="2-ä¸ä½¿ç”¨receiverå‚æ•°çš„æƒ…å†µ">2. ä¸ä½¿ç”¨<code>receiver</code>å‚æ•°çš„æƒ…å†µï¼š</span></h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">const</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>  <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// ä¸ä½¿ç”¨ receiver å‚æ•°ï¼Œthis æŒ‡å‘åŸå§‹å¯¹è±¡ data</span>        <span class="token keyword">const</span> result <span class="token operator">=</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token comment">// åœ¨å®é™…åº”ç”¨ä¸­ï¼Œä½ å¯èƒ½è¿˜éœ€è¦è¿›è¡Œå…¶ä»–å¤„ç†ï¼Œä¾‹å¦‚è§¦å‘æ›´æ–°æ“ä½œç­‰</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Accessed </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>key<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> property with value </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>result<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> result<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>proxy<span class="token punctuation">.</span>foo<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// è¾“å‡º: Accessed foo property with value 1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬æ²¡æœ‰ä½¿ç”¨<code>receiver</code>å‚æ•°ã€‚ç”±äºæ²¡æœ‰ä¼ é€’<code>receiver</code>å‚æ•°ï¼Œ<code>this</code>åœ¨<code>get</code>æ‹¦æˆªå‡½æ•°å†…éƒ¨æŒ‡å‘çš„æ˜¯åŸå§‹å¯¹è±¡<code>data</code>ã€‚è™½ç„¶ä»£ç†å¯¹è±¡<code>proxy</code>è¢«ä½¿ç”¨ï¼Œä½†<code>get</code>æ‹¦æˆªå‡½æ•°å†…éƒ¨çš„<code>this</code>å¹¶ä¸æŒ‡å‘<code>proxy</code>ï¼Œè€Œæ˜¯æŒ‡å‘åŸå§‹å¯¹è±¡<code>data</code>ã€‚å› æ­¤ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œå“åº”å¼è”ç³»ä¸ä¼šå¾—åˆ°å»ºç«‹ã€‚</p><p>è™½ç„¶è¯´ä¸¤ä¸ªå‡½æ•°çš„è¾“å‡ºæ˜¯ä¸€è‡´çš„ï¼Œä½†æ˜¾ç„¶æ²¡æœ‰ä½¿ç”¨<code>receiver</code>å‚æ•°æ—¶å“åº”å¼è”ç³»ä¸ä¼šå¾—åˆ°å»ºç«‹ã€‚ä¹Ÿå°±æ˜¯è¯´åœ¨effectå‡½æ•°é‡Œé¢ï¼Œå¯¹è±¡ä¸ä¼šå¾—åˆ°æ­£ç¡®çš„å“åº”ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2&gt;&lt;span id=&quot;å¼•è¨€&quot;&gt;å¼•è¨€&lt;/span&gt;&lt;/h2&gt;
&lt;p&gt;æ—¢ç„¶ Vue.js 3 çš„å“åº”å¼æ•°æ®æ˜¯åŸºäº Proxy å®ç°çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±æœ‰å¿…è¦äº†è§£ Proxy ä»¥åŠä¸ä¹‹ç›¸å…³è”çš„ Reflectã€‚ä»€ä¹ˆæ˜¯ Proxy å‘¢ï¼Ÿç®€å•åœ°è¯´ï¼Œä½¿ç”¨ Proxy å¯ä»¥åˆ›å»ºä¸€ä¸ªä»£ç†å¯¹è±¡ã€‚å®ƒ</summary>
      
    
    
    
    <category term="Vue" scheme="https://ikkkp.github.io/categories/Vue/"/>
    
    
    <category term="Vue" scheme="https://ikkkp.github.io/tags/Vue/"/>
    
  </entry>
  
  <entry>
    <title>Vue Proxy and Reflect</title>
    <link href="https://ikkkp.github.io/2023/11/01/en/vue-Proxy-and-Reflect/"/>
    <id>https://ikkkp.github.io/2023/11/01/en/vue-Proxy-and-Reflect/</id>
    <published>2023-11-01T02:52:27.000Z</published>
    <updated>2023-11-03T14:08:50.806Z</updated>
    
    <content type="html"><![CDATA[<h2><span id="introduction">Introduction</span></h2><p>Since Vue.js 3â€™s reactive data is based on Proxy, itâ€™s essential to understand Proxy and its associated concept, Reflect. What is Proxy? In simple terms, Proxy allows you to create a proxy object. It can proxy other objects, emphasizing that Proxy can only proxy objects and not non-object values like strings, booleans, etc. So, what does proxying mean? Proxying refers to the act of creating a basic semantic representation of an object. It allows us to intercept and redefine the basic operations on an object.</p><p><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Proxy">Create object proxies with Proxy</a></p><p><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Reflect">Built-in object Reflect</a></p><p>When we talk about â€œbasic semanticsâ€ in programming languages, we mean the fundamental operations for reading and modifying data. In JavaScript, these operations typically include reading property values and setting property values. For example, given an object <code>obj</code>, the following operations are considered basic semantics:</p><ol><li>Read property value: <code>obj.foo</code> (reads the value of property <code>foo</code>)</li><li>Set property value: <code>obj.foo = newValue</code> (sets the value of property <code>foo</code>)</li></ol><p>In the above code, <code>Proxy</code> objects allow us to intercept (or redefine) these basic semantic operations. The <code>Proxy</code> constructor takes two parameters: the object being proxied and an object containing interceptors (also known as traps). In the interceptor object, we can define the <code>get</code> method to intercept property read operations and the <code>set</code> method to intercept property set operations. This way, we can execute custom logic when these operations occur.</p><p>Understanding these basic semantic operations and how to use <code>Proxy</code> and <code>Reflect</code> to intercept and handle them is crucial for implementing reactive data in JavaScript. In reactive data, we can use <code>Proxy</code> and <code>Reflect</code> to track reads and modifications of object properties, enabling reactive updates of data.</p><h2><span id="basic-usage-of-proxy">Basic Usage of Proxy</span></h2><p>When we talk about basic semantics, we refer to fundamental operations in JavaScript, such as reading object property values and setting object property values. Consider the following object <code>obj</code>:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>Here, <code>obj.foo</code> is a basic semantic operation for reading property values, and <code>obj.foo = newValue</code> is a basic semantic operation for setting property values.</p><p>Now, we can use <code>Proxy</code> to intercept these basic semantic operations.</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> handler <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Reading property </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>key<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Setting property </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>key<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> to </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>value<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>    target<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">const</span> proxyObj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>proxyObj<span class="token punctuation">.</span>foo<span class="token punctuation">;</span> <span class="token comment">// Outputs: Reading property foo</span>proxyObj<span class="token punctuation">.</span>foo <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// Outputs: Setting property foo to 2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>In the above code, we created a <code>handler</code> object that defines <code>get</code> and <code>set</code> methods to intercept property reads and sets. Then, we created a proxy object <code>proxyObj</code> using the <code>Proxy</code> constructor, which intercepts read and set operations on the <code>obj</code> object. When we access <code>proxyObj.foo</code>, the <code>get</code> method is triggered, outputting the corresponding message. When we set the value of <code>proxyObj.foo</code>, the <code>set</code> method is triggered, again outputting the corresponding message.</p><p>This way, <code>Proxy</code> allows us to execute custom logic when basic semantic operations occur, without directly manipulating the original object. In practical applications, this capability can be used to implement reactive data, data validation, logging, and more.</p><p>When intercepting object property reads with <code>Proxy</code>, special attention is required for accessor properties because accessor properties are defined using getter functions. The <code>this</code> keyword inside these getter functions changes based on the method of invocation.</p><p>To solve this issue, we use <code>Reflect.get(target, key, receiver)</code> instead of <code>target[key]</code> when accessing property values. This ensures that the <code>receiver</code> parameter correctly points to the proxy object, not the original object. Consequently, within the getter function of accessor properties, the <code>this</code> keyword refers to the proxy object, establishing the correct reactive relationship.</p><p>Here is the corrected code using <code>Reflect.get</code>:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> handler <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Reactive data dependency tracking</span>    <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Use Reflect.get to get property value</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token comment">// Other interceptor methods...</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">const</span> proxyObj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>proxyObj<span class="token punctuation">.</span>bar<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Access the bar property inside the side effect function</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>proxyObj<span class="token punctuation">.</span>foo<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token comment">// Triggers re-execution of the side effect function</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>In this code, we use <code>Reflect.get</code> with the <code>receiver</code> parameter to ensure that <code>this</code> points to the proxy object within the <code>get</code> interceptor function. This establishes the correct reactive relationship, allowing proper dependency tracking when accessing object properties.</p><h2><span id="usage-of-reflect-in-reactivity">Usage of Reflect in Reactivity</span></h2><p>In interceptor functions, we aim to establish a connection between side-effect functions and reactive data. This ensures that when properties are accessed, the correct dependencies are tracked, enabling re-execution of side-effect functions when properties change. However, if we directly use <code>target[key]</code> to access property values, the <code>this</code> keyword inside the getter function of accessor properties points to the original object, not the proxy object. This prevents the establishment of the correct reactive relationship.</p><p>To address this issue, we use <code>Reflect.get(target, key, receiver)</code> instead of <code>target[key]</code>. By doing so, the <code>receiver</code> parameter correctly points to the proxy object, allowing the <code>this</code> keyword inside the getter function to refer to the proxy object. This establishes the proper reactive relationship.</p><p>Here is an example demonstrating the use of the <code>receiver</code> parameter and comparing it with the scenario where the <code>receiver</code> parameter is not used:</p><h3><span id="1-using-the-receiver-parameter">1. Using the <code>receiver</code> parameter:</span></h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">const</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>  <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// Use Reflect.get to ensure `this` points to the proxy object</span>    <span class="token keyword">const</span> result <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// Additional processing, such as triggering update operations, can be performed in practical applications</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Accessed </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>key<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> property with value </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>result<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> result<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>proxy<span class="token punctuation">.</span>foo<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Outputs: Accessed foo property with value 1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>In this example, we use the <code>receiver</code> parameter passed to <code>Reflect.get</code> to ensure that <code>this</code> inside the <code>get</code> interceptor function refers to the proxy object <code>proxy</code>. When you access <code>proxy.foo</code>, the <code>get</code> interceptor function is triggered, and <code>this</code> points to the <code>proxy</code> object.</p><h3><span id="2-not-using-the-receiver-parameter">2. Not using the <code>receiver</code> parameter:</span></h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">const</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>  <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// Without using the receiver parameter, 'this' refers to the original object 'data'</span>        <span class="token keyword">const</span> result <span class="token operator">=</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token comment">// In practical applications, additional processing might be required, such as triggering update operations</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Accessed </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>key<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> property with value </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>result<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> result<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>proxy<span class="token punctuation">.</span>foo<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Output: Accessed foo property with value 1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>In this example, we did not use the <code>receiver</code> parameter. Since the <code>receiver</code> parameter was not passed, <code>this</code> inside the <code>get</code> interceptor function points to the original object <code>data</code>. Although the proxy object <code>proxy</code> is used, the <code>this</code> inside the <code>get</code> interceptor function does not refer to <code>proxy</code> but instead refers to the original object <code>data</code>. Therefore, in this scenario, the reactive relationship is not established.</p><p>While the output of the two functions is the same, itâ€™s evident that without using the <code>receiver</code> parameter, the reactive relationship is not established. This means that within the <code>effect</code> function, the object will not receive the correct reactivity.</p><hr><p><em>Note: This article is a translated version of the original post. For the most accurate and up-to-date information, please refer to the original source.</em></p><pre><code></code></pre>]]></content>
    
    
      
      
    <summary type="html">&lt;h2&gt;&lt;span id=&quot;introduction&quot;&gt;Introduction&lt;/span&gt;&lt;/h2&gt;
&lt;p&gt;Since Vue.js 3â€™s reactive data is based on Proxy, itâ€™s essential to understand Proxy</summary>
      
    
    
    
    <category term="Vue" scheme="https://ikkkp.github.io/categories/Vue/"/>
    
    
    <category term="Vue" scheme="https://ikkkp.github.io/tags/Vue/"/>
    
  </entry>
  
  <entry>
    <title>vue-è¿‡æœŸçš„å‰¯ä½œç”¨å‡½æ•°</title>
    <link href="https://ikkkp.github.io/2023/11/01/vue-expired-side-effects/"/>
    <id>https://ikkkp.github.io/2023/11/01/vue-expired-side-effects/</id>
    <published>2023-10-31T16:13:47.000Z</published>
    <updated>2023-11-04T02:31:59.165Z</updated>
    
    <content type="html"><![CDATA[<h2><span id="å¼•è¨€">å¼•è¨€</span></h2><p>å½“æˆ‘ä»¬è®¨è®ºç«æ€é—®é¢˜æ—¶ï¼Œé€šå¸¸æŒ‡çš„æ˜¯åœ¨å¤šè¿›ç¨‹æˆ–å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­å‡ºç°çš„ä¸€ç§å¹¶å‘é—®é¢˜ã€‚ç„¶è€Œï¼Œåœ¨å‰ç«¯å¼€å‘ä¸­ï¼Œæˆ‘ä»¬å¯èƒ½è¾ƒå°‘ç›´æ¥é¢å¯¹å¤šçº¿ç¨‹ç¼–ç¨‹ï¼Œä½†æˆ‘ä»¬ç»å¸¸ä¼šé‡åˆ°ä¸ç«æ€é—®é¢˜ç›¸ä¼¼çš„æƒ…å¢ƒã€‚ä¸€ä¸ªå¸¸è§çš„ä¾‹å­æ˜¯åœ¨å¼‚æ­¥ç¼–ç¨‹ä¸­ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤„ç†å¼‚æ­¥äº‹ä»¶ã€å›è°ƒå‡½æ•°æˆ–è€…Promiseæ—¶ã€‚</p><p>ä¾‹å¦‚ï¼Œè€ƒè™‘ä»¥ä¸‹çš„å¼‚æ­¥ä»£ç ï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">let</span> data<span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">fetchData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    data <span class="token operator">=</span> <span class="token string">'Fetched data'</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">fetchData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// è¾“å‡º undefined</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ<code>fetchData</code> å‡½æ•°æ˜¯å¼‚æ­¥çš„ï¼Œå®ƒåœ¨1ç§’åå°†æ•°æ®èµ‹ç»™ <code>data</code> å˜é‡ã€‚ä½†æ˜¯ï¼Œç”±äº JavaScript æ˜¯å•çº¿ç¨‹çš„ï¼Œ<code>fetchData</code> å‡½æ•°ä¼šåœ¨ä¸»çº¿ç¨‹çš„äº‹ä»¶é˜Ÿåˆ—ä¸­ç­‰å¾…1ç§’ï¼Œè€Œåœ¨è¿™1ç§’å†…ï¼Œ<code>console.log(data)</code> è¯­å¥ä¼šç«‹å³æ‰§è¡Œï¼Œæ­¤æ—¶ <code>data</code> çš„å€¼ä¸º <code>undefined</code>ï¼Œå› ä¸º <code>fetchData</code> å‡½æ•°è¿˜æœªå®Œæˆæ‰§è¡Œã€‚</p><p>åœ¨å¼‚æ­¥ç¼–ç¨‹ä¸­ï¼Œç”±äºä»£ç çš„éé˜»å¡æ€§è´¨ï¼Œä¼šå‡ºç°ç±»ä¼¼çš„ç«æ€æ¡ä»¶é—®é¢˜ã€‚åœ¨å¤„ç†å¼‚æ­¥æ“ä½œæ—¶ï¼Œæˆ‘ä»¬éœ€è¦å°å¿ƒç¡®ä¿æ•°æ®çš„ä¸€è‡´æ€§å’Œæ­£ç¡®æ€§ï¼Œé¿å…åœ¨å¼‚æ­¥æ“ä½œå®Œæˆå‰å°±å»è®¿é—®æˆ–ä¿®æ”¹ç›¸å…³æ•°æ®ã€‚</p><h2><span id="ç«æ€é—®é¢˜ä¸å“åº”å¼">ç«æ€é—®é¢˜ä¸å“åº”å¼</span></h2><p>é‚£ä¹ˆç«æ€é—®é¢˜è·Ÿæˆ‘ä»¬å“åº”å¼æœ‰ä»€ä¹ˆè”ç³»å‘¢ï¼Ÿ</p><p>ä¸¾ä¸ªä¾‹å­ï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">let</span> finalData<span class="token function">watch</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span><span class="token comment">// å‘é€å¹¶ç­‰å¾…ç½‘ç»œè¯·æ±‚</span><span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/path/to/request'</span><span class="token punctuation">)</span><span class="token comment">// å°†è¯·æ±‚ç»“æœèµ‹å€¼ç»™ data</span>finalData <span class="token operator">=</span> res<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨è¿™æ®µä»£ç ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ watch è§‚æµ‹ obj å¯¹è±¡çš„å˜åŒ–ï¼Œæ¯æ¬¡ objå¯¹è±¡å‘ç”Ÿå˜åŒ–éƒ½ä¼šå‘é€ç½‘ç»œè¯·æ±‚ï¼Œä¾‹å¦‚è¯·æ±‚æ¥å£æ•°æ®ï¼Œç­‰æ•°æ®è¯·æ±‚æˆåŠŸä¹‹åï¼Œå°†ç»“æœèµ‹å€¼ç»™ finalData å˜é‡ã€‚è§‚å¯Ÿä¸Šé¢çš„ä»£ç ï¼Œä¹ä¸€çœ‹ä¼¼ä¹æ²¡ä»€ä¹ˆé—®é¢˜ã€‚ä½†ä»”ç»†æ€è€ƒä¼šå‘ç°è¿™æ®µä»£ç ä¼šå‘ç”Ÿç«æ€é—®é¢˜ã€‚å‡è®¾æˆ‘ä»¬ç¬¬ä¸€æ¬¡ä¿®æ”¹ obj å¯¹è±¡çš„æŸä¸ªå­—æ®µå€¼ï¼Œè¿™ä¼šå¯¼è‡´å›è°ƒå‡½æ•°æ‰§è¡Œï¼ŒåŒæ—¶å‘é€äº†ç¬¬ä¸€æ¬¡è¯·æ±‚ Aã€‚éšç€æ—¶é—´çš„æ¨ç§»ï¼Œåœ¨è¯·æ±‚ A çš„ç»“æœè¿”å›ä¹‹å‰ï¼Œæˆ‘ä»¬å¯¹ obj å¯¹è±¡çš„æŸä¸ªå­—æ®µå€¼è¿›è¡Œäº†ç¬¬äºŒæ¬¡ä¿®æ”¹ï¼Œè¿™ä¼šå¯¼è‡´å‘é€ç¬¬äºŒæ¬¡è¯·æ±‚ Bã€‚æ­¤æ—¶è¯·æ±‚ A å’Œè¯·æ±‚ B éƒ½åœ¨è¿›è¡Œä¸­ï¼Œé‚£ä¹ˆå“ªä¸€ä¸ªè¯·æ±‚ä¼šå…ˆè¿”å›ç»“æœå‘¢ï¼Ÿæˆ‘ä»¬ä¸ç¡®å®šï¼Œå¦‚æœè¯·æ±‚B å…ˆäºè¯·æ±‚ A è¿”å›ç»“æœï¼Œå°±ä¼šå¯¼è‡´æœ€ç»ˆ finalData ä¸­å­˜å‚¨çš„æ˜¯ A è¯·æ±‚çš„ç»“æœ</p><p><img src="/img/expired-side-sffect/expired-side-sffect.png" alt="å¯¹æ¯”"></p><p>ä½†ç”±äºè¯·æ±‚ B æ˜¯åå‘é€çš„ï¼Œå› æ­¤æˆ‘ä»¬è®¤ä¸ºè¯·æ±‚ B è¿”å›çš„æ•°æ®æ‰æ˜¯â€œæœ€æ–°â€çš„ï¼Œè€Œè¯·æ±‚ A åˆ™åº”è¯¥è¢«è§†ä¸ºâ€œè¿‡æœŸâ€çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¸Œæœ›å˜é‡finalData å­˜å‚¨çš„å€¼åº”è¯¥æ˜¯ç”±è¯·æ±‚ B è¿”å›çš„ç»“æœï¼Œè€Œéè¯·æ±‚ A è¿”å›çš„ç»“æœã€‚</p><p>å®é™…ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥å¯¹è¿™ä¸ªé—®é¢˜åšè¿›ä¸€æ­¥æ€»ç»“ã€‚è¯·æ±‚ A æ˜¯å‰¯ä½œç”¨å‡½æ•°ç¬¬ä¸€æ¬¡æ‰§è¡Œæ‰€äº§ç”Ÿçš„å‰¯ä½œç”¨ï¼Œè¯·æ±‚ B æ˜¯å‰¯ä½œç”¨å‡½æ•°ç¬¬äºŒæ¬¡æ‰§è¡Œæ‰€äº§ç”Ÿçš„å‰¯ä½œç”¨ã€‚ç”±äºè¯·æ±‚ B åå‘ç”Ÿï¼Œæ‰€ä»¥è¯·æ±‚ B çš„ç»“æœåº”è¯¥è¢«è§†ä¸ºâ€œæœ€æ–°â€çš„ï¼Œè€Œè¯·æ±‚ A å·²ç»â€œè¿‡æœŸâ€äº†ï¼Œå…¶äº§ç”Ÿçš„ç»“æœåº”è¢«è§†ä¸ºæ— æ•ˆã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œå°±å¯ä»¥é¿å…ç«æ€é—®é¢˜å¯¼è‡´çš„é”™è¯¯ç»“æœã€‚å½’æ ¹ç»“åº•ï¼Œæˆ‘ä»¬éœ€è¦çš„æ˜¯ä¸€ä¸ªè®©å‰¯ä½œç”¨è¿‡æœŸçš„æ‰‹æ®µã€‚ä¸ºäº†è®©é—®é¢˜æ›´åŠ æ¸…æ™°ï¼Œæˆ‘ä»¬å…ˆæ‹¿ Vue.js ä¸­çš„ watch å‡½æ•°æ¥å¤ç°åœºæ™¯ï¼Œçœ‹çœ‹ Vue.jsæ˜¯å¦‚ä½•å¸®åŠ©å¼€å‘è€…è§£å†³è¿™ä¸ªé—®é¢˜çš„ï¼Œç„¶åå°è¯•å®ç°è¿™ä¸ªåŠŸèƒ½ã€‚</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">watch</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">newValue<span class="token punctuation">,</span> oldValue<span class="token punctuation">,</span> onInvalidate</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  <span class="token comment">// å®šä¹‰ä¸€ä¸ªæ ‡å¿—ï¼Œä»£è¡¨å½“å‰å‰¯ä½œç”¨å‡½æ•°æ˜¯å¦è¿‡æœŸï¼Œé»˜è®¤ä¸º falseï¼Œä»£è¡¨æ²¡æœ‰è¿‡æœŸ</span>  <span class="token keyword">let</span> expired <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token comment">// è°ƒç”¨ onInvalidate() å‡½æ•°æ³¨å†Œä¸€ä¸ªè¿‡æœŸå›è°ƒ</span>  <span class="token function">onInvalidate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token comment">// å½“è¿‡æœŸæ—¶ï¼Œå°† expired è®¾ç½®ä¸º true</span>    expired <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// å‘é€ç½‘ç»œè¯·æ±‚</span>  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/path/to/request'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// åªæœ‰å½“è¯¥å‰¯ä½œç”¨å‡½æ•°çš„æ‰§è¡Œæ²¡æœ‰è¿‡æœŸæ—¶ï¼Œæ‰ä¼šæ‰§è¡Œåç»­æ“ä½œã€‚</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>expired<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    finalData <span class="token operator">=</span> res<span class="token punctuation">;</span>    <span class="token comment">// åç»­æ“ä½œ...</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¦‚ä¸Šé¢çš„ä»£ç æ‰€ç¤ºï¼Œåœ¨å‘é€è¯·æ±‚ä¹‹å‰ï¼Œæˆ‘ä»¬å®šä¹‰äº† expired æ ‡å¿—å˜é‡ï¼Œç”¨æ¥æ ‡è¯†å½“å‰å‰¯ä½œç”¨å‡½æ•°çš„æ‰§è¡Œæ˜¯å¦è¿‡æœŸï¼›æ¥ç€è°ƒç”¨onInvalidate å‡½æ•°æ³¨å†Œäº†ä¸€ä¸ªè¿‡æœŸå›è°ƒï¼Œå½“è¯¥å‰¯ä½œç”¨å‡½æ•°çš„æ‰§è¡Œè¿‡æœŸæ—¶å°† expired æ ‡å¿—å˜é‡è®¾ç½®ä¸º trueï¼›æœ€ååªæœ‰å½“æ²¡æœ‰è¿‡æœŸæ—¶æ‰é‡‡ç”¨è¯·æ±‚ç»“æœï¼Œè¿™æ ·å°±å¯ä»¥æœ‰æ•ˆåœ°é¿å…ä¸Šè¿°é—®é¢˜äº†ã€‚</p><p><img src="/img/expired-side-sffect/expired-side-sffect2.png" alt="å¯¹æ¯”"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2&gt;&lt;span id=&quot;å¼•è¨€&quot;&gt;å¼•è¨€&lt;/span&gt;&lt;/h2&gt;
&lt;p&gt;å½“æˆ‘ä»¬è®¨è®ºç«æ€é—®é¢˜æ—¶ï¼Œé€šå¸¸æŒ‡çš„æ˜¯åœ¨å¤šè¿›ç¨‹æˆ–å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­å‡ºç°çš„ä¸€ç§å¹¶å‘é—®é¢˜ã€‚ç„¶è€Œï¼Œåœ¨å‰ç«¯å¼€å‘ä¸­ï¼Œæˆ‘ä»¬å¯èƒ½è¾ƒå°‘ç›´æ¥é¢å¯¹å¤šçº¿ç¨‹ç¼–ç¨‹ï¼Œä½†æˆ‘ä»¬ç»å¸¸ä¼šé‡åˆ°ä¸ç«æ€é—®é¢˜ç›¸ä¼¼çš„æƒ…å¢ƒã€‚ä¸€ä¸ªå¸¸è§çš„ä¾‹å­æ˜¯åœ¨å¼‚æ­¥ç¼–ç¨‹ä¸­ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤„ç†å¼‚</summary>
      
    
    
    
    <category term="Vue" scheme="https://ikkkp.github.io/categories/Vue/"/>
    
    
    <category term="Vue" scheme="https://ikkkp.github.io/tags/Vue/"/>
    
  </entry>
  
  <entry>
    <title>vue-expired-side-effects</title>
    <link href="https://ikkkp.github.io/2023/11/01/en/vue-expired-side-effects/"/>
    <id>https://ikkkp.github.io/2023/11/01/en/vue-expired-side-effects/</id>
    <published>2023-10-31T16:13:47.000Z</published>
    <updated>2023-11-03T14:08:49.721Z</updated>
    
    <content type="html"><![CDATA[<h2><span id="introduction">Introduction</span></h2><p>When we talk about race conditions, it typically refers to a concurrency problem in multi-process or multi-threaded programming. However, in frontend development, we might not directly encounter multi-threaded programming frequently, but we often face similar situations related to race conditions. A common example is in asynchronous programming, especially when dealing with asynchronous events, callback functions, or Promises.</p><p>For instance, consider the following asynchronous code:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">let</span> data<span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">fetchData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    data <span class="token operator">=</span> <span class="token string">'Fetched data'</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">fetchData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Outputs undefined</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>In this example, the <code>fetchData</code> function is asynchronous, and it assigns the data to the <code>data</code> variable after 1 second. However, due to JavaScriptâ€™s single-threaded nature, the <code>fetchData</code> function waits in the main threadâ€™s event queue for 1 second. Within this 1 second, the <code>console.log(data)</code> statement executes immediately, and at that point, the value of <code>data</code> is <code>undefined</code> because the <code>fetchData</code> function has not completed yet.</p><p>In asynchronous programming, due to the non-blocking nature of the code, similar race condition issues can arise. When dealing with asynchronous operations, itâ€™s crucial to ensure data consistency and correctness, avoiding accessing or modifying related data before the asynchronous operation is completed.</p><h2><span id="race-conditions-and-reactivity">Race Conditions and Reactivity</span></h2><p>So, how are race conditions related to reactivity?</p><p>Consider the following example:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">let</span> finalData<span class="token punctuation">;</span><span class="token function">watch</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  <span class="token comment">// Send and wait for a network request</span>  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/path/to/request'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// Assign the request result to data</span>  finalData <span class="token operator">=</span> res<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>In this code snippet, we use the <code>watch</code> function to observe changes to the <code>obj</code> object. Every time the <code>obj</code> object changes, a network request, such as an API call, is sent. After the data request is successful, the result is assigned to the <code>finalData</code> variable. At first glance, this code might seem fine. However, upon closer inspection, youâ€™ll realize that this code can lead to race condition problems. Letâ€™s assume we modify a field of the <code>obj</code> object for the first time, triggering the callback function and sending the first request A. As time passes, before the result of request A returns, we modify a field of the <code>obj</code> object again, triggering the second request B. Now, both request A and request B are in progress. Which request will return its result first? We donâ€™t know. If request B completes before request A, the finalData variable will store the result of request B, making request Aâ€™s result outdated.</p><p><img src="/img/expired-side-sffect/expired-side-sffect.png" alt="Comparison"></p><p>However, because request B was sent later, we consider its data as the â€œlatest.â€ Request A is deemed â€œexpired,â€ and its result should be invalidated. By ensuring that request Bâ€™s result is considered the latest, we can prevent errors caused by race conditions. Essentially, what we need is a way to expire side effects. To illustrate this concept further, letâ€™s replicate the scenario using the <code>watch</code> function in Vue.js to see how Vue.js helps developers address this problem. Later, weâ€™ll attempt to implement this functionality ourselves.</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">watch</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">newValue<span class="token punctuation">,</span> oldValue<span class="token punctuation">,</span> onInvalidate</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  <span class="token comment">// Define a flag to indicate whether the current side effect has expired, initially set to false (not expired)</span>  <span class="token keyword">let</span> expired <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token comment">// Call the onInvalidate() function to register an expiration callback</span>  <span class="token function">onInvalidate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token comment">// When expired, set the expired flag to true</span>    expired <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// Send a network request</span>  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/path/to/request'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// Perform subsequent operations only if the side effect has not expired</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>expired<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    finalData <span class="token operator">=</span> res<span class="token punctuation">;</span>    <span class="token comment">// Subsequent operations...</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>As shown in the code above, before sending the request, we define an <code>expired</code> flag variable to indicate whether the current side effect has expired. We then call the <code>onInvalidate</code> function to register an expiration callback. When the side effect expires, the <code>expired</code> flag is set to <code>true</code>. Finally, we use the request result only if the side effect has not expired, effectively avoiding the issue described earlier.</p><p><img src="/img/expired-side-sffect/expired-side-sffect2.png" alt="Comparison"></p><hr><p><em>Note: This article is a translated version of the original post. For the most accurate and up-to-date information, please refer to the original source.</em></p><pre><code></code></pre>]]></content>
    
    
      
      
    <summary type="html">&lt;h2&gt;&lt;span id=&quot;introduction&quot;&gt;Introduction&lt;/span&gt;&lt;/h2&gt;
&lt;p&gt;When we talk about race conditions, it typically refers to a concurrency problem in </summary>
      
    
    
    
    <category term="Vue" scheme="https://ikkkp.github.io/categories/Vue/"/>
    
    
    <category term="Vue" scheme="https://ikkkp.github.io/tags/Vue/"/>
    
  </entry>
  
  <entry>
    <title>vue-watch-computedåŸç†</title>
    <link href="https://ikkkp.github.io/2023/10/31/vue-watch-computed/"/>
    <id>https://ikkkp.github.io/2023/10/31/vue-watch-computed/</id>
    <published>2023-10-31T04:45:41.000Z</published>
    <updated>2023-11-04T02:31:23.659Z</updated>
    
    <content type="html"><![CDATA[<h2><span id="å¼•è¨€">å¼•è¨€</span></h2><p>ä¹‹å‰ä»‹ç»è¿‡äº† effect å‡½æ•°ï¼Œå®ƒç”¨æ¥æ³¨å†Œå‰¯ä½œç”¨å‡½æ•°ï¼ŒåŒæ—¶å®ƒä¹Ÿå…è®¸æŒ‡å®šä¸€äº›é€‰é¡¹å‚æ•° optionsï¼Œä¾‹å¦‚æŒ‡å®š scheduler è°ƒåº¦å™¨æ¥æ§åˆ¶å‰¯ä½œç”¨å‡½æ•°çš„æ‰§è¡Œæ—¶æœºå’Œæ–¹å¼ï¼›ä¹Ÿä»‹ç»äº†ç”¨æ¥è¿½è¸ªå’Œæ”¶é›†ä¾èµ–çš„track å‡½æ•°ï¼Œä»¥åŠç”¨æ¥è§¦å‘å‰¯ä½œç”¨å‡½æ•°é‡æ–°æ‰§è¡Œçš„ trigger å‡½æ•°ã€‚å®é™…ä¸Šï¼Œç»¼åˆè¿™äº›å†…å®¹ï¼Œæˆ‘ä»¬å°±å¯ä»¥å®ç° Vue.js ä¸­ä¸€ä¸ªéå¸¸é‡è¦å¹¶ä¸”éå¸¸æœ‰ç‰¹è‰²çš„èƒ½åŠ›â€”â€”è®¡ç®—å±æ€§ã€‚</p><h2><span id="è®¡ç®—å±æ€§ä¸lazyå±æ€§">è®¡ç®—å±æ€§ä¸<code>lazy</code>å±æ€§</span></h2><p>åœ¨Vue.jsä¸­ï¼Œ<code>effect</code>å‡½æ•°æ˜¯ç”¨æ¥åˆ›å»ºå“åº”å¼å‰¯ä½œç”¨çš„å‡½æ•°ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œä¼ é€’ç»™<code>effect</code>çš„å‰¯ä½œç”¨å‡½æ•°ä¼šç«‹å³æ‰§è¡Œã€‚ä¾‹å¦‚ï¼Œä¸‹é¢çš„ä»£ç ä¸­ï¼Œ<code>effect</code>å‡½æ•°ä¼šç«‹å³æ‰§è¡Œä¼ é€’ç»™å®ƒçš„å‰¯ä½œç”¨å‡½æ•°ï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>foo<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>ç„¶è€Œï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¸Œæœ›å‰¯ä½œç”¨å‡½æ•°åœ¨éœ€è¦çš„æ—¶å€™æ‰æ‰§è¡Œï¼Œè€Œä¸æ˜¯ç«‹å³æ‰§è¡Œã€‚ä¸€ä¸ªå…¸å‹çš„ä¾‹å­æ˜¯è®¡ç®—å±æ€§ã€‚ä¸ºäº†å®ç°è¿™ç§å»¶è¿Ÿæ‰§è¡Œçš„æ•ˆæœï¼Œæˆ‘ä»¬å¯ä»¥åœ¨<code>options</code>ä¸­æ·»åŠ ä¸€ä¸ª<code>lazy</code>å±æ€§ï¼Œå¹¶å°†å…¶è®¾ç½®ä¸º<code>true</code>ã€‚å½“<code>lazy</code>ä¸º<code>true</code>æ—¶ï¼Œå‰¯ä½œç”¨å‡½æ•°ä¸ä¼šåœ¨åˆå§‹åŒ–æ—¶ç«‹å³æ‰§è¡Œï¼Œè€Œæ˜¯åœ¨éœ€è¦çš„æ—¶å€™æ‰æ‰§è¡Œã€‚ä¿®æ­£åçš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">effect</span><span class="token punctuation">(</span>  <span class="token comment">// è¿™ä¸ªå‡½æ•°ä¸ä¼šç«‹å³æ‰§è¡Œ</span>  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>foo<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token comment">// options</span>  <span class="token punctuation">&#123;</span>    <span class="token literal-property property">lazy</span><span class="token operator">:</span> <span class="token boolean">true</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å…·ä½“å®ç°ä¸­ï¼Œæˆ‘ä»¬å°†å‰¯ä½œç”¨å‡½æ•°<code>effectFn</code>ä½œä¸º<code>effect</code>å‡½æ•°çš„è¿”å›å€¼è¿”å›ã€‚è¿™æ„å‘³ç€ï¼Œå½“æˆ‘ä»¬è°ƒç”¨<code>effect</code>å‡½æ•°æ—¶ï¼Œæˆ‘ä»¬ä¼šå¾—åˆ°å¯¹åº”çš„å‰¯ä½œç”¨å‡½æ•°ï¼Œå¹¶ä¸”å¯ä»¥åœ¨éœ€è¦çš„æ—¶å€™æ‰‹åŠ¨æ‰§è¡Œå®ƒã€‚è¿™ç§æœºåˆ¶èµ‹äºˆäº†æˆ‘ä»¬æ›´å¤šçš„æ§åˆ¶æƒï¼Œå…è®¸æˆ‘ä»¬å†³å®šä½•æ—¶è§¦å‘å‰¯ä½œç”¨å‡½æ•°çš„æ‰§è¡Œï¼Œè€Œä¸æ˜¯ç«‹å³æ‰§è¡Œå®ƒã€‚</p><p>è¿™ç§è®¾è®¡æ¨¡å¼ç‰¹åˆ«é€‚ç”¨äºç‰¹å®šåœºæ™¯ï¼Œä¾‹å¦‚è®¡ç®—å±æ€§ã€‚åœ¨è®¡ç®—å±æ€§ä¸­ï¼Œæˆ‘ä»¬å¯èƒ½å¸Œæœ›åœ¨ç‰¹å®šæ—¶åˆ»è§¦å‘å‰¯ä½œç”¨å‡½æ•°çš„æ‰§è¡Œï¼Œè€Œä¸æ˜¯åœ¨åˆå§‹åŒ–æ—¶ç«‹å³æ‰§è¡Œã€‚é€šè¿‡å°†å‰¯ä½œç”¨å‡½æ•°ä½œä¸º<code>effect</code>å‡½æ•°çš„è¿”å›å€¼ï¼Œæˆ‘ä»¬èƒ½å¤Ÿçµæ´»åœ°æ§åˆ¶å‰¯ä½œç”¨å‡½æ•°çš„æ‰§è¡Œæ—¶æœºï¼Œä»¥æ»¡è¶³ä¸åŒåœºæ™¯çš„éœ€æ±‚ã€‚</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> options <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> <span class="token function-variable function">effectFn</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token function">cleanup</span><span class="token punctuation">(</span>effectFn<span class="token punctuation">)</span><span class="token punctuation">;</span>    activeEffect <span class="token operator">=</span> effectFn<span class="token punctuation">;</span>    effectStack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>effectFn<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    effectStack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    activeEffect <span class="token operator">=</span> effectStack<span class="token punctuation">[</span>effectStack<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token comment">// è®¾ç½®å‰¯ä½œç”¨å‡½æ•°çš„ options å’Œ deps</span>  effectFn<span class="token punctuation">.</span>options <span class="token operator">=</span> options<span class="token punctuation">;</span>  effectFn<span class="token punctuation">.</span>deps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// åªæœ‰é lazy æ—¶æ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>options<span class="token punctuation">.</span>lazy<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">effectFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token comment">// å°†å‰¯ä½œç”¨å‡½æ•°ä½œä¸ºè¿”å›å€¼è¿”å›</span>  <span class="token keyword">return</span> effectFn<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨è¿™ä¸ªä»£ç ä¸­ï¼Œ<code>effect</code>å‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ª<code>options</code>å¯¹è±¡ï¼Œå…¶ä¸­<code>lazy</code>å±æ€§è¢«è®¾ç½®ä¸º<code>true</code>ã€‚è¿™æ„å‘³ç€ä¼ é€’ç»™<code>effect</code>çš„å‰¯ä½œç”¨å‡½æ•°ä¼šåœ¨éœ€è¦çš„æ—¶å€™æ‰æ‰§è¡Œï¼Œä¾‹å¦‚åœ¨è®¡ç®—å±æ€§è¢«è®¿é—®æ—¶ã€‚è¿™ç§å»¶è¿Ÿæ‰§è¡Œçš„ç‰¹æ€§ä½¿å¾—<code>effect</code>å‡½æ•°éå¸¸é€‚åˆç”¨äºå®ç°è®¡ç®—å±æ€§ç­‰åœºæ™¯ã€‚</p><p>åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡<code>options</code>å‚æ•°çš„<code>lazy</code>å±æ€§æ§åˆ¶å‰¯ä½œç”¨å‡½æ•°çš„ç«‹å³æ‰§è¡Œã€‚å¦‚æœ<code>options.lazy</code>ä¸º<code>true</code>ï¼Œå‰¯ä½œç”¨å‡½æ•°å°†è¢«å»¶è¿Ÿæ‰§è¡Œï¼Œç›´åˆ°æ‰‹åŠ¨è§¦å‘ä¸ºæ­¢ã€‚</p><p>ç°åœ¨æˆ‘ä»¬é€šè¿‡è®¡ç®—å±æ€§å®ç°äº†lazyæ‡’åŠ è½½ï¼Œé‚£ä¹ˆæ•°æ®ç¼“å­˜è¯¥æ€ä¹ˆå®ç°å‘¢ã€‚</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token parameter">getter</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// value ç”¨æ¥ç¼“å­˜ä¸Šä¸€æ¬¡è®¡ç®—çš„å€¼</span>  <span class="token keyword">let</span> value<span class="token punctuation">;</span>  <span class="token comment">// dirty æ ‡å¿—ï¼Œç”¨æ¥æ ‡è¯†æ˜¯å¦éœ€è¦é‡æ–°è®¡ç®—å€¼ï¼Œä¸º true åˆ™æ„å‘³ç€â€œè„â€ï¼Œéœ€è¦è®¡ç®—</span>  <span class="token keyword">let</span> dirty <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> effectFn <span class="token operator">=</span> <span class="token function">effect</span><span class="token punctuation">(</span>getter<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>    <span class="token literal-property property">lazy</span><span class="token operator">:</span> <span class="token boolean">true</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">get</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token comment">// åªæœ‰â€œè„â€æ—¶æ‰è®¡ç®—å€¼ï¼Œå¹¶å°†å¾—åˆ°çš„å€¼ç¼“å­˜åˆ° value ä¸­</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>dirty<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        value <span class="token operator">=</span> <span class="token function">effectFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// å°† dirty è®¾ç½®ä¸º falseï¼Œä¸‹ä¸€æ¬¡è®¿é—®ç›´æ¥ä½¿ç”¨ç¼“å­˜åˆ° value ä¸­çš„å€¼</span>        dirty <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>      <span class="token keyword">return</span> value<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> obj<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è§£å†³äº†æ‡’è®¡ç®—çš„é—®é¢˜ï¼Œåªæœ‰åœ¨çœŸæ­£éœ€è¦è®¡ç®—<code>value</code>çš„æ—¶å€™ï¼Œæ‰ä¼šæ‰§è¡Œ<code>effectFn</code>ã€‚åŒæ—¶ï¼Œå®ƒè¿˜å¼•å…¥äº†ä¸€ä¸ª<code>dirty</code>æ ‡å¿—ï¼Œç”¨äºæ ‡è¯†å½“å‰çš„è®¡ç®—æ˜¯å¦éœ€è¦é‡æ–°è¿›è¡Œã€‚å¦‚æœ<code>dirty</code>ä¸º<code>true</code>ï¼Œåˆ™é‡æ–°è®¡ç®—<code>value</code>çš„å€¼ï¼Œå¹¶å°†<code>dirty</code>æ ‡å¿—è®¾ç½®ä¸º<code>false</code>ï¼Œä»¥ä¾¿ä¸‹ä¸€æ¬¡è®¿é—®æ—¶å¯ä»¥ç›´æ¥ä½¿ç”¨ç¼“å­˜çš„å€¼ã€‚</p><h2><span id="watch-çš„å®ç°åŸç†">watch çš„å®ç°åŸç†</span></h2><p>æ‰€è°“ watchï¼Œå…¶æœ¬è´¨å°±æ˜¯è§‚æµ‹ä¸€ä¸ªå“åº”å¼æ•°æ®ï¼Œå½“æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶é€šçŸ¥å¹¶æ‰§è¡Œç›¸åº”çš„å›è°ƒå‡½æ•°ã€‚ä¸¾ä¸ªä¾‹å­ï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">watch</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'æ•°æ®å˜äº†'</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token comment">// ä¿®æ”¹å“åº”æ•°æ®çš„å€¼ï¼Œä¼šå¯¼è‡´å›è°ƒå‡½æ•°æ‰§è¡Œ</span>obj<span class="token punctuation">.</span>foo<span class="token operator">++</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å‡è®¾ obj æ˜¯ä¸€ä¸ªå“åº”æ•°æ®ï¼Œä½¿ç”¨ watch å‡½æ•°è§‚æµ‹å®ƒï¼Œå¹¶ä¼ é€’ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œå½“ä¿®æ”¹å“åº”å¼æ•°æ®çš„å€¼æ—¶ï¼Œä¼šè§¦å‘è¯¥å›è°ƒå‡½æ•°æ‰§è¡Œã€‚å®é™…ä¸Šï¼Œwatch çš„å®ç°æœ¬è´¨ä¸Šå°±æ˜¯åˆ©ç”¨äº† effect ä»¥åŠoptions.scheduler é€‰é¡¹ï¼Œå¦‚ä»¥ä¸‹ä»£ç æ‰€ç¤ºï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>foo<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token function">scheduler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// å½“ obj.foo çš„å€¼å˜åŒ–æ—¶ï¼Œä¼šæ‰§è¡Œ scheduler è°ƒåº¦å‡½æ•°</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨ä¸€ä¸ªå‰¯ä½œç”¨å‡½æ•°ä¸­è®¿é—®å“åº”å¼æ•°æ® obj.fooï¼Œé€šè¿‡å‰é¢çš„ä»‹ç»ï¼Œæˆ‘ä»¬çŸ¥é“è¿™ä¼šåœ¨å‰¯ä½œç”¨å‡½æ•°ä¸å“åº”å¼æ•°æ®ä¹‹é—´å»ºç«‹è”ç³»ï¼Œå½“å“åº”å¼æ•°æ®å˜åŒ–æ—¶ï¼Œä¼šè§¦å‘å‰¯ä½œç”¨å‡½æ•°é‡æ–°æ‰§è¡Œã€‚ä½†æœ‰ä¸€ä¸ªä¾‹å¤–ï¼Œå³å¦‚æœå‰¯ä½œç”¨å‡½æ•°å­˜åœ¨ scheduler é€‰é¡¹ï¼Œå½“å“åº”å¼æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶ï¼Œä¼šè§¦å‘ scheduler è°ƒåº¦å‡½æ•°æ‰§è¡Œï¼Œè€Œéç›´æ¥è§¦å‘å‰¯ä½œç”¨å‡½æ•°æ‰§è¡Œã€‚ä»è¿™ä¸ªè§’åº¦æ¥çœ‹ï¼Œå…¶å® scheduler è°ƒåº¦å‡½æ•°å°±ç›¸å½“äºä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œè€Œwatch çš„å®ç°å°±æ˜¯åˆ©ç”¨äº†è¿™ä¸ªç‰¹ç‚¹ã€‚</p><p>ä¸‹é¢æ˜¯æœ€ç®€å•çš„ watch å‡½æ•°çš„å®ç°ï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// watch å‡½æ•°æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼Œsource æ˜¯å“åº”å¼æ•°æ®ï¼Œcb æ˜¯å›è°ƒå‡½æ•°</span><span class="token keyword">function</span> <span class="token function">watch</span><span class="token punctuation">(</span><span class="token parameter">source<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token function">effect</span><span class="token punctuation">(</span>    <span class="token comment">// è§¦å‘è¯»å–æ“ä½œï¼Œä»è€Œå»ºç«‹è”ç³»</span>    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> source<span class="token punctuation">.</span>foo<span class="token punctuation">,</span>    <span class="token punctuation">&#123;</span>      <span class="token literal-property property">scheduler</span><span class="token operator">:</span> <span class="token function">scheduler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>      <span class="token comment">// å½“æ•°æ®å˜åŒ–æ—¶ï¼Œè°ƒç”¨å›è°ƒå‡½æ•° cb</span>      <span class="token function-variable function">fn</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>        <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>äºæ˜¯ä¸€æ®µå®Œæ•´çš„ä»£ç ï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// å“åº”å¼æ•°æ®å¯¹è±¡</span><span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">// åˆ›å»ºä»£ç†å¯¹è±¡ï¼Œç”¨äºç›‘å¬æ•°æ®å˜åŒ–</span><span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>  <span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    target<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>    <span class="token comment">// æ•°æ®å˜åŒ–æ—¶è§¦å‘å›è°ƒå‡½æ•°</span>    <span class="token function">watch</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'æ•°æ®å˜åŒ–äº†'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// watch å‡½æ•°æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼Œsource æ˜¯å“åº”å¼æ•°æ®ï¼Œcb æ˜¯å›è°ƒå‡½æ•°</span><span class="token keyword">function</span> <span class="token function">watch</span><span class="token punctuation">(</span><span class="token parameter">source<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> source<span class="token punctuation">.</span>foo<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>    <span class="token literal-property property">scheduler</span><span class="token operator">:</span> <span class="token function">scheduler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function-variable function">fn</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>      <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// æ¨¡æ‹Ÿ effect å‡½æ•°</span><span class="token keyword">function</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// åœ¨è¿™é‡Œæ‰§è¡Œ effect ç›¸å…³é€»è¾‘</span>  <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// è¿™é‡Œå‡è®¾æ‰§è¡Œ fn ä¼šè§¦å‘å“åº”å¼æ•°æ®çš„è¯»å–æ“ä½œ</span><span class="token punctuation">&#125;</span><span class="token comment">// æ¨¡æ‹Ÿ scheduler å‡½æ•°</span><span class="token keyword">function</span> <span class="token function">scheduler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// åœ¨è¿™é‡Œå¯ä»¥æ·»åŠ è°ƒåº¦é€»è¾‘</span>  <span class="token comment">// è¿™é‡Œè¿”å›ä¸€ä¸ªå‡½æ•°ä½œä¸º scheduler</span>  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// è¿™é‡Œå¯ä»¥æ·»åŠ å…·ä½“çš„è°ƒåº¦é€»è¾‘</span>    <span class="token comment">// ...</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// æ•°æ®å˜åŒ–</span>obj<span class="token punctuation">.</span>foo<span class="token operator">++</span><span class="token punctuation">;</span><span class="token comment">// è¾“å‡º: æ•°æ®å˜åŒ–äº†</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æˆ‘ä»¬é¦–å…ˆå®šä¹‰äº†ä¸€ä¸ªåŸå§‹çš„æ•°æ®å¯¹è±¡dataï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªå±æ€§fooï¼Œåˆå§‹å€¼ä¸º1ã€‚æ¥ç€ï¼Œæˆ‘ä»¬ä½¿ç”¨Proxyåˆ›å»ºäº†ä¸€ä¸ªä»£ç†å¯¹è±¡objï¼Œè¯¥ä»£ç†å¯¹è±¡ä¼šæ‹¦æˆªå¯¹dataçš„æ“ä½œã€‚</p><p>å½“ä½ è°ƒç”¨obj.foo++æ—¶ï¼Œä¼šè§¦å‘Proxyçš„setæ‹¦æˆªå™¨ã€‚åœ¨setæ‹¦æˆªå™¨ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆå°†å±æ€§å€¼è®¾ç½®åˆ°ç›®æ ‡å¯¹è±¡ä¸Šï¼Œç„¶åè°ƒç”¨watchå‡½æ•°ï¼Œå¹¶ä¼ å…¥objå’Œä¸€ä¸ªå›è°ƒå‡½æ•°ã€‚åœ¨watchå‡½æ•°ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†ä¸€ä¸ªå‡è®¾çš„effectå‡½æ•°ï¼ˆå®é™…å¼€å‘ä¸­å¯èƒ½æ˜¯æ¡†æ¶æä¾›çš„å“åº”å¼å‡½æ•°ï¼‰ï¼Œè¿™ä¸ªå‡½æ•°ç”¨äºç›‘å¬æ•°æ®çš„å˜åŒ–ã€‚åœ¨watchå‡½æ•°ä¸­ï¼Œæˆ‘ä»¬ä¼ å…¥äº†source.fooçš„è¯»å–æ“ä½œï¼Œä»¥åŠä¸€ä¸ªåŒ…å«schedulerå’Œfnå±æ€§çš„é…ç½®å¯¹è±¡ã€‚schedulerå¯ä»¥ç”¨äºå®šä¹‰è°ƒåº¦é€»è¾‘ï¼ˆåœ¨ç¤ºä¾‹ä¸­ä¸ºç©ºå‡½æ•°ï¼‰ï¼Œfnåˆ™æ˜¯ä¸€ä¸ªå½“æ•°æ®å˜åŒ–æ—¶ä¼šè¢«è°ƒç”¨çš„å›è°ƒå‡½æ•°ã€‚</p><p>å½“obj.foo++æ‰§è¡Œæ—¶ï¼Œsetæ‹¦æˆªå™¨è§¦å‘ï¼Œwatchå‡½æ•°è¢«è°ƒç”¨ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2&gt;&lt;span id=&quot;å¼•è¨€&quot;&gt;å¼•è¨€&lt;/span&gt;&lt;/h2&gt;
&lt;p&gt;ä¹‹å‰ä»‹ç»è¿‡äº† effect å‡½æ•°ï¼Œå®ƒç”¨æ¥æ³¨å†Œå‰¯ä½œç”¨å‡½æ•°ï¼ŒåŒæ—¶å®ƒä¹Ÿå…è®¸æŒ‡å®šä¸€äº›é€‰é¡¹å‚æ•° optionsï¼Œä¾‹å¦‚æŒ‡å®š scheduler è°ƒåº¦å™¨æ¥æ§åˆ¶å‰¯ä½œç”¨å‡½æ•°çš„æ‰§è¡Œæ—¶æœºå’Œæ–¹å¼ï¼›ä¹Ÿä»‹ç»äº†ç”¨æ¥è¿½è¸ªå’Œæ”¶é›†ä¾èµ–çš„trac</summary>
      
    
    
    
    <category term="Vue" scheme="https://ikkkp.github.io/categories/Vue/"/>
    
    
    <category term="Vue" scheme="https://ikkkp.github.io/tags/Vue/"/>
    
  </entry>
  
  <entry>
    <title>vue-watch-computed</title>
    <link href="https://ikkkp.github.io/2023/10/31/en/vue-watch-computed/"/>
    <id>https://ikkkp.github.io/2023/10/31/en/vue-watch-computed/</id>
    <published>2023-10-31T04:45:41.000Z</published>
    <updated>2023-11-03T14:08:54.169Z</updated>
    
    <content type="html"><![CDATA[<h2><span id="introduction">Introduction</span></h2><p>Previously, we discussed the <code>effect</code> function, which is used to register side-effect functions. It allows specifying options parameters, such as the <code>scheduler</code> to control the timing and manner of side-effect function execution. We also explored the <code>track</code> function for dependency tracking and the <code>trigger</code> function to re-execute side-effect functions. Combining these concepts, we can implement a fundamental and distinctive feature of Vue.js â€“ computed properties.</p><h2><span id="computed-properties-and-the-lazy-option">Computed Properties and the <code>lazy</code> Option</span></h2><p>In Vue.js, the <code>effect</code> function is used to create reactive side-effect functions. By default, side-effect functions passed to <code>effect</code> are executed immediately. For example, in the code below, the side-effect function passed to the <code>effect</code> function is executed immediately:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>foo<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>However, in certain cases, we want the side-effect function to execute only when needed, not immediately. A typical scenario is with computed properties. To achieve this delayed execution, we can add a <code>lazy</code> property to the <code>options</code> object and set it to <code>true</code>. When <code>lazy</code> is <code>true</code>, the side-effect function is not executed during initialization but only when necessary. The modified code looks like this:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">effect</span><span class="token punctuation">(</span>  <span class="token comment">// This function will not execute immediately</span>  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>foo<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token comment">// options</span>  <span class="token punctuation">&#123;</span>    <span class="token literal-property property">lazy</span><span class="token operator">:</span> <span class="token boolean">true</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>In the implementation, the side-effect function <code>effectFn</code> is returned as the result of the <code>effect</code> function. This means that when we call the <code>effect</code> function, we get the corresponding side-effect function and can manually execute it when needed. This mechanism gives us more control, allowing us to decide when to trigger the execution of the side-effect function rather than executing it immediately.</p><p>This design pattern is particularly suitable for specific scenarios like computed properties. In computed properties, we might want to trigger the side-effect functionâ€™s execution at a specific moment rather than immediately during initialization. By returning the side-effect function from the <code>effect</code> function, we can flexibly control when the side-effect function is executed to meet different requirements in various scenarios.</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> options <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> <span class="token function-variable function">effectFn</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token function">cleanup</span><span class="token punctuation">(</span>effectFn<span class="token punctuation">)</span><span class="token punctuation">;</span>    activeEffect <span class="token operator">=</span> effectFn<span class="token punctuation">;</span>    effectStack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>effectFn<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    effectStack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    activeEffect <span class="token operator">=</span> effectStack<span class="token punctuation">[</span>effectStack<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token comment">// Set options and dependencies for the side-effect function</span>  effectFn<span class="token punctuation">.</span>options <span class="token operator">=</span> options<span class="token punctuation">;</span>  effectFn<span class="token punctuation">.</span>deps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// Execute the side-effect function only if it's not lazy</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>options<span class="token punctuation">.</span>lazy<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">effectFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token comment">// Return the side-effect function as the result</span>  <span class="token keyword">return</span> effectFn<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>In this code, the <code>effect</code> functionâ€™s second parameter is an <code>options</code> object, where the <code>lazy</code> property is set to <code>true</code>. This means that the side-effect function passed to <code>effect</code> will be executed only when necessary, such as when accessing a computed property. The <code>lazy</code> property allows us to control the immediate execution of the side-effect function.</p><p>Now that we have achieved lazy computation through computed properties, how do we implement data caching?</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token parameter">getter</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// value is used to cache the last computed value</span>  <span class="token keyword">let</span> value<span class="token punctuation">;</span>  <span class="token comment">// dirty flag indicates whether a recalculation is needed; if true, it means "dirty" and needs computation</span>  <span class="token keyword">let</span> dirty <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> effectFn <span class="token operator">=</span> <span class="token function">effect</span><span class="token punctuation">(</span>getter<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>    <span class="token literal-property property">lazy</span><span class="token operator">:</span> <span class="token boolean">true</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">get</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token comment">// Compute the value only if it's "dirty," and cache the computed value in the value variable</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>dirty<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        value <span class="token operator">=</span> <span class="token function">effectFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// Set dirty to false, so the cached value can be used directly next time</span>        dirty <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>      <span class="token keyword">return</span> value<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> obj<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>With lazy computation resolved, the <code>value</code> is calculated only when it is truly needed, executing <code>effectFn</code> only when necessary. Additionally, a <code>dirty</code> flag is introduced to indicate whether the current computation needs to be recalculated. If <code>dirty</code> is <code>true</code>, the <code>value</code> is recalculated, and the <code>dirty</code> flag is set to <code>false</code> so that the cached value can be used directly next time.</p><h2><span id="implementation-principle-of-watch">Implementation Principle of <code>watch</code></span></h2><p>The concept of watch essentially involves observing a reactive data and executing the corresponding callback function when the data changes. For example:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">watch</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Data changed'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token comment">// Modifying the reactive data triggers the execution of the callback function</span>obj<span class="token punctuation">.</span>foo<span class="token operator">++</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Suppose <code>obj</code> is a reactive data, watched using the <code>watch</code> function with a provided callback function. When modifying the reactive dataâ€™s value, the callback function is triggered. In fact, the implementation of <code>watch</code> essentially utilizes the <code>effect</code> and the <code>options.scheduler</code> option, as shown in the following code:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>foo<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token function">scheduler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// The scheduler function is executed when obj.foo's value changes</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>In a side-effect function accessing the reactive data <code>obj.foo</code>, based on the previous discussion, we know that this establishes a connection between the side-effect function and the reactive data. When the reactive data changes, the side-effect function is re-executed. However, there is an exception: if the side-effect function has a <code>scheduler</code> option, when the reactive data changes, the <code>scheduler</code> function is executed instead of directly triggering the side-effect function. From this perspective, the <code>scheduler</code> function acts as a callback function, and the implementation of <code>watch</code> utilizes this characteristic.</p><p>Below is the simplest implementation of the <code>watch</code> function:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// The watch function receives two parameters: source (reactive data) and cb (callback function)</span><span class="token keyword">function</span> <span class="token function">watch</span><span class="token punctuation">(</span><span class="token parameter">source<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token function">effect</span><span class="token punctuation">(</span>    <span class="token comment">// Trigger a read operation to establish a connection</span>    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> source<span class="token punctuation">.</span>foo<span class="token punctuation">,</span>    <span class="token punctuation">&#123;</span>      <span class="token literal-property property">scheduler</span><span class="token operator">:</span> <span class="token function">scheduler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>      <span class="token comment">// Call the callback function cb when the data changes</span>      <span class="token function-variable function">fn</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>        <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>In this code, we first define an original data object named <code>data</code>, which contains a property <code>foo</code> with an initial value of 1. Next, we create a proxy object <code>obj</code> using Proxy, intercepting operations on the data.</p><p>When <code>obj.foo++</code> is executed, the set interceptor of Proxy is triggered. In the set interceptor, we first set the property value on the target object and then call the <code>watch</code> function, passing <code>obj</code> and a callback function. In the <code>watch</code> function, we use a hypothetical <code>effect</code> function (which might be provided by a framework) to listen for data changes.</p><hr><p><em>Note: This article is a translated version of the original post. For the most accurate and up-to-date information, please refer to the original source.</em></p><pre><code></code></pre>]]></content>
    
    
      
      
    <summary type="html">&lt;h2&gt;&lt;span id=&quot;introduction&quot;&gt;Introduction&lt;/span&gt;&lt;/h2&gt;
&lt;p&gt;Previously, we discussed the &lt;code&gt;effect&lt;/code&gt; function, which is used to register</summary>
      
    
    
    
    <category term="Vue" scheme="https://ikkkp.github.io/categories/Vue/"/>
    
    
    <category term="Vue" scheme="https://ikkkp.github.io/tags/Vue/"/>
    
  </entry>
  
  <entry>
    <title>åµŒå¥—çš„ effect ä¸ effect æ ˆ</title>
    <link href="https://ikkkp.github.io/2023/10/31/vue-effect/"/>
    <id>https://ikkkp.github.io/2023/10/31/vue-effect/</id>
    <published>2023-10-31T02:09:08.000Z</published>
    <updated>2023-10-31T03:14:22.021Z</updated>
    
    <content type="html"><![CDATA[<h2><span id="å¼•è¨€">å¼•è¨€</span></h2><p>effect å‰¯ä½œç”¨å‡½æ•°æ˜¯å¯ä»¥å‘ç”ŸåµŒå¥—çš„ï¼Œè‡³äºä¸ºä»€ä¹ˆè¦è®¾è®¡æˆè¿™æ ·å‘¢</p><h2><span id="åµŒå¥—çš„-effect">åµŒå¥—çš„ effect</span></h2><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">effect</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">effectFn1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token function">effect</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">effectFn2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* ... */</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token comment">/* ... */</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨ä¸Šé¢è¿™æ®µä»£ç ä¸­ï¼ŒeffectFn1 å†…éƒ¨åµŒå¥—äº† effectFn2ï¼ŒeffectFn1 çš„æ‰§è¡Œä¼šå¯¼è‡´ effectFn2 çš„æ‰§è¡Œã€‚é‚£ä¹ˆï¼Œä»€ä¹ˆåœºæ™¯ä¸‹ä¼šå‡ºç°åµŒå¥—çš„ effect å‘¢ï¼Ÿæ‹¿ Vue.js æ¥è¯´ï¼Œå®é™…ä¸Š Vue.js çš„æ¸²æŸ“å‡½æ•°å°±æ˜¯åœ¨ä¸€ä¸ª effect ä¸­æ‰§è¡Œçš„.</p><p>å½“ç»„ä»¶å‘ç”ŸåµŒå¥—æ—¶ï¼Œä¾‹å¦‚ Foo ç»„ä»¶æ¸²æŸ“äº† Bar ç»„ä»¶ï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// Bar ç»„ä»¶</span><span class="token keyword">const</span> Bar <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">&#123;</span><span class="token comment">/* ... */</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token comment">// Foo ç»„ä»¶æ¸²æŸ“äº† Bar ç»„ä»¶</span><span class="token keyword">const</span> Foo <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token operator">&lt;</span>Bar <span class="token operator">/</span><span class="token operator">></span> <span class="token punctuation">&#125;</span><span class="token comment">// jsx è¯­æ³•</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ­¤æ—¶å°±å‘ç”Ÿäº† effect åµŒå¥—ï¼Œå®ƒç›¸å½“äºï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  Foo<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">// åµŒå¥—</span>  <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    Bar<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>effectå‡½æ•°å¯ä»¥åµŒå¥—ä½¿ç”¨ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€ä¸ªeffectå‡½æ•°å†…éƒ¨å¯ä»¥åŒ…å«å¦ä¸€ä¸ªeffectå‡½æ•°ã€‚å½“å¤–éƒ¨effectå‡½æ•°ä¾èµ–äºå†…éƒ¨effectå‡½æ•°åˆ›å»ºçš„å“åº”å¼æ•°æ®æ—¶ï¼Œå†…éƒ¨effectå‡½æ•°ä¼šè¢«è‡ªåŠ¨è¿½è¸ªï¼Œç¡®ä¿å¤–éƒ¨effectå‡½æ•°åœ¨å†…éƒ¨effectå‡½æ•°å‘ç”Ÿå˜åŒ–æ—¶å¾—ä»¥æ‰§è¡Œã€‚</p><p>è¿™ç§åµŒå¥—çš„effectå‡½æ•°ç”¨äºåˆ›å»ºä¾èµ–å…³ç³»é“¾ï¼Œç¡®ä¿å½“æŸä¸ªå“åº”å¼æ•°æ®å˜åŒ–æ—¶ï¼Œæ‰€æœ‰ä¾èµ–äºå®ƒçš„effectå‡½æ•°éƒ½èƒ½å¤Ÿè¢«è§¦å‘æ‰§è¡Œï¼Œä»è€Œä¿æŒåº”ç”¨çš„å“åº”æ€§ã€‚</p><p>è€Œ&quot;effect æ ˆ&quot;ï¼Œåœ¨Vue 3çš„å†…éƒ¨å®ç°ä¸­ï¼ŒVueä½¿ç”¨äº†ä¸€ä¸ªeffectæ ˆæ¥è¿½è¸ªå½“å‰æ­£åœ¨æ‰§è¡Œçš„effectå‡½æ•°ï¼Œè¿™ä¸ªæ ˆçš„ä½œç”¨ç±»ä¼¼äºå‡½æ•°è°ƒç”¨æ ˆï¼Œç”¨äºç®¡ç†effectå‡½æ•°çš„æ‰§è¡Œé¡ºåºå’Œä¾èµ–å…³ç³»ã€‚</p><p>ç°åœ¨æœ‰ä¸€ä¸ªä¸ä½¿ç”¨æ ˆç»“æ„çš„åµŒå¥—çš„<code>effect</code>å‡½æ•°çš„ä¾‹å­ï¼Œä½†æ˜¯ä»–å¹¶ä¸èƒ½å®ç°åµŒå¥—çš„åŠŸèƒ½ã€‚å‡è®¾æˆ‘ä»¬æœ‰ä¸¤ä¸ªå“åº”å¼æ•°æ®<code>count1</code>å’Œ<code>count2</code>ï¼Œå…¶ä¸­<code>count2</code>çš„å€¼ä¾èµ–äº<code>count1</code>çš„å€¼ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨åµŒå¥—çš„<code>effect</code>å‡½æ•°æ¥å®ç°è¿™ç§ä¾èµ–å…³ç³»ã€‚</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// åŸå§‹æ•°æ®</span><span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">bar</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">// ä»£ç†å¯¹è±¡</span><span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>  <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">è¯»å–å±æ€§: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>key<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// å…¨å±€å˜é‡</span><span class="token keyword">let</span> temp1<span class="token punctuation">,</span> temp2<span class="token punctuation">;</span><span class="token comment">// effectFn1 åµŒå¥—äº† effectFn2</span><span class="token function">effect</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">effectFn1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'effectFn1 æ‰§è¡Œ'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">effect</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">effectFn2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'effectFn2 æ‰§è¡Œ'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// åœ¨ effectFn2 ä¸­è¯»å– obj.bar å±æ€§</span>    temp2 <span class="token operator">=</span> obj<span class="token punctuation">.</span>bar<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// åœ¨ effectFn1 ä¸­è¯»å– obj.foo å±æ€§</span>  temp1 <span class="token operator">=</span> obj<span class="token punctuation">.</span>foo<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>effectFn1</code>æ˜¯å¤–éƒ¨çš„<code>effect</code>å‡½æ•°ï¼Œå®ƒä¾èµ–äº<code>obj.foo</code>çš„å€¼ï¼Œå¹¶ä¸”åœ¨å†…éƒ¨åŒ…å«äº†ä¸€ä¸ª<code>innerEffect</code>ï¼Œå†…éƒ¨çš„<code>effect</code>å‡½æ•°ä¾èµ–äº<code>obj.bar</code>çš„å€¼ã€‚å½“æˆ‘ä»¬ä¿®æ”¹<code>obj.foo</code>æ—¶ï¼Œæˆ‘ä»¬å¸Œæœ›å¤–éƒ¨çš„<code>effect</code>å‡½æ•°è¢«è§¦å‘æ‰§è¡Œï¼Œå¹¶ä¸”è¾“å‡º<code>obj.foo</code>çš„å€¼ï¼Œç„¶åè§¦å‘å†…éƒ¨çš„ä¾èµ–å‡½æ•°ã€‚å½“æˆ‘ä»¬ä¿®æ”¹<code>obj.bar</code>æ—¶ï¼Œå†…éƒ¨çš„<code>effect</code>å‡½æ•°è¢«è§¦å‘æ‰§è¡Œï¼Œå¹¶ä¸”è¾“å‡º<code>obj.bar</code>çš„å€¼ã€‚</p><p>æˆ‘ä»¬ç”¨å…¨å±€å˜é‡ activeEffect æ¥å­˜å‚¨é€šè¿‡ effect å‡½æ•°æ³¨å†Œçš„å‰¯ä½œç”¨å‡½æ•°ï¼Œè¿™æ„å‘³ç€åŒä¸€æ—¶åˆ» activeEffect æ‰€å­˜å‚¨çš„å‰¯ä½œç”¨å‡½æ•°åªèƒ½æœ‰ä¸€ä¸ªã€‚</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// ç”¨ä¸€ä¸ªå…¨å±€å˜é‡å­˜å‚¨å½“å‰æ¿€æ´»çš„ effect å‡½æ•°</span><span class="token keyword">let</span> activeEffect<span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// å®šä¹‰å‰¯ä½œç”¨å‡½æ•°</span>  <span class="token keyword">const</span> <span class="token function-variable function">effectFn</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token comment">// è°ƒç”¨ cleanup å‡½æ•°ï¼Œå…·ä½“å®ç°éœ€è¦æ ¹æ®éœ€æ±‚è¡¥å……</span>    <span class="token function">cleanup</span><span class="token punctuation">(</span>effectFn<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// å°†å‰¯ä½œç”¨å‡½æ•°èµ‹å€¼ç»™ activeEffect</span>    activeEffect <span class="token operator">=</span> effectFn<span class="token punctuation">;</span>    <span class="token comment">// æ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°</span>    <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// å°†å½“å‰å‰¯ä½œç”¨å‡½æ•°çš„ä¾èµ–é›†åˆå­˜å‚¨åœ¨ effectFn.deps ä¸­ï¼ˆéœ€è¦æ ¹æ®å®é™…é€»è¾‘è¡¥å……ï¼‰</span>    effectFn<span class="token punctuation">.</span>deps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// è¿™é‡Œéœ€è¦æ ¹æ®å®é™…é€»è¾‘è®¾ç½®ä¾èµ–é›†åˆ</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token comment">// æ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°</span>  <span class="token function">effectFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä½†å…¶å®åªä½¿ç”¨ä¸€ä¸ªå˜é‡å‚¨å­˜è€Œä¸ä½¿ç”¨æ ˆç»“æ„ï¼Œå½“å‰¯ä½œç”¨å‡½æ•°å‘ç”ŸåµŒå¥—æ—¶ï¼Œå†…å±‚å‰¯ä½œç”¨å‡½æ•°çš„æ‰§è¡Œä¼šè¦†ç›– activeEffect çš„å€¼ï¼Œå¹¶ä¸”æ°¸è¿œä¸ä¼šæ¢å¤åˆ°åŸæ¥çš„å€¼ã€‚è¿™æ—¶å¦‚æœå†æœ‰å“åº”å¼æ•°æ®è¿›è¡Œä¾èµ–æ”¶é›†ï¼Œå³ä½¿è¿™ä¸ªå“åº”å¼æ•°æ®æ˜¯åœ¨å¤–å±‚å‰¯ä½œç”¨å‡½æ•°ä¸­è¯»å–çš„ï¼Œå®ƒä»¬æ”¶é›†åˆ°çš„å‰¯ä½œç”¨å‡½æ•°ä¹Ÿéƒ½ä¼šæ˜¯å†…å±‚å‰¯ä½œç”¨å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘åœ¨è¯»å–<code>obj.foo</code>çš„æ—¶å€™ï¼ŒactiveEffectè¿˜åªæ˜¯innerEffectçš„å€¼ï¼Œå¹¶ä¸”åªè§¦å‘äº†innerEffectçš„æ•ˆæœã€‚</p><p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªå‰¯ä½œç”¨å‡½æ•°æ ˆ effectStackï¼Œåœ¨å‰¯ä½œç”¨å‡½æ•°æ‰§è¡Œæ—¶ï¼Œå°†å½“å‰å‰¯ä½œç”¨å‡½æ•°å‹å…¥æ ˆä¸­ï¼Œå¾…å‰¯ä½œç”¨å‡½æ•°æ‰§è¡Œå®Œæ¯•åå°†å…¶ä»æ ˆä¸­å¼¹å‡ºï¼Œå¹¶å§‹ç»ˆè®© activeEffect æŒ‡å‘æ ˆé¡¶çš„å‰¯ä½œç”¨å‡½æ•°ã€‚è¿™æ ·å°±èƒ½åšåˆ°ä¸€ä¸ªå“åº”å¼æ•°æ®åªä¼šæ”¶é›†ç›´æ¥è¯»å–å…¶å€¼çš„å‰¯ä½œç”¨å‡½æ•°ï¼Œè€Œä¸ä¼šå‡ºç°äº’ç›¸å½±å“çš„æƒ…å†µï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// ç”¨ä¸€ä¸ªå…¨å±€å˜é‡å­˜å‚¨å½“å‰æ¿€æ´»çš„ effect å‡½æ•°</span><span class="token keyword">let</span> activeEffect<span class="token punctuation">;</span><span class="token comment">// effect æ ˆ</span><span class="token keyword">const</span> effectStack <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> <span class="token function-variable function">effectFn</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token function">cleanup</span><span class="token punctuation">(</span>effectFn<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// è°ƒç”¨ cleanup å‡½æ•°ï¼Œå…·ä½“å®ç°éœ€è¦æ ¹æ®éœ€æ±‚è¡¥å……</span>    activeEffect <span class="token operator">=</span> effectFn<span class="token punctuation">;</span>    <span class="token comment">// å°†å½“å‰å‰¯ä½œç”¨å‡½æ•°å‹å…¥æ ˆä¸­</span>    effectStack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>effectFn<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// åœ¨å½“å‰å‰¯ä½œç”¨å‡½æ•°æ‰§è¡Œå®Œæ¯•åï¼Œå°†å½“å‰å‰¯ä½œç”¨å‡½æ•°å¼¹å‡ºæ ˆï¼Œå¹¶æŠŠ activeEffect è¿˜åŸä¸ºä¹‹å‰çš„å€¼</span>    effectStack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    activeEffect <span class="token operator">=</span> effectStack<span class="token punctuation">[</span>effectStack<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token comment">// åˆå§‹åŒ–å‰¯ä½œç”¨å‡½æ•°çš„ä¾èµ–é›†åˆ</span>  effectFn<span class="token punctuation">.</span>deps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// æ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°</span>  <span class="token function">effectFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
    
    
      
      
    <summary type="html">&lt;h2&gt;&lt;span id=&quot;å¼•è¨€&quot;&gt;å¼•è¨€&lt;/span&gt;&lt;/h2&gt;
&lt;p&gt;effect å‰¯ä½œç”¨å‡½æ•°æ˜¯å¯ä»¥å‘ç”ŸåµŒå¥—çš„ï¼Œè‡³äºä¸ºä»€ä¹ˆè¦è®¾è®¡æˆè¿™æ ·å‘¢&lt;/p&gt;
&lt;h2&gt;&lt;span id=&quot;åµŒå¥—çš„-effect&quot;&gt;åµŒå¥—çš„ effect&lt;/span&gt;&lt;/h2&gt;
&lt;pre class=&quot;line-</summary>
      
    
    
    
    <category term="Vue" scheme="https://ikkkp.github.io/categories/Vue/"/>
    
    
    <category term="Vue" scheme="https://ikkkp.github.io/tags/Vue/"/>
    
  </entry>
  
  <entry>
    <title>Nested Effects and Effect Stack</title>
    <link href="https://ikkkp.github.io/2023/10/31/en/vue-effect/"/>
    <id>https://ikkkp.github.io/2023/10/31/en/vue-effect/</id>
    <published>2023-10-31T02:09:08.000Z</published>
    <updated>2023-11-03T14:08:48.536Z</updated>
    
    <content type="html"><![CDATA[<h2><span id="introduction">Introduction</span></h2><p>Effect functions can be nested. But why is this design choice made?</p><h2><span id="nested-effects">Nested Effects</span></h2><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">effect</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">effectFn1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token function">effect</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">effectFn2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* ... */</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token comment">/* ... */</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>In the code above, <code>effectFn1</code> is nested within <code>effectFn2</code>. The execution of <code>effectFn1</code> will trigger the execution of <code>effectFn2</code>. So, when do we encounter nested effects? Take Vue.js, for example; Vue.jsâ€™s rendering function is executed within an effect.</p><p>When components are nested, for instance, when the Foo component renders the Bar component:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// Bar component</span><span class="token keyword">const</span> Bar <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">/* ... */</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token comment">// Foo component renders the Bar component</span><span class="token keyword">const</span> Foo <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token operator">&lt;</span>Bar <span class="token operator">/</span><span class="token operator">></span> <span class="token punctuation">&#125;</span><span class="token comment">// JSX syntax</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Nested effects occur in this scenario. It can be visualized as follows:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  Foo<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">// Nested</span>  <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    Bar<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>The <code>effect</code> function can be nested, meaning an <code>effect</code> function can contain another <code>effect</code> function. When an outer <code>effect</code> function depends on reactive data created inside an inner <code>effect</code> function, the inner <code>effect</code> function is automatically tracked, ensuring that the outer <code>effect</code> function is executed when the inner <code>effect</code> function changes.</p><p>This nested structure of effect functions establishes a dependency chain, ensuring that when reactive data changes, all the effect functions dependent on it are triggered, thereby maintaining the responsiveness of the application.</p><p>The â€œeffect stackâ€ in Vue 3â€™s internal implementation is crucial. Vue uses an effect stack to track the currently executing effect functions, similar to a function call stack. This stack manages the execution order and dependency relationships of effect functions.</p><p>Now, letâ€™s consider an example of a nested <code>effect</code> function without using a stack structure. However, it cannot achieve the desired nesting functionality. Letâ€™s assume we have two reactive data, <code>count1</code> and <code>count2</code>, where the value of <code>count2</code> depends on the value of <code>count1</code>. We can use nested <code>effect</code> functions to establish this dependency relationship.</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// Original data</span><span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">bar</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">// Proxy object</span><span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>  <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Reading property: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>key<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// Global variables</span><span class="token keyword">let</span> temp1<span class="token punctuation">,</span> temp2<span class="token punctuation">;</span><span class="token comment">// effectFn1 is nested within effectFn2</span><span class="token function">effect</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">effectFn1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'effectFn1 executed'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">effect</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">effectFn2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'effectFn2 executed'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// Access obj.bar property within effectFn2</span>    temp2 <span class="token operator">=</span> obj<span class="token punctuation">.</span>bar<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// Access obj.foo property within effectFn1</span>  temp1 <span class="token operator">=</span> obj<span class="token punctuation">.</span>foo<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>effectFn1</code> is the outer <code>effect</code> function, which depends on the value of <code>obj.foo</code>. It contains an <code>innerEffect</code> within it. The inner <code>effect</code> function, <code>effectFn2</code>, depends on the value of <code>obj.bar</code>. When we modify <code>obj.foo</code>, the outer <code>effect</code> function should be triggered and output the value of <code>obj.foo</code>. When we modify <code>obj.bar</code>, the inner <code>effect</code> function should be triggered and output the value of <code>obj.bar</code>.</p><p>We use the global variable <code>activeEffect</code> to store the effect functions registered through the <code>effect</code> function. This means that at any given time, <code>activeEffect</code> stores only one effect function.</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// Use a global variable to store the currently active effect function</span><span class="token keyword">let</span> activeEffect<span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// Define the effect function</span>  <span class="token keyword">const</span> <span class="token function-variable function">effectFn</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token comment">// Call the cleanup function; specific implementation needs to be provided based on requirements</span>    <span class="token function">cleanup</span><span class="token punctuation">(</span>effectFn<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// Assign the effect function to activeEffect</span>    activeEffect <span class="token operator">=</span> effectFn<span class="token punctuation">;</span>    <span class="token comment">// Execute the effect function</span>    <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// Store the dependencies of the current effect function in effectFn.deps (Needs to be implemented based on the actual logic)</span>    effectFn<span class="token punctuation">.</span>deps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// Set dependencies collection based on the actual logic</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token comment">// Execute the effect function</span>  <span class="token function">effectFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>However, by only using a single variable for storage without employing a stack structure, when nested effects occur, the execution of the inner effect function will overwrite the value of <code>activeEffect</code>. It will never be restored to its original value. If there is a reactive data performing dependency collection, even if it is read within the outer effect function, the collected effect functions will all be from the inner effect function. In other words, when I read <code>obj.foo</code>, <code>activeEffect</code> still refers to the value of <code>innerEffect</code>, and only the <code>innerEffect</code> is triggered.</p><p>To solve this issue, we need an effect function stack called <code>effectStack</code>. When an effect function is executed, the current effect function is pushed onto the stack. After the execution of the effect function is completed, it is popped from the stack. The <code>activeEffect</code> is always set to the top effect function on the stack. This ensures that a reactive data will only collect the effect function that directly reads its value, preventing mutual interference:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// Use a global variable to store the currently active effect function</span><span class="token keyword">let</span> activeEffect<span class="token punctuation">;</span><span class="token comment">// Effect stack</span><span class="token keyword">const</span> effectStack <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> <span class="token function-variable function">effectFn</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token function">cleanup</span><span class="token punctuation">(</span>effectFn<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Call the cleanup function; specific implementation needs to be provided based on requirements</span>    activeEffect <span class="token operator">=</span> effectFn<span class="token punctuation">;</span>    <span class="token comment">// Push the current effect function onto the stack</span>    effectStack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>effectFn<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// After the execution of the current effect function is completed, pop it from the stack, and restore activeEffect to its previous value</span>    effectStack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    activeEffect <span class="token operator">=</span> effectStack<span class="token punctuation">[</span>effectStack<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token comment">// Initialize the dependencies collection of the effect function</span>  effectFn<span class="token punctuation">.</span>deps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// Execute the effect function</span>  <span class="token function">effectFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><p><em>Note: This article is a translated version of the original post. For the most accurate and up-to-date information, please refer to the original source.</em></p><pre><code></code></pre>]]></content>
    
    
      
      
    <summary type="html">&lt;h2&gt;&lt;span id=&quot;introduction&quot;&gt;Introduction&lt;/span&gt;&lt;/h2&gt;
&lt;p&gt;Effect functions can be nested. But why is this design choice made?&lt;/p&gt;
&lt;h2&gt;&lt;span id</summary>
      
    
    
    
    <category term="Vue" scheme="https://ikkkp.github.io/categories/Vue/"/>
    
    
    <category term="Vue" scheme="https://ikkkp.github.io/tags/Vue/"/>
    
  </entry>
  
  <entry>
    <title>Vue.js å“åº”å¼ç³»ç»Ÿçš„ä½œç”¨ä¸å®ç°</title>
    <link href="https://ikkkp.github.io/2023/10/30/vue-reactive-1/"/>
    <id>https://ikkkp.github.io/2023/10/30/vue-reactive-1/</id>
    <published>2023-10-30T09:20:32.000Z</published>
    <updated>2023-10-30T16:01:16.391Z</updated>
    
    <content type="html"><![CDATA[<h2><span id="å¼•è¨€">å¼•è¨€</span></h2><p>å“åº”å¼è¿™ä¸€ä¸ªæ¦‚å¿µåº”è¯¥ä¸éš¾ç†è§£ï¼Œå°±æ˜¯jsåœ¨å¯¹æŸä¸€ä¸ªå¯¹è±¡æˆ–è€…æŸä¸€ä¸ªå€¼è¿›è¡Œæ“ä½œæ—¶ï¼Œæˆ‘ä»¬å¸Œæœ›é€šè¿‡å®ç°ä¸€ä¸ªå“åº”å¼ç³»ç»Ÿè¾¾åˆ°è§¦å‘æŸäº›äº‹ä»¶ï¼Œä¹Ÿå°±æ˜¯å¯¹æ“ä½œçš„ç›¸åº”ã€‚</p><h2><span id="å“åº”å¼æ•°æ®ä¸å‰¯ä½œç”¨å‡½æ•°">å“åº”å¼æ•°æ®ä¸å‰¯ä½œç”¨å‡½æ•°</span></h2><p>å‰¯ä½œç”¨å‡½æ•°æŒ‡çš„æ˜¯ä¼šäº§ç”Ÿå‰¯ä½œç”¨çš„å‡½æ•°ï¼Œå¦‚ä¸‹é¢çš„ä»£ç æ‰€ç¤ºï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>innerText <span class="token operator">=</span> <span class="token string">'hello vue3'</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>å½“ effect å‡½æ•°æ‰§è¡Œæ—¶ï¼Œå®ƒä¼šè®¾ç½® body çš„æ–‡æœ¬å†…å®¹ï¼Œä½†é™¤äº†effect å‡½æ•°ä¹‹å¤–çš„ä»»ä½•å‡½æ•°éƒ½å¯ä»¥è¯»å–æˆ–è®¾ç½® body çš„æ–‡æœ¬å†…å®¹ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œeffect å‡½æ•°çš„æ‰§è¡Œä¼šç›´æ¥æˆ–é—´æ¥å½±å“å…¶ä»–å‡½æ•°çš„æ‰§è¡Œï¼Œè¿™æ—¶æˆ‘ä»¬è¯´ effect å‡½æ•°äº§ç”Ÿäº†å‰¯ä½œç”¨ã€‚</p><p>å…¶å®å‰¯ä½œç”¨å‡½æ•°å¹¶ä¸å°‘è§ï¼Œæˆ‘ä»¬å‰é¢åœ¨è®¨è®ºwebpackçš„ <code>tree shaking</code> è¯é¢˜é‡Œé¢æ¶‰åŠåˆ°çš„æ˜¯å¦è¿›è¡Œæ•°æ®æµå¤„ç†å¯¹ <code>tree shaking</code> çš„æ•ˆæœæ˜¯ä¸å¯å¿½ç•¥çš„ã€‚è¿™è¾¹ä¸å†èµ˜è¿°ã€‚</p><p>å‰¯ä½œç”¨å¾ˆå®¹æ˜“äº§ç”Ÿï¼Œä¾‹å¦‚ä¸€ä¸ªå‡½æ•°ä¿®æ”¹äº†å…¨å±€å˜é‡ï¼Œè¿™å…¶å®ä¹Ÿæ˜¯ä¸€ä¸ªå‰¯ä½œç”¨ï¼Œå¦‚ä¸‹é¢çš„ä»£ç æ‰€ç¤ºï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// å…¨å±€å˜é‡</span><span class="token keyword">let</span> val <span class="token operator">=</span> <span class="token number">1</span><span class="token keyword">function</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  val <span class="token operator">=</span> <span class="token number">2</span> <span class="token comment">// ä¿®æ”¹å…¨å±€å˜é‡ï¼Œäº§ç”Ÿå‰¯ä½œç”¨</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç†è§£äº†ä»€ä¹ˆæ˜¯å‰¯ä½œç”¨å‡½æ•°ï¼Œå†æ¥è¯´è¯´ä»€ä¹ˆæ˜¯å“åº”å¼æ•°æ®ã€‚å‡è®¾åœ¨ä¸€ä¸ªå‰¯ä½œç”¨å‡½æ•°ä¸­è¯»å–äº†æŸä¸ªå¯¹è±¡çš„å±æ€§ï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">text</span><span class="token operator">:</span> <span class="token string">'hello world'</span> <span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// effect å‡½æ•°çš„æ‰§è¡Œä¼šè¯»å– obj.text</span>  document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>innerText <span class="token operator">=</span> obj<span class="token punctuation">.</span>text<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å‰¯ä½œç”¨å‡½æ•° effect ä¼šè®¾ç½® body å…ƒç´ çš„ <code>innerText</code> å±æ€§ï¼Œå…¶å€¼ä¸º <code>obj.text</code>ï¼Œå½“ <code>obj.text</code> çš„å€¼å‘ç”Ÿå˜åŒ–æ—¶ï¼Œæˆ‘ä»¬å¸Œæœ›å‰¯ä½œç”¨å‡½æ•° effect ä¼šé‡æ–°æ‰§è¡Œã€‚</p><p>é‚£è¿™æ ·æˆ‘ä»¬çš„æ€è·¯å°±å˜æˆäº†ï¼šé€šè¿‡ä¸€äº›æ‰‹æ®µï¼Œåœ¨è¯»å– <code>obj.text</code> å€¼çš„æ—¶å€™å¯ä»¥å°†effectå‡½æ•°å‚¨å­˜è¿›ä¸€ä¸ªbucketé‡Œé¢ï¼Œè€Œåœ¨è®¾ç½®<code>obj.text</code> å€¼çš„æ—¶å€™å¯ä»¥åœ¨bucketé‡Œé¢æŠŠeffectæ‹¿å‡ºæ¥æ‰§è¡Œã€‚</p><h2><span id="å“åº”å¼æ•°æ®çš„åŸºæœ¬å®ç°">å“åº”å¼æ•°æ®çš„åŸºæœ¬å®ç°</span></h2><p>å¦‚ä½•æ‰èƒ½è®© obj å˜æˆå“åº”å¼æ•°æ®å‘¢ï¼Ÿé€šè¿‡è§‚å¯Ÿæˆ‘ä»¬èƒ½å‘ç°ï¼š</p><ul><li>å½“å‰¯ä½œç”¨å‡½æ•° effect æ‰§è¡Œæ—¶ï¼Œä¼šè§¦å‘å­—æ®µ obj.text çš„è¯»å–æ“ä½œï¼›</li><li>å½“ä¿®æ”¹ obj.text çš„å€¼æ—¶ï¼Œä¼šè§¦å‘å­—æ®µ obj.text çš„è®¾ç½®æ“ä½œã€‚</li></ul><p>å¦‚ä½•æ‹¦æˆªä¸€ä¸ªå¯¹è±¡å±æ€§çš„è¯»å–å’Œè®¾ç½®æ“ä½œã€‚</p><p>åœ¨ ES2015 ä¹‹å‰ï¼Œåªèƒ½é€šè¿‡ Object.defineProperty å‡½æ•°å®ç°ï¼Œè¿™ä¹Ÿæ˜¯ Vue.js 2 æ‰€é‡‡ç”¨çš„æ–¹å¼ã€‚åœ¨ ES2015+ ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»£ç†å¯¹è±¡ Proxy æ¥å®ç°ï¼Œè¿™ä¹Ÿæ˜¯ Vue.js 3 æ‰€é‡‡ç”¨çš„æ–¹å¼ã€‚</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">createReactiveObject</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> proxyMap<span class="token punctuation">,</span> baseHandlers</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// æ ¸å¿ƒå°±æ˜¯ proxy</span>  <span class="token comment">// ç›®çš„æ˜¯å¯ä»¥ä¾¦å¬åˆ°ç”¨æˆ· get æˆ–è€… set çš„åŠ¨ä½œ</span>  <span class="token keyword">const</span> existingProxy <span class="token operator">=</span> proxyMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>existingProxy<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> existingProxy<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">const</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> baseHandlers<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// æŠŠåˆ›å»ºå¥½çš„ proxy ç»™å­˜èµ·æ¥ï¼Œ</span>  proxyMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> proxy<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> proxy<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™æ ·æˆ‘ä»¬å°±åŸºäº proxy åˆ›å»ºäº†ä¸€ä¸ªç”¨äºå­˜å‚¨å‰¯ä½œç”¨å‡½æ•°ï¼Œå¹¶ä¸”æˆ‘ä»¬ä½¿ç”¨äº†ä¸€ä¸ªproxyMapï¼Œè¿™æ˜¯ä¸€ä¸ªå¯ä»¥æŠŠå„ç±»å‹çš„proxyå‚¨å­˜èµ·æ¥çš„å®¹å™¨ã€‚æˆ‘ä»¬åˆ†åˆ«è®¾ç½®äº† get å’Œ set æ‹¦æˆªå‡½æ•°ï¼Œç”¨äºæ‹¦æˆªè¯»å–å’Œè®¾ç½®æ“ä½œã€‚</p><h2><span id="è®¾è®¡ä¸€ä¸ªå®Œå–„çš„å“åº”ç³»ç»Ÿ">è®¾è®¡ä¸€ä¸ªå®Œå–„çš„å“åº”ç³»ç»Ÿ</span></h2><p>ä»ä¸Šé¢çš„ç¤ºä¾‹ä¸éš¾çœ‹å‡ºï¼Œä¸€ä¸ªå“åº”ç³»ç»Ÿçš„å·¥ä½œæµç¨‹å¦‚ä¸‹ï¼š</p><ul><li><p>å½“è¯»å–æ“ä½œå‘ç”Ÿæ—¶ï¼Œå°†å‰¯ä½œç”¨å‡½æ•°æ”¶é›†åˆ°â€œæ¡¶â€ä¸­ï¼›</p></li><li><p>å½“è®¾ç½®æ“ä½œå‘ç”Ÿæ—¶ï¼Œä»â€œæ¡¶â€ä¸­å–å‡ºå‰¯ä½œç”¨å‡½æ•°å¹¶æ‰§è¡Œã€‚</p></li></ul><p>ä¸‹é¢é€šè¿‡ä¸€ä¸ªç®€å•çš„å“åº”å¼ç³»ç»Ÿå®ç°æ¥è®²è§£åŸç†ï¼š</p><p>æˆ‘ä»¬çŸ¥é“proxyå¯¹è±¡æ˜¯å¯ä»¥ä¼ å…¥ä¸€ä¸ªå…·æœ‰getterå’Œsetterçš„å¯¹è±¡è¿›è¡Œgetæˆ–setæ“ä½œæ—¶å¤„ç†çš„å‡½æ•°ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ª<code>baseHandlers</code>ï¼Œè¿›è¡Œgetterå’Œsetterçš„ç®¡ç†ã€‚</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">//baseHandlers</span><span class="token keyword">function</span> <span class="token function">createGetter</span><span class="token punctuation">(</span><span class="token parameter">isReadonly <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> shallow <span class="token operator">=</span> <span class="token boolean">false</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//Reflect.getæ–¹æ³•å…è®¸ä½ ä»ä¸€ä¸ªå¯¹è±¡ä¸­å–å±æ€§å€¼ã€‚å°±å¦‚åŒå±æ€§è®¿é—®å™¨è¯­æ³•ï¼Œä½†å´æ˜¯é€šè¿‡å‡½æ•°è°ƒç”¨æ¥å®ç°</span>    <span class="token keyword">const</span> res <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isReadonly<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token comment">// åœ¨è§¦å‘ get çš„æ—¶å€™è¿›è¡Œä¾èµ–æ”¶é›†</span>      <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token string">"get"</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> res<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">createSetter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">const</span> result <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// åœ¨è§¦å‘ set çš„æ—¶å€™è¿›è¡Œè§¦å‘ä¾èµ–</span>    <span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token string">"set"</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> result<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æˆ‘ä»¬è¿˜éœ€è¦åœ¨å‰¯ä½œç”¨å‡½æ•°ä¸è¢«æ“ä½œçš„ç›®æ ‡å­—æ®µä¹‹é—´å»ºç«‹æ˜ç¡®çš„è”ç³»ã€‚<br>ä¾‹å¦‚å½“è¯»å–å±æ€§æ—¶ï¼Œæ— è®ºè¯»å–çš„æ˜¯å“ªä¸€ä¸ªå±æ€§ï¼Œå…¶å®éƒ½ä¸€æ ·ï¼Œéƒ½ä¼šæŠŠå‰¯ä½œç”¨å‡½æ•°æ”¶é›†åˆ°â€œæ¡¶â€é‡Œï¼›å½“è®¾ç½®å±æ€§æ—¶ï¼Œæ— è®ºè®¾ç½®çš„æ˜¯å“ªä¸€ä¸ªå±æ€§ï¼Œä¹Ÿéƒ½ä¼šæŠŠâ€œæ¡¶â€é‡Œçš„å‰¯ä½œç”¨å‡½æ•°å–å‡ºå¹¶æ‰§è¡Œã€‚å‰¯ä½œç”¨å‡½æ•°ä¸è¢«æ“ä½œçš„å­—æ®µä¹‹é—´æ²¡æœ‰æ˜ç¡®çš„è”ç³»ã€‚è§£å†³æ–¹æ³•å¾ˆç®€å•ï¼Œåªéœ€è¦åœ¨å‰¯ä½œç”¨å‡½æ•°ä¸è¢«æ“ä½œçš„å­—æ®µä¹‹é—´å»ºç«‹è”ç³»å³å¯ï¼Œè¿™å°±éœ€è¦æˆ‘ä»¬é‡æ–°è®¾è®¡â€œæ¡¶â€çš„æ•°æ®ç»“æ„ï¼Œè€Œä¸èƒ½ç®€å•åœ°ä½¿ç”¨ä¸€ä¸ªSet ç±»å‹çš„æ•°æ®ä½œä¸ºâ€œæ¡¶â€äº†ã€‚</p><p>æˆ‘ä»¬é€šè¿‡<code>WeakMap</code>æ¥å®ç°åˆšæ‰ä¸Šé¢æˆ‘ä»¬è¯´çš„å‚¨å­˜effectçš„bucketã€‚ä¸äº†è§£WeakMapç±»çš„ç‰¹æ€§çš„å¯ä»¥çœ‹ä¸‹<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/WeakMap">WeakMap å¯¹è±¡æ˜¯ä¸€ç»„é”®/å€¼å¯¹çš„é›†åˆ</a></p><p>WeakMap çš„é”®æ˜¯åŸå§‹å¯¹è±¡ targetï¼ŒWeakMap çš„å€¼æ˜¯ä¸€ä¸ªMap å®ä¾‹ï¼Œè€Œ Map çš„é”®æ˜¯åŸå§‹å¯¹è±¡ target çš„ keyï¼ŒMap çš„å€¼æ˜¯ä¸€ä¸ªç”±å‰¯ä½œç”¨å‡½æ•°ç»„æˆçš„ Setã€‚</p><p><img src="/img/vue-reactive-1/WeakMap.png" alt="WeakMap"></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">//Mapå­˜æ”¾ä¸åŒç±»å‹çš„ä»£ç†</span><span class="token keyword">export</span> <span class="token keyword">const</span> reactiveMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">const</span> readonlyMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">const</span> shallowReadonlyMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>å®šä¹‰å¥½äº†ä¸Šé¢çš„å‡ ç§bucketï¼Œæˆ‘ä»¬å¼€å§‹å®ç°å“åº”å¼ç³»ç»Ÿæœ€æ ¸å¿ƒçš„éƒ¨åˆ†ï¼Œä¹Ÿå°±æ˜¯proxyçš„å®ç°ï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">createReactiveObject</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> proxyMap<span class="token punctuation">,</span> baseHandlers</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// æ ¸å¿ƒå°±æ˜¯ proxy</span>  <span class="token comment">// ç›®çš„æ˜¯å¯ä»¥ä¾¦å¬åˆ°ç”¨æˆ· get æˆ–è€… set çš„åŠ¨ä½œ</span>  <span class="token keyword">const</span> existingProxy <span class="token operator">=</span> proxyMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>existingProxy<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> existingProxy<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>    <span class="token keyword">const</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> baseHandlers<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// æŠŠåˆ›å»ºå¥½çš„ proxy ç»™å­˜èµ·æ¥ï¼Œ</span>  proxyMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> proxy<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> proxy<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯¹äºå‰é¢çš„trickå’Œtriggerï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">track</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> type<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isTracking</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">è§¦å‘ track -> target: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>target<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> type:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>type<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> key:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>key<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 1. å…ˆåŸºäº target æ‰¾åˆ°å¯¹åº”çš„ dep</span>  <span class="token comment">// å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡çš„è¯ï¼Œé‚£ä¹ˆå°±éœ€è¦åˆå§‹åŒ–</span>  <span class="token keyword">let</span> depsMap <span class="token operator">=</span> targetMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>depsMap<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// åˆå§‹åŒ– depsMap çš„é€»è¾‘</span>    depsMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    targetMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> depsMap<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">let</span> dep <span class="token operator">=</span> depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dep<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    dep <span class="token operator">=</span> <span class="token function">createDep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    depsMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> dep<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token function">trackEffects</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> type<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// 1. å…ˆæ”¶é›†æ‰€æœ‰çš„ dep æ”¾åˆ° deps é‡Œé¢ï¼Œ</span>  <span class="token comment">// åé¢ä¼šç»Ÿä¸€å¤„ç†</span>  <span class="token keyword">let</span> <span class="token literal-property property">deps</span><span class="token operator">:</span> Array<span class="token operator">&lt;</span>any<span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> depsMap <span class="token operator">=</span> targetMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>depsMap<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>  <span class="token comment">// æš‚æ—¶åªå®ç°äº† GET ç±»å‹</span>  <span class="token comment">// get ç±»å‹åªéœ€è¦å–å‡ºæ¥å°±å¯ä»¥</span>  <span class="token keyword">const</span> dep <span class="token operator">=</span> depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// æœ€åæ”¶é›†åˆ° deps å†…</span>  deps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> <span class="token literal-property property">effects</span><span class="token operator">:</span> Array<span class="token operator">&lt;</span>any<span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  deps<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">dep</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token comment">// è¿™é‡Œè§£æ„ dep å¾—åˆ°çš„æ˜¯ dep å†…éƒ¨å­˜å‚¨çš„ effect</span>    effects<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>dep<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// è¿™é‡Œçš„ç›®çš„æ˜¯åªæœ‰ä¸€ä¸ª dep ï¼Œè¿™ä¸ªdep é‡Œé¢åŒ…å«æ‰€æœ‰çš„ effect</span>  <span class="token comment">// è¿™é‡Œçš„ç›®å‰åº”è¯¥æ˜¯ä¸ºäº† triggerEffects è¿™ä¸ªå‡½æ•°çš„å¤ç”¨</span>  <span class="token function">triggerEffects</span><span class="token punctuation">(</span><span class="token function">createDep</span><span class="token punctuation">(</span>effects<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
    
    
      
      
    <summary type="html">&lt;h2&gt;&lt;span id=&quot;å¼•è¨€&quot;&gt;å¼•è¨€&lt;/span&gt;&lt;/h2&gt;
&lt;p&gt;å“åº”å¼è¿™ä¸€ä¸ªæ¦‚å¿µåº”è¯¥ä¸éš¾ç†è§£ï¼Œå°±æ˜¯jsåœ¨å¯¹æŸä¸€ä¸ªå¯¹è±¡æˆ–è€…æŸä¸€ä¸ªå€¼è¿›è¡Œæ“ä½œæ—¶ï¼Œæˆ‘ä»¬å¸Œæœ›é€šè¿‡å®ç°ä¸€ä¸ªå“åº”å¼ç³»ç»Ÿè¾¾åˆ°è§¦å‘æŸäº›äº‹ä»¶ï¼Œä¹Ÿå°±æ˜¯å¯¹æ“ä½œçš„ç›¸åº”ã€‚&lt;/p&gt;
&lt;h2&gt;&lt;span id=&quot;å“åº”å¼æ•°æ®ä¸å‰¯ä½œç”¨å‡½æ•°&quot;&gt;</summary>
      
    
    
    
    <category term="Vue" scheme="https://ikkkp.github.io/categories/Vue/"/>
    
    
    <category term="Vue" scheme="https://ikkkp.github.io/tags/Vue/"/>
    
  </entry>
  
  <entry>
    <title>The Role and Implementation of Vue.js Reactive System</title>
    <link href="https://ikkkp.github.io/2023/10/30/en/vue-reactive-1/"/>
    <id>https://ikkkp.github.io/2023/10/30/en/vue-reactive-1/</id>
    <published>2023-10-30T09:20:32.000Z</published>
    <updated>2023-11-03T14:08:52.024Z</updated>
    
    <content type="html"><![CDATA[<h2><span id="introduction">Introduction</span></h2><p>The concept of reactivity is not difficult to understand. It refers to triggering certain events when JavaScript operates on an object or a value. This is achieved by implementing a reactive system, where operations elicit specific responses.</p><h2><span id="reactive-data-and-side-effect-functions">Reactive Data and Side Effect Functions</span></h2><p>Side effect functions refer to functions that produce side effects. Consider the following code snippet:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>innerText <span class="token operator">=</span> <span class="token string">'hello vue3'</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>When the <code>effect</code> function is executed, it sets the text content of the body. Any function other than <code>effect</code> can read or modify the bodyâ€™s text content. In other words, the execution of the <code>effect</code> function directly or indirectly affects the execution of other functions, indicating that the <code>effect</code> function has side effects.</p><p>Side effect functions are common and can impact various aspects, such as the effectiveness of â€œtree shakingâ€ in webpack, a topic we discussed earlier. I wonâ€™t delve into this here.</p><p>Side effects can easily occur; for example, if a function modifies a global variable, it creates a side effect, as shown in the following code:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// Global variable</span><span class="token keyword">let</span> val <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  val <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// Modifying a global variable creates a side effect</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Understanding side effect functions, letâ€™s now discuss reactive data. Suppose a property of an object is read within a side effect function:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">text</span><span class="token operator">:</span> <span class="token string">'hello world'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// The execution of the effect function reads obj.text</span>  document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>innerText <span class="token operator">=</span> obj<span class="token punctuation">.</span>text<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>The side effect function <code>effect</code> sets the <code>innerText</code> property of the body element to <code>obj.text</code>. When the value of <code>obj.text</code> changes, we want the side effect function <code>effect</code> to re-execute.</p><p>Our approach is as follows: we want to store the <code>effect</code> function in a bucket when reading the <code>obj.text</code> value, and when setting the <code>obj.text</code> value, we want to retrieve the <code>effect</code> function from the bucket and execute it.</p><h2><span id="basic-implementation-of-reactive-data">Basic Implementation of Reactive Data</span></h2><p>How can we make <code>obj</code> reactive data? By observing, we find that:</p><ul><li>When the side effect function <code>effect</code> is executed, it triggers the read operation of the <code>obj.text</code> property.</li><li>When the <code>obj.text</code> value is modified, it triggers the write operation of the <code>obj.text</code> property.</li></ul><p>We need to intercept the read and write operations of an object property.</p><p>Before ES2015, this could only be done using the <code>Object.defineProperty</code> function, which was also the approach used in Vue.js 2. In ES2015 and later, we can use the Proxy object to achieve this, and this is the approach adopted in Vue.js 3.</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">createReactiveObject</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> proxyMap<span class="token punctuation">,</span> baseHandlers</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// The core is the proxy</span>  <span class="token comment">// The goal is to detect user get or set actions</span>  <span class="token keyword">const</span> existingProxy <span class="token operator">=</span> proxyMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>existingProxy<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> existingProxy<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">const</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> baseHandlers<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// Store the created proxy,</span>  proxyMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> proxy<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> proxy<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Here, we create a reactive object based on the Proxy object. We have a <code>proxyMap</code>, which is a container for storing various types of proxies. We define <code>get</code> and <code>set</code> intercept functions to intercept read and write operations.</p><h2><span id="designing-a-comprehensive-reactive-system">Designing a Comprehensive Reactive System</span></h2><p>From the above examples, itâ€™s clear that the workflow of a reactive system is as follows:</p><ul><li>When a read operation occurs, collect the side effect functions into a â€œbucketâ€.</li><li>When a write operation occurs, retrieve the side effect functions from the â€œbucketâ€ and execute them.</li></ul><p>Next, Iâ€™ll explain the principles through a simple implementation of a reactive system.</p><p>We know that the Proxy object can accept an object with getters and setters for handling get or set operations. Therefore, we can create a <code>baseHandlers</code> to manage getters and setters.</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// baseHandlers</span><span class="token keyword">function</span> <span class="token function">createGetter</span><span class="token punctuation">(</span><span class="token parameter">isReadonly <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> shallow <span class="token operator">=</span> <span class="token boolean">false</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">const</span> res <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isReadonly<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token comment">// Collect dependencies when triggering get</span>      <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token string">"get"</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> res<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">createSetter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">const</span> result <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// Trigger dependencies when setting values</span>    <span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token string">"set"</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> result<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>We also need to establish a clear link between side effect functions and the target fields being operated upon. For instance, when reading a property, it doesnâ€™t matter which property is being read; all side effect functions should be collected into the â€œbucket.â€ Similarly, when setting a property, regardless of which property is being set, the side effect functions from the â€œbucketâ€ should be retrieved and executed. There is no explicit connection between side effect functions and the operated fields. The solution is simple: we need to establish a connection between side effect functions and the operated fields. This requires redesigning the data structure of the â€œbucketâ€ and cannot be as simple as using a Set type for the â€œbucket.â€</p><p>We use <code>WeakMap</code> to implement the bucket for storing effects as discussed earlier. If you are not familiar with the characteristics of the WeakMap class, you can learn more about it <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/WeakMap">here</a>.</p><p><img src="/img/vue-reactive-1/WeakMap.png" alt="WeakMap"></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// Map to store different types of proxies</span><span class="token keyword">export</span> <span class="token keyword">const</span> reactiveMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">const</span> readonlyMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">const</span> shallowReadonlyMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>Once we have defined the buckets as above, we can proceed to implement the core part of the reactive system, which is the proxy:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">createReactiveObject</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> proxyMap<span class="token punctuation">,</span> baseHandlers</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// The core is the proxy</span>  <span class="token comment">// The goal is to detect user get or set actions</span>  <span class="token keyword">const</span> existingProxy <span class="token operator">=</span> proxyMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>existingProxy<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> existingProxy<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>    <span class="token keyword">const</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> baseHandlers<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// Store the created proxy</span>  proxyMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> proxy<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> proxy<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>For the previous <code>track</code> and <code>trigger</code> functions:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">track</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> type<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isTracking</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Trigger track -> target: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>target<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> type:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>type<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> key:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>key<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 1. Find the corresponding dep based on the target</span>  <span class="token comment">// Initialize depsMap if it's the first time</span>  <span class="token keyword">let</span> depsMap <span class="token operator">=</span> targetMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>depsMap<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// Initialize depsMap logic</span>    depsMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    targetMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> depsMap<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">let</span> dep <span class="token operator">=</span> depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dep<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    dep <span class="token operator">=</span> <span class="token function">createDep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    depsMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> dep<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token function">trackEffects</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> type<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// 1. Collect all deps and put them into deps array,</span>  <span class="token comment">// which will be processed later</span>  <span class="token keyword">let</span> <span class="token literal-property property">deps</span><span class="token operator">:</span> Array<span class="token operator">&lt;</span>any<span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> depsMap <span class="token operator">=</span> targetMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>depsMap<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>  <span class="token comment">// Currently only GET type is implemented</span>  <span class="token comment">// for get type, just retrieve it</span>  <span class="token keyword">const</span> dep <span class="token operator">=</span> depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// Collect into deps array</span>  deps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> <span class="token literal-property property">effects</span><span class="token operator">:</span> Array<span class="token operator">&lt;</span>any<span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  deps<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">dep</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token comment">// Destructure dep to get the stored effects</span>    effects<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>dep<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// The purpose here is to have only one dep that contains all effects</span>  <span class="token comment">// Currently, it should be reused for the triggerEffects function</span>  <span class="token function">triggerEffects</span><span class="token punctuation">(</span><span class="token function">createDep</span><span class="token punctuation">(</span>effects<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><p><em>Note: This article is a translated version of the original post. For the most accurate and up-to-date information, please refer to the original source.</em></p><pre><code></code></pre>]]></content>
    
    
      
      
    <summary type="html">&lt;h2&gt;&lt;span id=&quot;introduction&quot;&gt;Introduction&lt;/span&gt;&lt;/h2&gt;
&lt;p&gt;The concept of reactivity is not difficult to understand. It refers to triggering ce</summary>
      
    
    
    
    <category term="Vue" scheme="https://ikkkp.github.io/categories/Vue/"/>
    
    
    <category term="Vue" scheme="https://ikkkp.github.io/tags/Vue/"/>
    
  </entry>
  
  <entry>
    <title>Webpack-è‡ªå®šä¹‰ loader/plugin</title>
    <link href="https://ikkkp.github.io/2023/10/29/webpack-plugin-design/"/>
    <id>https://ikkkp.github.io/2023/10/29/webpack-plugin-design/</id>
    <published>2023-10-29T06:50:05.000Z</published>
    <updated>2023-11-04T02:30:35.564Z</updated>
    
    <content type="html"><![CDATA[<h2><span id="å¼•è¨€">å¼•è¨€</span></h2><p>loader æ˜¯å¯¼å‡ºä¸ºä¸€ä¸ªå‡½æ•°çš„ node æ¨¡å—ã€‚è¯¥å‡½æ•°åœ¨ loader è½¬æ¢èµ„æºçš„æ—¶å€™è°ƒç”¨ã€‚ç»™å®šçš„å‡½æ•°å°†è°ƒç”¨ <code>Loader API</code>ï¼Œå¹¶é€šè¿‡ this ä¸Šä¸‹æ–‡è®¿é—®ã€‚</p><p>è¿™è¾¹è´´ä¸€ä¸ªå®˜ç½‘é“¾æ¥<a href="https://webpack.docschina.org/contribute/writing-a-loader">loaderçš„ç”¨æ³•å’Œä¾‹å­ï¼Œä»¥åŠè‡ªå®šä¹‰loaderæœ¬åœ°å¼€å‘æµ‹è¯•</a></p><h2><span id="webpack-loaderçš„ç®€å•ä½¿ç”¨">Webpack Loaderçš„ç®€å•ä½¿ç”¨</span></h2><p>å½“ä¸€ä¸ª loader åœ¨èµ„æºä¸­ä½¿ç”¨ï¼Œè¿™ä¸ª loader åªèƒ½ä¼ å…¥ä¸€ä¸ªå‚æ•° - ä¸€ä¸ªåŒ…å«èµ„æºæ–‡ä»¶å†…å®¹çš„å­—ç¬¦ä¸²ã€‚</p><p>åŒæ­¥ loader å¯ä»¥ return ä¸€ä¸ªä»£è¡¨å·²è½¬æ¢æ¨¡å—ï¼ˆtransformed moduleï¼‰çš„å•ä¸€å€¼ã€‚</p><p>loader ä¼šè¿”å›ä¸€ä¸ªæˆ–è€…ä¸¤ä¸ªå€¼ã€‚ç¬¬ä¸€ä¸ªå€¼çš„ç±»å‹æ˜¯ JavaScript ä»£ç çš„å­—ç¬¦ä¸²æˆ–è€… bufferã€‚ç¬¬äºŒä¸ªå¯é€‰å€¼æ˜¯ SourceMapï¼Œå®ƒæ˜¯ä¸ª JavaScript å¯¹è±¡ã€‚</p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„loaderçš„ç”¨æ³•ï¼Œä»–å°†åŒ¹é…æ‰€æœ‰çš„jsæ–‡ä»¶ï¼Œå¹¶ä½¿ç”¨loader.jså¤„ç†</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">//webpack.config.js</span><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token comment">//...</span>  <span class="token literal-property property">module</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>    <span class="token literal-property property">rules</span><span class="token operator">:</span> <span class="token punctuation">[</span>      <span class="token punctuation">&#123;</span>        <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>        <span class="token literal-property property">use</span><span class="token operator">:</span> <span class="token punctuation">[</span>          <span class="token punctuation">&#123;</span>            <span class="token literal-property property">loader</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'path/to/loader.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token literal-property property">options</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>              <span class="token comment">/* ... */</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>          <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>        <span class="token punctuation">]</span><span class="token punctuation">,</span>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç”±ä¸Šé¢æˆ‘ä»¬å¯ä»¥çŸ¥é“loaderçš„ä½¿ç”¨æ–¹æ³•ï¼Œä½†å¯¹loaderä»…åœç•™åœ¨ä½¿ç”¨ï¼Œé‚£å…·ä½“çš„ä¸€ä¸ªloaderé•¿ä»€ä¹ˆæ ·å‘¢ï¼Ÿ</p><p>æ¯”å¦‚è¯´ä¸€ä¸ªç®€å•çš„loaderæ˜¯è¿™æ ·çš„ï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">content</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// content å°±æ˜¯ä¼ å…¥çš„æºå†…å®¹å­—ç¬¦ä¸²</span>  <span class="token keyword">return</span> content<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸€ä¸ª loader å°±æ˜¯ä¸€ä¸ªnodeæ¨¡å—ï¼Œå…¶ä¸­æš´éœ²äº†ä¸€ä¸ªå‡½æ•°ï¼Œå¹¶åªå¯ä»¥æ¥æ”¶ä¸€ä¸ªå…¥å‚ï¼Œè¿™ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªåŒ…å«åŒ…å«èµ„æºæ–‡ä»¶å†…å®¹çš„å­—ç¬¦ä¸²ï¼Œè€Œå‡½æ•°çš„è¿”å›å€¼å°±æ˜¯å¤„ç†åçš„å†…å®¹ã€‚</p><h2><span id="è‡ªå®šä¹‰webpack-loader">è‡ªå®šä¹‰webpack loader</span></h2><h3><span id="è‡ªå®šä¹‰loaderçš„ç”¨æ³•å‡†åˆ™">è‡ªå®šä¹‰loaderçš„ç”¨æ³•å‡†åˆ™</span></h3><p>ç¼–å†™ loader æ—¶åº”è¯¥éµå¾ªä»¥ä¸‹å‡†åˆ™ã€‚å®ƒä»¬æŒ‰é‡è¦ç¨‹åº¦æ’åºï¼Œæœ‰äº›ä»…é€‚ç”¨äºæŸäº›åœºæ™¯ï¼Œè¯·é˜…è¯»ä¸‹é¢è¯¦ç»†çš„ç« èŠ‚ä»¥è·å¾—æ›´å¤šä¿¡æ¯ã€‚</p><ul><li>ä¿æŒ ç®€å• ã€‚</li><li>ä½¿ç”¨ é“¾å¼ ä¼ é€’ã€‚</li><li>æ¨¡å—åŒ– çš„è¾“å‡ºã€‚</li><li>ç¡®ä¿ æ— çŠ¶æ€ ã€‚</li><li>ä½¿ç”¨ <code>loader utilities</code> ã€‚</li><li>è®°å½• <code>loader</code> çš„ä¾èµ– ã€‚</li><li>è§£æ æ¨¡å—ä¾èµ–å…³ç³» ã€‚</li><li>æå– é€šç”¨ä»£ç  ã€‚</li><li>é¿å… ç»å¯¹è·¯å¾„ ã€‚</li><li>ä½¿ç”¨ <code>peer dependencies</code>ã€‚</li></ul><h3><span id="æ­¥éª¤1åˆ›å»ºé¡¹ç›®ç›®å½•å’Œæ–‡ä»¶">æ­¥éª¤1ï¼šåˆ›å»ºé¡¹ç›®ç›®å½•å’Œæ–‡ä»¶</span></h3><p>é¦–å…ˆï¼Œåœ¨ä¸€ä¸ªwebpacké¡¹ç›®ç›®å½•ä¸­çš„æ–‡ä»¶å¤¹ä¸­åˆ›å»ºä»¥ä¸‹æ–‡ä»¶ï¼š</p><ul><li><code>src/loader/custom-loader.js</code>ï¼šè‡ªå®šä¹‰Loaderçš„æºæ–‡ä»¶ã€‚</li><li><code>src/index.js</code>ï¼šJavaScriptå…¥å£æ–‡ä»¶ï¼Œç”¨äºæµ‹è¯•è‡ªå®šä¹‰Loaderã€‚</li></ul><h3><span id="æ­¥éª¤2ç¼–å†™è‡ªå®šä¹‰loader">æ­¥éª¤2ï¼šç¼–å†™è‡ªå®šä¹‰Loader</span></h3><p>åœ¨ <code>custom-loader.js</code> æ–‡ä»¶ä¸­ï¼Œç¼–å†™ä½ çš„è‡ªå®šä¹‰loaderä»£ç ã€‚è¿™ä¸ªLoaderçš„ä½œç”¨æ˜¯å°†åœ¨æ¯ä¸ªåŠ è½½çš„JavaScriptæ–‡ä»¶çš„é¡¶éƒ¨æ·»åŠ ä¸€ä¸ªæ³¨é‡Šã€‚</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// src/loader/custom-loader.js</span>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// åœ¨æºä»£ç çš„é¡¶éƒ¨æ·»åŠ è‡ªå®šä¹‰æ³¨é‡Š</span>    <span class="token keyword">const</span> updatedSource <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/** Custom Comment added by Custom Loader */\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>source<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>    <span class="token keyword">return</span> updatedSource<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3><span id="æ­¥éª¤3é…ç½®webpack">æ­¥éª¤3ï¼šé…ç½®Webpack</span></h3><p>åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹åˆ›å»ºWebpacké…ç½®æ–‡ä»¶ <code>webpack.config.js</code>ã€‚åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œä½¿ç”¨åˆšåˆšç¼–å†™çš„è‡ªå®šä¹‰Loaderã€‚</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// webpack.config.js</span><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token literal-property property">entry</span><span class="token operator">:</span> <span class="token string">'./src/index.js'</span><span class="token punctuation">,</span>    <span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>        <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token string">'bundle.js'</span><span class="token punctuation">,</span>        <span class="token literal-property property">path</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token literal-property property">module</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>        <span class="token literal-property property">rules</span><span class="token operator">:</span> <span class="token punctuation">[</span>            <span class="token punctuation">&#123;</span>                <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>                <span class="token literal-property property">use</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'custom-loader'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// ä½¿ç”¨è‡ªå®šä¹‰Loaderå¤„ç†.jsæ–‡ä»¶</span>                <span class="token literal-property property">exclude</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">node_modules</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>        <span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åŠŸèƒ½å°±ç®€å•çš„è¿›è¡Œäº†ä¸€ä¸‹å®ç°ï¼Œè¿™é‡Œæˆ‘ä»¬ä¸»è¦è¯´ä¸€ä¸‹å¦‚ä½•æµ‹è¯•è°ƒç”¨æˆ‘ä»¬çš„æœ¬åœ°çš„ loaderï¼Œæ–¹å¼æœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯é€šè¿‡ <code>Npm link</code> çš„æ–¹å¼è¿›è¡Œæµ‹è¯•ï¼Œè¿™è¾¹è´´ä¸€ä¸ª<code>Npm link</code>çš„é“¾æ¥ï¼Œå¤§å®¶å¯ä»¥å»åˆ›å»ºä¸€ä¸ªè½¯è¿æ¥è¿›è¡Œæœ¬åœ°æµ‹è¯•ï¼Œè¿˜æ˜¯æŒºæ–¹ä¾¿çš„<a href="https://docs.npmjs.com/cli/v6/commands/npm-link">npm-link</a>ã€‚ å¦å¤–ä¸€ç§å°±æ˜¯ç›´æ¥åœ¨é¡¹ç›®é‡Œé¢è¿›è¡Œè·¯å¾„é…ç½®ï¼š</p><h4><span id="å•loaderé…ç½®æ–¹æ³•">å•loaderé…ç½®æ–¹æ³•</span></h4><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">//webpack.config.js</span><span class="token punctuation">&#123;</span>  <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.js$</span><span class="token regex-delimiter">/</span></span>  <span class="token literal-property property">use</span><span class="token operator">:</span> <span class="token punctuation">[</span>    <span class="token punctuation">&#123;</span>      <span class="token literal-property property">loader</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'path/to/custom-loader.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>      <span class="token literal-property property">options</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token comment">/* ... */</span><span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4><span id="å¤šloaderé…ç½®æ–¹æ³•">å¤šloaderé…ç½®æ–¹æ³•</span></h4><p>å½“ç„¶ä¹Ÿå¯ä»¥é€šè¿‡æ•°ç»„çš„æ–¹å¼è¿›è¡Œé…ç½®</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">//webpack.config.js</span><span class="token literal-property property">resolveLoader</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// è¿™é‡Œå°±æ˜¯è¯´å…ˆå»æ‰¾ node_modules ç›®å½•ä¸­ï¼Œå¦‚æœæ²¡æœ‰çš„è¯å†å» loaders ç›®å½•æŸ¥æ‰¾</span>  <span class="token literal-property property">modules</span><span class="token operator">:</span> <span class="token punctuation">[</span>    <span class="token string">'node_modules'</span><span class="token punctuation">,</span>    path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'custom-loader'</span><span class="token punctuation">)</span>  <span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3><span id="æ­¥éª¤4æµ‹è¯•è‡ªå®šä¹‰loader">æ­¥éª¤4ï¼šæµ‹è¯•è‡ªå®šä¹‰Loader</span></h3><p>åœ¨ <code>index.js</code> æ–‡ä»¶ä¸­ï¼Œç¼–å†™ä¸€äº›JavaScriptä»£ç ï¼Œä¾‹å¦‚ï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// src/index.js</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Hello, Webpack Loader!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3><span id="æ­¥éª¤5è¿è¡Œwebpackæ„å»º">æ­¥éª¤5ï¼šè¿è¡ŒWebpackæ„å»º</span></h3><p>è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥æ„å»ºä½ çš„é¡¹ç›®ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">npx webpack <span class="token parameter variable">--config</span> webpack.config.js<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æ„å»ºå®Œæˆåï¼Œä½ å°†åœ¨ <code>dist</code> æ–‡ä»¶å¤¹ä¸­æ‰¾åˆ°ç”Ÿæˆçš„ <code>bundle.js</code> æ–‡ä»¶ã€‚åœ¨è¿™ä¸ªæ–‡ä»¶é‡Œé¢å¯ä»¥çœ‹åˆ°åœ¨é¡¶éƒ¨æ·»åŠ äº†è‡ªå®šä¹‰æ³¨é‡Šçš„JavaScriptä»£ç ã€‚</p><hr><h2><span id="webpack-pluginçš„ç®€å•ä½¿ç”¨">Webpack pluginçš„ç®€å•ä½¿ç”¨</span></h2><p>æ’ä»¶å‘ç¬¬ä¸‰æ–¹å¼€å‘è€…æä¾›äº† webpack å¼•æ“ä¸­å®Œæ•´çš„èƒ½åŠ›ã€‚ä½¿ç”¨é˜¶æ®µå¼çš„æ„å»ºå›è°ƒï¼Œå¼€å‘è€…å¯ä»¥åœ¨ webpack æ„å»ºæµç¨‹ä¸­å¼•å…¥è‡ªå®šä¹‰çš„è¡Œä¸ºã€‚</p><p>æ¯”å¦‚è¯´æœ€ç®€å•çš„ä¸€ä¸ªä¾‹å­ï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// webpack.config.js</span><span class="token keyword">const</span> HtmlWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'html-webpack-plugin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token literal-property property">entry</span><span class="token operator">:</span> <span class="token string">'./src/index.js'</span><span class="token punctuation">,</span>    <span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>        <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token string">'bundle.js'</span><span class="token punctuation">,</span>        <span class="token literal-property property">path</span><span class="token operator">:</span> __dirname <span class="token operator">+</span> <span class="token string">'/dist'</span><span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>        <span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>            <span class="token literal-property property">template</span><span class="token operator">:</span> <span class="token string">'./src/index.html'</span><span class="token punctuation">,</span> <span class="token comment">// æŒ‡å®šHTMLæ¨¡æ¿æ–‡ä»¶</span>            <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token string">'index.html'</span><span class="token punctuation">,</span> <span class="token comment">// ç”Ÿæˆçš„HTMLæ–‡ä»¶å</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token comment">// å¯ä»¥æ·»åŠ æ›´å¤šçš„æ’ä»¶</span>    <span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨ä¸Šé¢è¿™ä¸ªä¾‹å­é‡Œé¢ä½¿ç”¨äº†HtmlWebpackPluginæ’ä»¶ï¼Œæ ¹æ®æŒ‡å®šçš„HTMLæ¨¡æ¿ç”Ÿæˆä¸€ä¸ªæ–°çš„HTMLæ–‡ä»¶ï¼Œå¹¶å°†æ‰“åŒ…åçš„JavaScriptæ–‡ä»¶è‡ªåŠ¨æ·»åŠ åˆ°ç”Ÿæˆçš„HTMLæ–‡ä»¶ä¸­ã€‚</p><p>ä¸€ä¸ªåŸºæœ¬çš„webpack æ’ä»¶ç”±ä»¥ä¸‹ç»„æˆï¼š</p><ul><li><p>ä¸€ä¸ª JavaScript å‘½åå‡½æ•°æˆ– JavaScript ç±»ã€‚</p></li><li><p>åœ¨æ’ä»¶å‡½æ•°çš„ prototype ä¸Šå®šä¹‰ä¸€ä¸ª apply æ–¹æ³•ï¼Œapply æ–¹æ³•åœ¨ webpack è£…è½½è¿™ä¸ªæ’ä»¶çš„æ—¶å€™è¢«è°ƒç”¨ï¼Œå¹¶ä¸”ä¼šä¼ å…¥ compiler å¯¹è±¡ã€‚ã€‚</p></li><li><p>æŒ‡å®šä¸€ä¸ªç»‘å®šåˆ° webpack è‡ªèº«çš„äº‹ä»¶é’©å­ã€‚</p></li><li><p>å¤„ç† webpack å†…éƒ¨å®ä¾‹çš„ç‰¹å®šæ•°æ®ã€‚</p></li><li><p>åŠŸèƒ½å®Œæˆåè°ƒç”¨ webpack æä¾›çš„å›è°ƒã€‚</p></li></ul><p>ä¸€ä¸ªæ’ä»¶ç»“æ„å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">HelloWorldPlugin</span> <span class="token punctuation">&#123;</span>  <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>done<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span>      <span class="token string">'Hello World Plugin'</span><span class="token punctuation">,</span>      <span class="token punctuation">(</span>        stats <span class="token comment">/* ç»‘å®š done é’©å­åï¼Œstats ä¼šä½œä¸ºå‚æ•°ä¼ å…¥ã€‚ */</span>      <span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Hello World!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> HelloWorldPlugin<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2><span id="compiler-and-compilation">Compiler and Compilation</span></h2><p>åœ¨æ’ä»¶å¼€å‘ä¸­æœ€é‡è¦çš„ä¸¤ä¸ªèµ„æºå°±æ˜¯ compiler å’Œ compilation å¯¹è±¡ã€‚å¯ä»¥è¯´Webpack pluginçš„å¼€å‘å°±æ˜¯å›´ç»•ç€è¿™ä¸¤ä¸ªå¯¹è±¡çš„ hook è¿›è¡Œæ“ä½œ</p><p><code>compiler</code> å¯¹è±¡å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªå’Œ webpack ç¯å¢ƒæ•´ä½“ç»‘å®šçš„ä¸€ä¸ªå¯¹è±¡ï¼Œå®ƒåŒ…å«äº†æ‰€æœ‰çš„ç¯å¢ƒé…ç½®ï¼ŒåŒ…æ‹¬ optionsï¼Œloader å’Œ pluginï¼Œå½“ webpack å¯åŠ¨æ—¶ï¼Œè¿™ä¸ªå¯¹è±¡ä¼šè¢«å®ä¾‹åŒ–ï¼Œå¹¶ä¸”ä»–æ˜¯<code>å…¨å±€å”¯ä¸€</code>çš„ï¼Œä¸Šé¢æˆ‘ä»¬è¯´åˆ°çš„ apply æ–¹æ³•ä¼ å…¥çš„å‚æ•°å°±æ˜¯å®ƒã€‚</p><p><code>compilation</code> åœ¨æ¯æ¬¡æ„å»ºèµ„æºçš„è¿‡ç¨‹ä¸­éƒ½ä¼šè¢«åˆ›å»ºå‡ºæ¥ï¼Œä¸€ä¸ª compilation å¯¹è±¡è¡¨ç°äº†å½“å‰çš„æ¨¡å—èµ„æºã€ç¼–è¯‘ç”Ÿæˆèµ„æºã€å˜åŒ–çš„æ–‡ä»¶ã€ä»¥åŠè¢«è·Ÿè¸ªä¾èµ–çš„çŠ¶æ€ä¿¡æ¯ã€‚å®ƒåŒæ ·ä¹Ÿæä¾›äº†å¾ˆå¤šçš„ hook ã€‚</p><h2><span id="è‡ªå®šä¹‰webpack-plugin">è‡ªå®šä¹‰Webpack plugin</span></h2><h3><span id="æ­¥éª¤1åˆ›å»ºé¡¹ç›®ç›®å½•å’Œæ–‡ä»¶">æ­¥éª¤1ï¼šåˆ›å»ºé¡¹ç›®ç›®å½•å’Œæ–‡ä»¶</span></h3><p>é¦–å…ˆï¼Œè¿˜æ˜¯éœ€è¦ä¸€ä¸ªwebpacké¡¹ç›®ã€‚æˆ‘ä»¬åœ¨è¿™ä¸ªæ–‡ä»¶å¤¹ä¸­åˆ›å»ºä»¥ä¸‹æ–‡ä»¶ï¼š</p><ul><li><code>src/plugins/CustomPlugin.js</code>ï¼šè‡ªå®šä¹‰æ’ä»¶çš„æºæ–‡ä»¶ã€‚</li></ul><h3><span id="æ­¥éª¤2ç¼–å†™è‡ªå®šä¹‰æ’ä»¶">æ­¥éª¤2ï¼šç¼–å†™è‡ªå®šä¹‰æ’ä»¶</span></h3><p>åœ¨ <code>CustomPlugin.js</code> æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬ç¼–å†™äº†ä¸€ä¸ªæ’ä»¶ï¼Œå¹¶å°†åœ¨Webpackæ„å»ºç»“æŸæ—¶è¾“å‡ºä¸€æ¡ä¿¡æ¯ã€‚</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// src/plugins/CustomPlugin.js</span><span class="token keyword">class</span> <span class="token class-name">CustomPlugin</span> <span class="token punctuation">&#123;</span>    <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>done<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'CustomPlugin'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'CustomPlugin: Webpack build process is done!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> CustomPlugin<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3><span id="æ­¥éª¤3é…ç½®webpack">æ­¥éª¤3ï¼šé…ç½®Webpack</span></h3><p>åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œä½¿ç”¨ä¸Šé¢æˆ‘ä»¬çš„è‡ªå®šä¹‰æ’ä»¶ã€‚</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// webpack.config.js</span><span class="token keyword">const</span> CustomPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./src/plugins/CustomPlugin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token literal-property property">entry</span><span class="token operator">:</span> <span class="token string">'./src/index.js'</span><span class="token punctuation">,</span>    <span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>        <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token string">'bundle.js'</span><span class="token punctuation">,</span>        <span class="token literal-property property">path</span><span class="token operator">:</span> __dirname <span class="token operator">+</span> <span class="token string">'/dist'</span><span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>        <span class="token keyword">new</span> <span class="token class-name">CustomPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token comment">// å¯ä»¥æ·»åŠ æ›´å¤šçš„æ’ä»¶</span>    <span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3><span id="æ­¥éª¤4è¿è¡Œwebpackæ„å»º">æ­¥éª¤4ï¼šè¿è¡ŒWebpackæ„å»º</span></h3><p>ç°åœ¨è¿›è¡ŒWebpackæ„å»ºï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">npx webpack <span class="token parameter variable">--config</span> webpack.config.js<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>]]></content>
    
    
      
      
    <summary type="html">&lt;h2&gt;&lt;span id=&quot;å¼•è¨€&quot;&gt;å¼•è¨€&lt;/span&gt;&lt;/h2&gt;
&lt;p&gt;loader æ˜¯å¯¼å‡ºä¸ºä¸€ä¸ªå‡½æ•°çš„ node æ¨¡å—ã€‚è¯¥å‡½æ•°åœ¨ loader è½¬æ¢èµ„æºçš„æ—¶å€™è°ƒç”¨ã€‚ç»™å®šçš„å‡½æ•°å°†è°ƒç”¨ &lt;code&gt;Loader API&lt;/code&gt;ï¼Œå¹¶é€šè¿‡ this ä¸Šä¸‹æ–‡è®¿é—®ã€‚&lt;/p&gt;
&lt;p&gt;è¿™</summary>
      
    
    
    
    <category term="Webpack" scheme="https://ikkkp.github.io/categories/Webpack/"/>
    
    
    <category term="Webpack,Front-end" scheme="https://ikkkp.github.io/tags/Webpack-Front-end/"/>
    
  </entry>
  
  <entry>
    <title>Webpack Custom Loader/Plugin</title>
    <link href="https://ikkkp.github.io/2023/10/29/en/webpack-plugin-design/"/>
    <id>https://ikkkp.github.io/2023/10/29/en/webpack-plugin-design/</id>
    <published>2023-10-29T06:50:05.000Z</published>
    <updated>2023-11-04T02:30:52.478Z</updated>
    
    <content type="html"><![CDATA[<h2><span id="introduction">Introduction</span></h2><p>A loader is a node module exported as a function. This function is called when transforming resources in the loader. The given function will utilize the <code>Loader API</code> and can be accessed through the <code>this</code> context.</p><p>Here is an official link on <a href="https://webpack.docschina.org/contribute/writing-a-loader">loader usage and examples, including local development and testing of custom loaders</a>.</p><h2><span id="simple-usage-of-webpack-loader">Simple Usage of Webpack Loader</span></h2><p>When a loader is used in a resource, it can only take one parameter - a string containing the content of the resource file.</p><p>Synchronous loaders can return a single value representing the transformed module.</p><p>Loaders can return one or two values. The first value is a string or buffer containing JavaScript code. The optional second value is a SourceMap, which is a JavaScript object.</p><p>Hereâ€™s a simple example of using a loader. It matches all JavaScript files and processes them using <code>loader.js</code>:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// webpack.config.js</span><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token comment">//...</span>  <span class="token literal-property property">module</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>    <span class="token literal-property property">rules</span><span class="token operator">:</span> <span class="token punctuation">[</span>      <span class="token punctuation">&#123;</span>        <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>        <span class="token literal-property property">use</span><span class="token operator">:</span> <span class="token punctuation">[</span>          <span class="token punctuation">&#123;</span>            <span class="token literal-property property">loader</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'path/to/loader.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token literal-property property">options</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>              <span class="token comment">/* ... */</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>          <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>        <span class="token punctuation">]</span><span class="token punctuation">,</span>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>From the above, we can understand how loaders are used. But this only scratches the surface. What does a specific loader look like?</p><p>For example, a simple loader could be like this:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">content</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// content is the source content string passed in</span>  <span class="token keyword">return</span> content<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>A loader is just a node module exposing a function that can only receive one parameter: a string containing the content of the resource file. The functionâ€™s return value is the processed content.</p><h2><span id="creating-a-custom-webpack-loader">Creating a Custom Webpack Loader</span></h2><h3><span id="guidelines-for-using-custom-loaders">Guidelines for Using Custom Loaders</span></h3><p>When writing loaders, you should follow these guidelines. They are listed in order of importance, and some apply only to specific scenarios. Please read the detailed sections below for more information.</p><ul><li>Keep it <strong>simple</strong>.</li><li>Use <strong>chaining</strong>.</li><li>Output should be <strong>modular</strong>.</li><li>Ensure itâ€™s <strong>stateless</strong>.</li><li>Use <strong>loader utilities</strong>.</li><li>Record <strong>loader dependencies</strong>.</li><li>Resolve <strong>module dependencies</strong>.</li><li>Extract <strong>common code</strong>.</li><li>Avoid <strong>absolute paths</strong>.</li><li>Use <strong>peer dependencies</strong>.</li></ul><h3><span id="step-1-create-project-directory-and-files">Step 1: Create Project Directory and Files</span></h3><p>First, create the following files in a folder within your webpack project directory:</p><ul><li><code>src/loader/custom-loader.js</code>: The source file for your custom loader.</li><li><code>src/index.js</code>: JavaScript entry file for testing the custom loader.</li></ul><h3><span id="step-2-write-the-custom-loader">Step 2: Write the Custom Loader</span></h3><p>In the <code>custom-loader.js</code> file, write your custom loader code. This loader adds a comment at the top of each loaded JavaScript file.</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// src/loader/custom-loader.js</span>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// Add a custom comment at the top of the source code</span>    <span class="token keyword">const</span> updatedSource <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/** Custom Comment added by Custom Loader */\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>source<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>    <span class="token keyword">return</span> updatedSource<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3><span id="step-3-configure-webpack">Step 3: Configure Webpack</span></h3><p>Create a Webpack configuration file <code>webpack.config.js</code> in the project root directory. Use the custom loader you just created in the configuration file.</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// webpack.config.js</span><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token literal-property property">entry</span><span class="token operator">:</span> <span class="token string">'./src/index.js'</span><span class="token punctuation">,</span>    <span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>        <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token string">'bundle.js'</span><span class="token punctuation">,</span>        <span class="token literal-property property">path</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token literal-property property">module</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>        <span class="token literal-property property">rules</span><span class="token operator">:</span> <span class="token punctuation">[</span>            <span class="token punctuation">&#123;</span>                <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>                <span class="token literal-property property">use</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'custom-loader'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// Use the custom loader to process .js files</span>                <span class="token literal-property property">exclude</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">node_modules</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>        <span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>This configuration achieves a simple functionality. Now letâ€™s discuss how to test the local loader. There are two ways to do this: one is through <code>Npm link</code> for testing, a convenient method where you can create a symbolic link for local testing. Here is a link to <a href="https://docs.npmjs.com/cli/v6/commands/npm-link">npm-link</a>. Another way is to configure the path directly in the project:</p><h4><span id="single-loader-configuration">Single Loader Configuration</span></h4><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// webpack.config.js</span><span class="token punctuation">&#123;</span>  <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.js$</span><span class="token regex-delimiter">/</span></span>  <span class="token literal-property property">use</span><span class="token operator">:</span> <span class="token punctuation">[</span>    <span class="token punctuation">&#123;</span>      <span class="token literal-property property">loader</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'path/to/custom-loader.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>      <span class="token literal-property property">options</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token comment">/* ... */</span><span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4><span id="multiple-loader-configuration">Multiple Loader Configuration</span></h4><p>You can also configure it using an array:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// webpack.config.js</span><span class="token literal-property property">resolveLoader</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// Look for loaders first in the node_modules directory; if not found, search in the loaders directory</span>  <span class="token literal-property property">modules</span><span class="token operator">:</span> <span class="token punctuation">[</span>    <span class="token string">'node_modules'</span><span class="token punctuation">,</span>    path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'custom-loader'</span><span class="token punctuation">)</span>  <span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3><span id="step-4-test-the-custom-loader">Step 4: Test the Custom Loader</span></h3><p>In the <code>index.js</code> file, write some JavaScript code, for example:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// src/index.js</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Hello, Webpack Loader!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3><span id="step-5-run-webpack-build">Step 5: Run Webpack Build</span></h3><p>Run the following command to build your project:</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">npx webpack <span class="token parameter variable">--config</span> webpack.config.js<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>After the build is complete, you will find the generated <code>bundle.js</code> file in the <code>dist</code> folder. In this file, you can see JavaScript code with a custom comment added at the top.</p><pre class="line-numbers language-none"><code class="language-none">## Simple Usage of Webpack PluginPlugins provide complete control over the webpack engine for third-party developers. By introducing custom behaviors into the webpack build process through stage-based build callbacks, developers can customize webpack&#39;s behavior.Here&#39;s the simplest example:&#96;&#96;&#96;javascript&#x2F;&#x2F; webpack.config.jsconst HtmlWebpackPlugin &#x3D; require(&#39;html-webpack-plugin&#39;);module.exports &#x3D; &#123;    entry: &#39;.&#x2F;src&#x2F;index.js&#39;,    output: &#123;        filename: &#39;bundle.js&#39;,        path: __dirname + &#39;&#x2F;dist&#39;,    &#125;,    plugins: [        new HtmlWebpackPlugin(&#123;            template: &#39;.&#x2F;src&#x2F;index.html&#39;, &#x2F;&#x2F; Specify the HTML template file            filename: &#39;index.html&#39;, &#x2F;&#x2F; Generated HTML file name        &#125;),        &#x2F;&#x2F; You can add more plugins here    ],&#125;;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>In this example, the <code>HtmlWebpackPlugin</code> is used. It generates a new HTML file based on the specified HTML template and automatically adds the bundled JavaScript file to the generated HTML file.</p><p>A basic webpack plugin consists of the following components:</p><ul><li><p>A JavaScript named function or JavaScript class.</p></li><li><p>Define an <code>apply</code> method on the plugin functionâ€™s prototype. The <code>apply</code> method is called when webpack loads the plugin and is passed the <code>compiler</code> object.</p></li><li><p>Specify an event hook bound to webpack itself.</p></li><li><p>Process specific data from webpackâ€™s internal instances.</p></li><li><p>Call the callback provided by webpack after the functionality is completed.</p></li></ul><p>A plugin structure looks like this:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">HelloWorldPlugin</span> <span class="token punctuation">&#123;</span>  <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>done<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span>      <span class="token string">'Hello World Plugin'</span><span class="token punctuation">,</span>      <span class="token punctuation">(</span>        stats <span class="token comment">/* After binding the done hook, stats is passed as a parameter. */</span>      <span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Hello World!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> HelloWorldPlugin<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2><span id="compiler-and-compilation">Compiler and Compilation</span></h2><p>The two most important resources in plugin development are the <code>compiler</code> and <code>compilation</code> objects. Plugin development revolves around hooks on these objects.</p><p>The <code>compiler</code> object is essentially bound to the entire webpack environment. It contains all the environment configurations, including options, loaders, and plugins. When webpack starts, this object is instantiated and it is <code>globally unique</code>. The parameters passed into the <code>apply</code> method are properties of this object.</p><p>The <code>compilation</code> object is created each time resources are built. It represents the current module resources, compiled generated resources, changed files, and tracked dependency status. It also provides many hooks.</p><h2><span id="creating-a-custom-webpack-plugin">Creating a Custom Webpack Plugin</span></h2><h3><span id="step-1-create-project-directory-and-files">Step 1: Create Project Directory and Files</span></h3><p>First, create the following file in a folder within your webpack project directory:</p><ul><li><code>src/plugins/CustomPlugin.js</code>: Source file for your custom plugin.</li></ul><h3><span id="step-2-write-the-custom-plugin">Step 2: Write the Custom Plugin</span></h3><p>In the <code>CustomPlugin.js</code> file, write a plugin that outputs a message when the webpack build process is completed.</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// src/plugins/CustomPlugin.js</span><span class="token keyword">class</span> <span class="token class-name">CustomPlugin</span> <span class="token punctuation">&#123;</span>    <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>done<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'CustomPlugin'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'CustomPlugin: Webpack build process is done!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> CustomPlugin<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3><span id="step-3-configure-webpack">Step 3: Configure Webpack</span></h3><p>In the configuration file, use the custom plugin you just created.</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// webpack.config.js</span><span class="token keyword">const</span> CustomPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./src/plugins/CustomPlugin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token literal-property property">entry</span><span class="token operator">:</span> <span class="token string">'./src/index.js'</span><span class="token punctuation">,</span>    <span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>        <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token string">'bundle.js'</span><span class="token punctuation">,</span>        <span class="token literal-property property">path</span><span class="token operator">:</span> __dirname <span class="token operator">+</span> <span class="token string">'/dist'</span><span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>        <span class="token keyword">new</span> <span class="token class-name">CustomPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token comment">// You can add more plugins here</span>    <span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3><span id="step-4-run-webpack-build">Step 4: Run Webpack Build</span></h3><p>Now, run the webpack build:</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">npx webpack <span class="token parameter variable">--config</span> webpack.config.js<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><hr><p><em>Note: This article is a translated version of the original post. For the most accurate and up-to-date information, please refer to the original source.</em></p><pre><code></code></pre>]]></content>
    
    
      
      
    <summary type="html">&lt;h2&gt;&lt;span id=&quot;introduction&quot;&gt;Introduction&lt;/span&gt;&lt;/h2&gt;
&lt;p&gt;A loader is a node module exported as a function. This function is called when trans</summary>
      
    
    
    
    <category term="Webpack" scheme="https://ikkkp.github.io/categories/Webpack/"/>
    
    
    <category term="Webpack,Front-end" scheme="https://ikkkp.github.io/tags/Webpack-Front-end/"/>
    
  </entry>
  
  <entry>
    <title>301/302-é‡å®šå‘</title>
    <link href="https://ikkkp.github.io/2023/10/28/301-302-Redirection/"/>
    <id>https://ikkkp.github.io/2023/10/28/301-302-Redirection/</id>
    <published>2023-10-28T08:18:48.000Z</published>
    <updated>2023-10-28T08:28:47.562Z</updated>
    
    <content type="html"><![CDATA[<h2><span id="å‰è¨€">å‰è¨€</span></h2><p>å½“ä½ åœ¨ç½‘ç«™ä¸Šè¿›è¡Œé‡å®šå‘è®¾ç½®æ—¶ï¼Œç‰¹åˆ«æ˜¯åœ¨ä»¥ä¸‹ä¸¤ç§æƒ…å†µä¸‹ï¼Œå¯èƒ½ä¼šé‡åˆ°é—®é¢˜ï¼š</p><p>ä»HTTPåˆ°HTTPSçš„é‡å®šå‘ï¼š å‡è®¾ä½ é…ç½®äº†SSLè¯ä¹¦ï¼Œå°†ç½‘ç«™ä»HTTPå‡çº§åˆ°HTTPSã€‚</p><p>å¦‚æœåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­å‡ºç°äº†é—®é¢˜ï¼Œå¯¼è‡´ç½‘ç«™æ— æ³•æ­£å¸¸è®¿é—®ï¼Œä½ å¯èƒ½ä¼šæƒ³æ’¤é”€é‡å®šå‘ï¼Œå›åˆ°HTTPç‰ˆæœ¬ã€‚ç„¶è€Œï¼Œé—®é¢˜åœ¨äºï¼Œä¸€æ—¦ä½ ä½¿ç”¨äº†301æ°¸ä¹…æ€§é‡å®šå‘ï¼Œæµè§ˆå™¨ä¼šæŠŠè¿™ä¸ªé‡å®šå‘ä¿¡æ¯ä¿å­˜ä¸‹æ¥ã€‚å³ä½¿ä½ åœ¨æœåŠ¡å™¨ä¸Šå–æ¶ˆäº†é‡å®šå‘ï¼Œç”¨æˆ·çš„æµè§ˆå™¨ä¾ç„¶ä¼šå¼ºåˆ¶å°†ä»–ä»¬é‡å®šå‘åˆ°HTTPSç‰ˆæœ¬ï¼Œæ— æ³•å†è®¿é—®HTTPç‰ˆæœ¬ã€‚</p><p>æ›´æ”¹ç½‘ç«™åŸŸåçš„é‡å®šå‘ï¼š å½“ä½ å°†ç½‘ç«™ä»ä¸€ä¸ªåŸŸåï¼ˆæ¯”å¦‚<code>old-domain.com</code>ï¼‰è¿ç§»åˆ°å¦ä¸€ä¸ªåŸŸåï¼ˆæ¯”å¦‚<code>new-domain.com</code>ï¼‰ï¼Œä½ å¯èƒ½ä¼šä½¿ç”¨301æ°¸ä¹…æ€§é‡å®šå‘ï¼Œä»¥ä¾¿æœç´¢å¼•æ“å’Œæµè§ˆå™¨çŸ¥é“ç½‘ç«™å·²ç»æ°¸ä¹…åœ°ç§»åŠ¨åˆ°äº†æ–°çš„åŸŸåã€‚</p><p>ä½†å¦‚æœåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­å‡ºç°äº†é—®é¢˜ï¼Œä½ å¯èƒ½å¸Œæœ›æ’¤é”€é‡å®šå‘ï¼Œä½¿ç”¨æˆ·èƒ½å¤Ÿå†æ¬¡è®¿é—®æ—§åŸŸåã€‚ç„¶è€Œï¼Œç”±äº301é‡å®šå‘è¢«æµè§ˆå™¨ç¡¬ç¼“å­˜ï¼Œç”¨æˆ·å°†è¢«æ°¸ä¹…æ€§åœ°é‡å®šå‘åˆ°æ–°åŸŸåï¼Œæ— æ³•å†è®¿é—®æ—§åŸŸåã€‚</p><p>ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œå»ºè®®åœ¨æµ‹è¯•ç¡®ä¿ä¸€åˆ‡æ­£å¸¸åï¼Œä¸€å¼€å§‹ä½¿ç”¨302ä¸´æ—¶æ€§é‡å®šå‘ï¼Œè€Œä¸æ˜¯301æ°¸ä¹…æ€§é‡å®šå‘ã€‚302é‡å®šå‘ä¸ä¼šè¢«æµè§ˆå™¨æ°¸ä¹…æ€§åœ°ç¼“å­˜ï¼Œè¿™æ„å‘³ç€å¦‚æœéœ€è¦ï¼Œä½ å¯ä»¥éšæ—¶æ’¤é”€é‡å®šå‘ï¼Œè€Œç”¨æˆ·ä¸ä¼šè¢«æ°¸ä¹…æ€§åœ°é”å®šåœ¨æ–°çš„ç½‘å€ä¸Šã€‚è¿™æ ·å¯ä»¥é¿å…ç”¨æˆ·éœ€è¦æ‰‹åŠ¨æ¸…é™¤æµè§ˆå™¨ç¼“å­˜çš„ç¹çæ­¥éª¤ï¼Œæä¾›æ›´å¥½çš„ç”¨æˆ·ä½“éªŒã€‚</p><ul><li><p>301é‡å®šå‘ï¼šæ„å‘³ç€èµ„æºï¼ˆé¡µé¢ï¼‰è¢«æ°¸ä¹…æ€§åœ°ç§»åŠ¨åˆ°äº†ä¸€ä¸ªæ–°çš„ä½ç½®ã€‚å®¢æˆ·ç«¯/æµè§ˆå™¨ä¸åº”å†å°è¯•è¯·æ±‚åŸå§‹ä½ç½®ï¼Œè€Œåº”è¯¥ä»ç°åœ¨å¼€å§‹ä½¿ç”¨æ–°çš„ä½ç½®ã€‚</p></li><li><p>302é‡å®šå‘ï¼šæ„å‘³ç€èµ„æºæš‚æ—¶ä½äºå…¶ä»–åœ°æ–¹ï¼Œå®¢æˆ·ç«¯/æµè§ˆå™¨åº”ç»§ç»­è¯·æ±‚åŸå§‹URLã€‚</p></li></ul><p>301æ˜¯æ°¸ä¹…æ€§é‡å®šå‘ã€‚å³ä½¿ä½ ä»æœåŠ¡å™¨ç§»é™¤äº†é‡å®šå‘ï¼Œä½ çš„æµè§ˆå™¨ä»ç„¶ä¼šå°†èµ„æºæ°¸ä¹…æ€§åœ°é‡å®šå‘åˆ°æ–°çš„åŸŸåæˆ–HTTPSï¼Œå› ä¸ºå®ƒä»¬è¢«ç¡¬ç¼“å­˜ã€‚</p><p>æ‰€ä»¥ï¼Œ302ä¸ä¼šè¢«æµè§ˆå™¨ç¡¬ç¼“å­˜ï¼Œå¦‚æœä½ ä»æœåŠ¡å™¨ï¼ˆç½‘ç«™ï¼‰ç§»é™¤äº†é‡å®šå‘ï¼Œä½ å°±èƒ½å¤Ÿè®¿é—®æ—§ç‰ˆæœ¬ã€‚</p><p>æ¸…é™¤301/302é‡å®šå‘ç¼“å­˜é€šå¸¸æ¶‰åŠæ¸…é™¤æµè§ˆå™¨ç¼“å­˜æˆ–è€…æ“ä½œç³»ç»Ÿçš„DNSç¼“å­˜ã€‚ä¸‹é¢æ˜¯å¦‚ä½•åœ¨ä¸åŒå¹³å°ä¸Šåšçš„è¯´æ˜ï¼š</p><h2><span id="æ¸…é™¤æµè§ˆå™¨ç¼“å­˜é€‚ç”¨äºwindows-macos-linux">æ¸…é™¤æµè§ˆå™¨ç¼“å­˜ï¼ˆé€‚ç”¨äºWindowsã€macOSã€Linuxï¼‰</span></h2><h3><span id="google-chrome">Google Chromeï¼š</span></h3><ol><li>æ‰“å¼€Chromeæµè§ˆå™¨ã€‚</li><li>ç‚¹å‡»å³ä¸Šè§’çš„ä¸‰ä¸ªå‚ç›´ç‚¹ï¼Œé€‰æ‹©â€œæ›´å¤šå·¥å…·â€ã€‚</li><li>é€‰æ‹©â€œæ¸…é™¤æµè§ˆæ•°æ®â€ã€‚</li><li>åœ¨å¼¹å‡ºçš„çª—å£ä¸­ï¼Œé€‰æ‹©â€œé«˜çº§â€é€‰é¡¹å¡ã€‚</li><li>é€‰æ‹©â€œæ‰€æœ‰æ—¶é—´â€ä½œä¸ºæ—¶é—´èŒƒå›´ã€‚</li><li>å‹¾é€‰â€œç¼“å­˜å›¾åƒå’Œæ–‡ä»¶â€é€‰é¡¹ã€‚</li><li>ç‚¹å‡»â€œæ¸…é™¤æ•°æ®â€æŒ‰é’®ã€‚</li></ol><h3><span id="mozilla-firefox">Mozilla Firefoxï¼š</span></h3><ol><li>æ‰“å¼€Firefoxæµè§ˆå™¨ã€‚</li><li>ç‚¹å‡»å³ä¸Šè§’çš„ä¸‰æ¡æ°´å¹³çº¿ï¼Œé€‰æ‹©â€œéšç§ä¸å®‰å…¨â€ã€‚</li><li>åœ¨â€œCookieå’Œç«™ç‚¹æ•°æ®â€éƒ¨åˆ†ï¼Œç‚¹å‡»â€œæ¸…é™¤æ•°æ®â€ã€‚</li><li>ç¡®ä¿å‹¾é€‰äº†â€œç¼“å­˜â€é€‰é¡¹ã€‚</li><li>ç‚¹å‡»â€œæ¸…é™¤â€ã€‚</li></ol><h3><span id="microsoft-edge">Microsoft Edgeï¼š</span></h3><ol><li>æ‰“å¼€Edgeæµè§ˆå™¨ã€‚</li><li>ç‚¹å‡»å³ä¸Šè§’çš„ä¸‰ä¸ªæ°´å¹³ç‚¹ï¼Œé€‰æ‹©â€œè®¾ç½®â€ã€‚</li><li>æ»šåŠ¨è‡³åº•éƒ¨ï¼Œç‚¹å‡»â€œæŸ¥çœ‹é«˜çº§è®¾ç½®â€ã€‚</li><li>åœ¨â€œéšç§ä¸æœåŠ¡â€éƒ¨åˆ†ï¼Œç‚¹å‡»â€œæ¸…é™¤æµè§ˆæ•°æ®â€ã€‚</li><li>å‹¾é€‰â€œç¼“å­˜å›¾åƒå’Œæ–‡ä»¶â€é€‰é¡¹ã€‚</li><li>ç‚¹å‡»â€œæ¸…é™¤â€æŒ‰é’®ã€‚</li></ol><h2><span id="æ¸…é™¤æ“ä½œç³»ç»Ÿçš„dnsç¼“å­˜é€‚ç”¨äºwindows-macos">æ¸…é™¤æ“ä½œç³»ç»Ÿçš„DNSç¼“å­˜ï¼ˆé€‚ç”¨äºWindowsã€macOSï¼‰</span></h2><h3><span id="windows">Windowsï¼š</span></h3><ol><li>æ‰“å¼€å‘½ä»¤æç¤ºç¬¦ï¼ˆåœ¨å¼€å§‹èœå•ä¸­æœç´¢â€œcmdâ€å¹¶æ‰“å¼€ï¼‰ã€‚</li><li>è¾“å…¥ä»¥ä¸‹å‘½ä»¤å¹¶æŒ‰ä¸‹å›è½¦é”®ï¼š<pre class="line-numbers language-none"><code class="language-none">ipconfig &#x2F;flushdns<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ol><h3><span id="macos">macOSï¼š</span></h3><ol><li>æ‰“å¼€ç»ˆç«¯ï¼ˆåœ¨åº”ç”¨ç¨‹åº &gt; å®ç”¨å·¥å…·æ–‡ä»¶å¤¹ä¸­æ‰¾åˆ°ï¼‰ã€‚</li><li>è¾“å…¥ä»¥ä¸‹å‘½ä»¤å¹¶æŒ‰ä¸‹å›è½¦é”®ï¼š<pre class="line-numbers language-none"><code class="language-none">sudo dscacheutil -flushcache<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>ç„¶åè¾“å…¥ç®¡ç†å‘˜å¯†ç å¹¶å†æ¬¡æŒ‰ä¸‹å›è½¦é”®ã€‚</li></ol><p>è¯·æ³¨æ„ï¼Œæ¸…é™¤æµè§ˆå™¨ç¼“å­˜å¯èƒ½ä¼šå¯¼è‡´æ‚¨åœ¨ç½‘ç«™ä¸Šçš„ç™»å½•çŠ¶æ€ä¸¢å¤±ï¼Œæ‰€ä»¥è¯·ç¡®ä¿æ‚¨å·²ç»å¤‡ä»½äº†é‡è¦çš„ä¿¡æ¯ï¼Œä»¥é˜²éœ€è¦é‡æ–°ç™»å½•ç½‘ç«™ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2&gt;&lt;span id=&quot;å‰è¨€&quot;&gt;å‰è¨€&lt;/span&gt;&lt;/h2&gt;
&lt;p&gt;å½“ä½ åœ¨ç½‘ç«™ä¸Šè¿›è¡Œé‡å®šå‘è®¾ç½®æ—¶ï¼Œç‰¹åˆ«æ˜¯åœ¨ä»¥ä¸‹ä¸¤ç§æƒ…å†µä¸‹ï¼Œå¯èƒ½ä¼šé‡åˆ°é—®é¢˜ï¼š&lt;/p&gt;
&lt;p&gt;ä»HTTPåˆ°HTTPSçš„é‡å®šå‘ï¼š å‡è®¾ä½ é…ç½®äº†SSLè¯ä¹¦ï¼Œå°†ç½‘ç«™ä»HTTPå‡çº§åˆ°HTTPSã€‚&lt;/p&gt;
&lt;p&gt;å¦‚æœåœ¨è¿™ä¸ªè¿‡ç¨‹</summary>
      
    
    
    
    <category term="http" scheme="https://ikkkp.github.io/categories/http/"/>
    
    
    <category term="http" scheme="https://ikkkp.github.io/tags/http/"/>
    
  </entry>
  
  <entry>
    <title>301/302 Redirection</title>
    <link href="https://ikkkp.github.io/2023/10/28/en/301-302-Redirection/"/>
    <id>https://ikkkp.github.io/2023/10/28/en/301-302-Redirection/</id>
    <published>2023-10-28T08:18:48.000Z</published>
    <updated>2023-11-03T14:08:44.689Z</updated>
    
    <content type="html"><![CDATA[<h2><span id="introduction">Introduction</span></h2><p>When configuring redirects on a website, especially in the following scenarios, issues can arise:</p><p><strong>Redirecting from HTTP to HTTPS:</strong> Suppose youâ€™ve set up an SSL certificate to upgrade your website from HTTP to HTTPS. If problems occur during this process, rendering the site inaccessible, you might consider reverting to the HTTP version. However, the challenge arises once a permanent 301 redirection is in place. Even if you remove the redirection on the server, browsers retain this information. Consequently, usersâ€™ browsers continue to enforce the HTTPS redirection, preventing them from accessing the HTTP version.</p><p><strong>Changing the Website Domain:</strong> When migrating a website from one domain (such as <code>old-domain.com</code>) to another (such as <code>new-domain.com</code>), a permanent 301 redirection is often employed. This informs search engines and browsers that the site has permanently moved to a new domain. However, if complications arise during this process, you may wish to undo the redirection, allowing users to access the old domain again. Unfortunately, due to browser hard caching of 301 redirections, users become permanently redirected to the new domain, unable to revisit the old one.</p><p>To avoid such situations, it is advisable to use a temporary 302 redirection initially, ensuring everything functions correctly. Unlike a 301 redirection, a 302 redirection is not permanently cached by browsers. This means that if necessary, you can revert the redirection without users being permanently locked into the new URL. This approach eliminates the need for users to manually clear their browser caches, enhancing the overall user experience.</p><ul><li><p><strong>301 Redirection:</strong> Indicates that a resource (page) has permanently moved to a new location. The client/browser should not attempt to request the original location but use the new location from now on.</p></li><li><p><strong>302 Redirection:</strong> Indicates that the resource is temporarily located elsewhere, and the client/browser should continue requesting the original URL.</p></li></ul><p>A 301 redirection is permanent, meaning that even if removed from the server, browsers will perpetually redirect resources to the new domain or HTTPS due to hard caching.</p><p>On the other hand, a 302 redirection is not hard-cached by browsers. If you remove the redirection from your server (website), you can still access the old version.</p><p>Clearing 301/302 redirection cache typically involves clearing browser cache or the operating systemâ€™s DNS cache. Hereâ€™s how to do it on different platforms:</p><h2><span id="clearing-browser-cache-applicable-to-windows-macos-linux">Clearing Browser Cache (Applicable to Windows, macOS, Linux)</span></h2><h3><span id="google-chrome">Google Chrome:</span></h3><ol><li>Open the Chrome browser.</li><li>Click the three vertical dots in the upper right corner and select â€œMore tools.â€</li><li>Choose â€œClear browsing data.â€</li><li>In the popup window, select the â€œAdvancedâ€ tab.</li><li>Set the time range to â€œAll time.â€</li><li>Check the â€œCached images and filesâ€ option.</li><li>Click the â€œClear dataâ€ button.</li></ol><h3><span id="mozilla-firefox">Mozilla Firefox:</span></h3><ol><li>Open the Firefox browser.</li><li>Click the three horizontal lines in the upper right corner and select â€œPrivacy &amp; Security.â€</li><li>In the â€œCookies and Site Dataâ€ section, click â€œClear Data.â€</li><li>Ensure the â€œCacheâ€ option is checked.</li><li>Click â€œClear.â€</li></ol><h3><span id="microsoft-edge">Microsoft Edge:</span></h3><ol><li>Open the Edge browser.</li><li>Click the three horizontal dots in the upper right corner and select â€œSettings.â€</li><li>Scroll down and click â€œView advanced settings.â€</li><li>In the â€œPrivacy and servicesâ€ section, click â€œClear browsing data.â€</li><li>Check the â€œCached images and filesâ€ option.</li><li>Click the â€œClearâ€ button.</li></ol><h2><span id="clearing-operating-systems-dns-cache-applicable-to-windows-macos">Clearing Operating Systemâ€™s DNS Cache (Applicable to Windows, macOS)</span></h2><h3><span id="windows">Windows:</span></h3><ol><li>Open Command Prompt (search for â€œcmdâ€ in the Start menu and open it).</li><li>Enter the following command and press Enter:<pre class="line-numbers language-none"><code class="language-none">ipconfig &#x2F;flushdns<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ol><h3><span id="macos">macOS:</span></h3><ol><li>Open Terminal (find it in Applications &gt; Utilities folder).</li><li>Enter the following command and press Enter:<pre class="line-numbers language-none"><code class="language-none">sudo dscacheutil -flushcache<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>Then enter your administrator password and press Enter again.</li></ol><p>Please note that clearing browser cache might lead to loss of login sessions on websites. Ensure you have backed up essential information in case you need to log in again.</p><hr><p><em>Note: This article is a translated version of the original post. For the most accurate and up-to-date information, please refer to the original source.</em></p><pre><code></code></pre>]]></content>
    
    
      
      
    <summary type="html">&lt;h2&gt;&lt;span id=&quot;introduction&quot;&gt;Introduction&lt;/span&gt;&lt;/h2&gt;
&lt;p&gt;When configuring redirects on a website, especially in the following scenarios, issu</summary>
      
    
    
    
    <category term="http" scheme="https://ikkkp.github.io/categories/http/"/>
    
    
    <category term="http" scheme="https://ikkkp.github.io/tags/http/"/>
    
  </entry>
  
</feed>
